<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸ƒAndæ„¿ - ç§å¯†èŠå¤©</title>
<style>
/* ä¸»é¢˜è‰²å˜é‡ */
:root {
  --bg-main: #bfbfbf;
  --bg-panel: rgba(229, 229, 229, 0.85);
  --msg-self: #dedede;
  --msg-other: #f2f2f2;
  --text: #5c5c5c;
  --accent: #8a7f8d;
  --accent-light: #a99cad;
  --accent-gray: #9e9e9e;
  --accent-gray-light: #bdbdbd;
  --online: #4caf50;
  --busy: #ff9800;
  --dr: #2196f3;
  --cr: #9c27b0;
  --nearby: #ff5722;
  --mood-happy: #ffcc00;
  --mood-normal: #4caf50;
  --mood-sad: #9c27b0;
  --mood-angry: #f44336;
  --quote-bg: rgba(138, 127, 141, 0.1);
  --call-bg: rgba(33, 150, 243, 0.1);
  --call-text: #2196f3;
  --video-bg: rgba(156, 39, 176, 0.1);
  --video-text: #9c27b0;
  --tarot-bg: rgba(156, 39, 176, 0.1);
  --tarot-text: #7b1fa2;
}

/* åŸºç¡€æ ·å¼ */
body {
  margin: 0;
  height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-main);
  background-image: radial-gradient(#ffffff55 2px, transparent 2px);
  background-size: 30px 30px;
  display: flex;
  justify-content: center;
  align-items: center;
  color: var(--text);
  overflow: hidden;
  transition: background 0.5s ease;
}

/* èƒŒæ™¯å›¾ç‰‡å®¹å™¨ */
.background-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  transition: opacity 0.5s ease;
}

/* ä¸»å®¹å™¨ */
.container {
  width: 100%;
  max-width: 900px;
  height: 90vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
  padding: 15px;
  box-sizing: border-box;
  position: relative;
}

/* èŠå¤©å¤´éƒ¨åŒºåŸŸ */
.chat-header {
  width: 100%;
  max-width: 800px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
}

/* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */
.user-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 75px;
  cursor: pointer;
  position: relative;
}

/* ä¿®æ”¹ï¼šå¤´åƒæ ·å¼æ”¹ä¸ºçº¯ç™½è‰²åœ†å½¢ï¼Œæ— æ–‡å­—æ— è¾¹æ¡† */
.avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  overflow: hidden;
  margin-bottom: 3px;
  background-color: white; /* æ”¹ä¸ºçº¯ç™½è‰² */
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ä¿®æ”¹ï¼šç¡®ä¿å¤´åƒå†…å®¹ä¸ºç©º */
.avatar span {
  display: none; /* éšè—æ‰€æœ‰æ–‡å­—/emoji */
}

.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* å¿ƒæƒ…æŒ‡æ•° */
.mood-percentage {
  font-size: 0.65rem;
  color: var(--text);
  margin-top: 2px;
  text-align: center;
  height: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 500;
}

/* çŠ¶æ€æŒ‡ç¤ºå™¨ */
.status-indicator {
  position: absolute;
  top: 0;
  right: 10px;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 2px solid var(--bg-panel);
  z-index: 2;
}

.status-indicator.online {
  background-color: var(--online);
}

.status-indicator.busy {
  background-color: var(--busy);
}

.status-indicator.dr {
  background-color: var(--dr);
}

.status-indicator.cr {
  background-color: var(--cr);
}

.status-indicator.nearby {
  background-color: var(--nearby);
}

/* çŠ¶æ€æ–‡å­— */
.status-text {
  font-size: 0.65rem;
  color: var(--text);
  opacity: 0.8;
  margin-top: 2px;
  text-align: center;
  height: 14px;
}

.nickname {
  font-size: 0.75rem;
  text-align: center;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: var(--text);
  margin-top: 3px;
}

/* èŠå¤©æ ‡é¢˜åŒºåŸŸ */
.chat-title-area {
  text-align: center;
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 0;
  padding: 0 5px;
}

.chat-title-area h1 {
  margin: 0;
  font-weight: 300;
  font-size: 1.6rem;
  color: var(--accent);
  letter-spacing: 1px;
  line-height: 1.2;
}

.chat-subtitle {
  margin: 3px 0 0;
  font-size: 0.75rem;
  opacity: 0.8;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.love-days {
  margin-top: 5px;
  font-size: 0.7rem;
  color: var(--accent);
  display: flex;
  align-items: center;
  gap: 3px;
  cursor: pointer;
  padding: 2px 8px;
  border-radius: 12px;
  background: rgba(138, 127, 141, 0.1);
  transition: all 0.2s;
  white-space: nowrap;
}

.love-days:hover {
  background: rgba(138, 127, 141, 0.2);
}

.love-days i {
  font-size: 0.75rem;
}

/* è®¾ç½®é½¿è½®æŒ‰é’® */
.settings-toggle {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(138, 127, 141, 0.3);
  flex-shrink: 0;
}

.settings-toggle:hover {
  background: var(--accent-light);
  transform: rotate(30deg);
}

.settings-toggle i {
  color: white;
  font-size: 1.1rem;
}

/* èŠå¤©åŒºåŸŸ */
.chat-section {
  width: 100%;
  height: calc(100% - 120px);
  max-width: 800px;
  display: flex;
  flex-direction: column;
}

.chat-container {
  width: 100%;
  height: 100%;
  background: var(--bg-panel);
  backdrop-filter: blur(8px);
  border-radius: 18px;
  padding: 15px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
}

/* èŠå¤©æ¶ˆæ¯åŒºåŸŸ */
.messages-area {
  flex: 1;
  overflow-y: auto;
  padding: 8px 4px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 12px;
}

/* æ¶ˆæ¯å®¹å™¨ - åŒ…å«å¤´åƒå’Œæ¶ˆæ¯ */
.message-container {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  max-width: 100%;
}

.message-container.self {
  flex-direction: row-reverse;
}

.message-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  border: 1px solid rgba(92, 92, 92, 0.2);
}

.message-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.message-content {
  max-width: 70%;
  display: flex;
  flex-direction: column;
  position: relative;
}

.message-container.self .message-content {
  align-items: flex-end;
}

.message-container.other .message-content {
  align-items: flex-start;
}

/* æ¶ˆæ¯æ ·å¼ */
.message {
  max-width: 100%;
  padding: 8px 12px;
  border-radius: 16px;
  line-height: 1.4;
  word-wrap: break-word;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  font-size: 0.9rem;
  position: relative;
  cursor: pointer;
  transition: background-color 0.2s;
}

.message:hover {
  opacity: 0.95;
}

.message.self {
  background: var(--msg-self);
  border-bottom-right-radius: 4px;
}

.message.other {
  background: var(--msg-other);
  border-bottom-left-radius: 4px;
}

.message-time {
  font-size: 0.65rem;
  opacity: 0.6;
  margin-top: 4px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 6px;
}

/* ä¿®æ”¹ï¼šæ¶ˆæ¯æ“ä½œèœå•æ ·å¼ä¼˜åŒ– */
.message-actions {
  position: absolute;
  top: -40px; /* å¢åŠ é«˜åº¦ä»¥é€‚åº”æ›´å¤§çš„æŒ‰é’® */
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); /* å¢å¼ºé˜´å½± */
  display: none;
  flex-direction: row;
  z-index: 10;
  overflow: hidden;
  padding: 2px; /* å¢åŠ å†…è¾¹è· */
}

.message-container.self .message-actions {
  right: 0;
}

.message-container.other .message-actions {
  left: 0;
}

/* ä¿®æ”¹ï¼šæ“ä½œæŒ‰é’®å˜å¤§å¹¶ä½¿ç”¨ç°è‰²ä¸»é¢˜ */
.message-action-btn {
  padding: 8px 16px; /* å¢åŠ æŒ‰é’®å°ºå¯¸ */
  border: none;
  background: transparent;
  font-size: 0.8rem; /* ç¨å¾®å¢å¤§å­—ä½“ */
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  color: var(--accent-gray); /* ä½¿ç”¨ç°è‰²ä¸»é¢˜ */
  border-radius: 6px; /* å¢åŠ åœ†è§’ */
  margin: 2px;
}

.message-action-btn:hover {
  background: var(--accent-gray-light); /* ä½¿ç”¨æµ…ç°è‰²æ‚¬åœæ•ˆæœ */
  color: white;
  transform: translateY(-1px);
}

/* æ‰€æœ‰æ“ä½œæŒ‰é’®ç»Ÿä¸€ä½¿ç”¨ç°è‰²ä¸»é¢˜ */
.message-action-btn.delete {
  color: var(--accent-gray);
}

.message-action-btn.quote {
  color: var(--accent-gray);
}

.message-action-btn.recall {
  color: var(--accent-gray);
}

/* æ¶ˆæ¯çŠ¶æ€ */
.message-status {
  display: flex;
  align-items: center;
  gap: 2px;
  font-size: 0.65rem;
}

.status-check {
  font-size: 0.8rem;
}

.status-check.single {
  color: #888;
}

.status-check.double {
  color: var(--accent);
}

/* å·²è¯»ä¸å›æç¤º */
.read-no-reply {
  color: var(--busy);
  font-size: 0.65rem;
  margin-top: 2px;
  display: flex;
  align-items: center;
  gap: 3px;
}

/* å¼•ç”¨æ¶ˆæ¯æ ·å¼ */
.quoted-message {
  background: var(--quote-bg);
  padding: 6px 8px;
  border-radius: 8px;
  margin-bottom: 6px;
  border-left: 3px solid var(--accent);
  font-size: 0.8rem;
  opacity: 0.9;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  cursor: pointer;
}

.quoted-message img {
  max-height: 20px;
  border-radius: 4px;
  vertical-align: middle;
  margin-right: 4px;
}

/* å¯¹æ–¹æ­£åœ¨è¾“å…¥åŠ¨ç”» */
.typing-indicator {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 12px;
  background: var(--msg-other);
  border-radius: 16px;
  align-self: flex-start;
  max-width: 130px;
  margin-bottom: 4px;
  opacity: 0;
  transition: opacity 0.3s;
  margin-left: 40px;
  font-size: 0.8rem;
}

.typing-indicator.active {
  opacity: 1;
}

.typing-indicator .dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background-color: var(--text);
  opacity: 0.4;
  animation: typingAnimation 1.5s infinite ease-in-out;
}

.typing-indicator .dot:nth-child(1) {
  animation-delay: 0s;
}

.typing-indicator .dot:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator .dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typingAnimation {
  0%, 60%, 100% {
    transform: translateY(0);
    opacity: 0.4;
  }
  30% {
    transform: translateY(-4px);
    opacity: 0.8;
  }
}

/* è¾“å…¥åŒºåŸŸ */
.input-area {
  display: flex;
  gap: 8px;
  align-items: flex-end;
  position: relative;
}

/* ä¿®æ”¹ï¼šç¼©çŸ­è¾“å…¥æ¡† */
.message-input {
  flex: 1;
  min-width: 200px;
  padding: 12px 16px;
  border: none;
  border-radius: 22px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.9rem;
  color: var(--text);
  outline: none;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.message-input:focus {
  background: rgba(255, 255, 255, 0.9);
}

/* è¾“å…¥åŒºåŸŸæŒ‰é’®å®¹å™¨ */
.input-area-buttons {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: nowrap;
}

/* ä¿®æ”¹ï¼šå°†å‘é€æŒ‰é’®æ”¹ä¸ºç°è‰²ä¸»é¢˜è‰² */
.send-button {
  padding: 12px 20px;
  border: none;
  border-radius: 22px;
  background: var(--accent-gray);
  color: white;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 4px 10px rgba(158, 158, 158, 0.3);
  white-space: nowrap;
}

.send-button:hover {
  background: var(--accent-gray-light);
  transform: translateY(-2px);
}

.send-button:active {
  transform: translateY(0);
}

/* ä¿®æ”¹ï¼šå°†"ç»§ç»­"æŒ‰é’®æ”¹ä¸º"..."å›¾æ¡ˆçš„ç°è‰²æŒ‰é’® */
.continue-button {
  width: 44px;
  height: 44px;
  padding: 0;
  border: none;
  border-radius: 22px;
  background: var(--accent-gray);
  color: white;
  font-size: 1.5rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 4px 10px rgba(158, 158, 158, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.continue-button:hover {
  background: var(--accent-gray-light);
  transform: translateY(-2px);
}

/* ä¿®æ”¹ï¼šå°†å›¾ç‰‡ä¸Šä¼ æŒ‰é’®æ”¹ä¸ºç°è‰²ä¸»é¢˜è‰² */
.upload-image-button {
  width: 44px;
  height: 44px;
  border-radius: 22px;
  background: var(--accent-gray);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 4px 10px rgba(158, 158, 158, 0.3);
  flex-shrink: 0;
}

.upload-image-button:hover {
  background: var(--accent-gray-light);
  transform: translateY(-2px);
}

.upload-image-button i {
  font-size: 1.2rem;
}

/* è®¾ç½®é¢æ¿ */
.settings-panel {
  position: fixed;
  top: 0;
  right: -450px;
  width: 420px;
  height: 100vh;
  background: var(--bg-panel);
  backdrop-filter: blur(12px);
  box-shadow: -5px 0 25px rgba(0, 0, 0, 0.15);
  transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.settings-panel.active {
  right: 0;
}

.settings-header {
  padding: 20px;
  border-bottom: 1px solid rgba(92, 92, 92, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.settings-header h2 {
  margin: 0;
  font-weight: 400;
  color: var(--accent);
  font-size: 1.6rem;
}

.close-settings {
  background: none;
  border: none;
  font-size: 1.6rem;
  color: var(--text);
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.2s;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.close-settings:hover {
  opacity: 1;
  background: rgba(92, 92, 92, 0.1);
}

/* è®¾ç½®å†…å®¹åŒºåŸŸ */
.settings-content {
  flex: 1;
  overflow-y: auto;
  padding: 0 20px 20px;
}

.settings-tabs {
  display: flex;
  border-bottom: 1px solid rgba(92, 92, 92, 0.1);
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.tab-button {
  flex: 1;
  padding: 12px;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  font-size: 0.9rem;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
  min-width: 80px;
}

.tab-button.active {
  border-bottom-color: var(--accent);
  color: var(--accent);
  font-weight: 500;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* è¡¨æƒ…åŒ…åº“åŒºåŸŸ */
.sticker-library h3,
.phrases-library h3,
.ratio-library h3,
.appearance-library h3,
.export-library h3,
.communication-library h3,
.cloud-library h3,
.background-library h3,
.tarot-library h3 {
  margin-top: 0;
  margin-bottom: 12px;
  font-weight: 400;
  color: var(--accent);
  font-size: 1.2rem;
}

.sticker-library p,
.phrases-library p,
.ratio-library p,
.appearance-library p,
.export-library p,
.communication-library p,
.cloud-library p,
.background-library p,
.tarot-library p {
  margin: 0 0 16px;
  font-size: 0.85rem;
  opacity: 0.8;
  line-height: 1.4;
}

.sticker-preview {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 20px;
  max-height: 250px;
  overflow-y: auto;
  padding: 4px;
}

.sticker-item {
  width: 100%;
  aspect-ratio: 1;
  border-radius: 8px;
  overflow: hidden;
  background: rgba(255, 255, 255, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px dashed rgba(92, 92, 92, 0.2);
  position: relative;
}

.sticker-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.sticker-placeholder {
  font-size: 1.5rem;
  color: rgba(92, 92, 92, 0.3);
}

.delete-sticker {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  border: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s;
}

.sticker-item:hover .delete-sticker {
  opacity: 1;
}

/* ä¿®æ”¹ï¼šå°†æ‰€æœ‰è®¾ç½®æŒ‰é’®æ”¹ä¸ºç°è‰²ä¸»é¢˜è‰² */
.add-sticker-btn,
.save-phrases-btn,
.export-btn,
.communication-btn,
.cloud-btn,
.save-background-btn,
.save-tarot-btn,
.format-btn,
.background-upload-btn,
.remove-background-btn,
.modal-btn.primary {
  display: block;
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 10px;
  background: var(--accent-gray);
  color: white;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-bottom: 12px;
}

.add-sticker-btn:hover,
.save-phrases-btn:hover,
.export-btn:hover,
.communication-btn:hover,
.cloud-btn:hover,
.save-background-btn:hover,
.save-tarot-btn:hover,
.format-btn:hover,
.background-upload-btn:hover,
.remove-background-btn:hover,
.modal-btn.primary:hover {
  background: var(--accent-gray-light);
}

/* å­—å¡ç®¡ç†åŒºåŸŸ */
.phrases-textarea {
  width: 100%;
  height: 180px;
  padding: 12px;
  border: 1px solid rgba(92, 92, 92, 0.2);
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.85rem;
  line-height: 1.4;
  resize: vertical;
  margin-bottom: 12px;
  box-sizing: border-box;
}

.phrases-textarea:focus {
  outline: none;
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.9);
}

.phrases-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 16px;
  font-size: 0.85rem;
  color: rgba(92, 92, 92, 0.7);
}

/* æ¯”ä¾‹è®¾ç½®åŒºåŸŸ */
.ratio-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
}

.ratio-item {
  margin-bottom: 16px;
}

.ratio-item:last-child {
  margin-bottom: 0;
}

.ratio-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 6px;
  font-size: 0.85rem;
}

.ratio-slider {
  width: 100%;
  height: 5px;
  -webkit-appearance: none;
  appearance: none;
  background: rgba(92, 92, 92, 0.2);
  border-radius: 3px;
  outline: none;
}

.ratio-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.ratio-slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.ratio-value {
  font-weight: 500;
  color: var(--accent);
}

.max-count-control,
.auto-send-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid rgba(92, 92, 92, 0.1);
}

.max-count-label,
.auto-send-label {
  font-size: 0.9rem;
}

.max-count-select,
.auto-send-select {
  padding: 6px 12px;
  border-radius: 8px;
  border: 1px solid rgba(92, 92, 92, 0.3);
  background: rgba(255, 255, 255, 0.7);
  color: var(--text);
  font-size: 0.85rem;
  outline: none;
  width: 70px;
}

/* å¤–è§‚è®¾ç½®åŒºåŸŸ */
.appearance-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
}

.appearance-item {
  margin-bottom: 16px;
}

.appearance-item:last-child {
  margin-bottom: 0;
}

.appearance-label {
  display: block;
  margin-bottom: 6px;
  font-size: 0.85rem;
  color: var(--text);
}

.appearance-input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid rgba(92, 92, 92, 0.3);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.85rem;
  color: var(--text);
  outline: none;
  box-sizing: border-box;
}

.appearance-input:focus {
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.9);
}

.date-inputs {
  display: flex;
  gap: 8px;
  align-items: center;
}

.date-input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid rgba(92, 92, 92, 0.3);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.85rem;
  color: var(--text);
  outline: none;
}

.date-input:focus {
  border-color: var(--accent);
}

/* å¯¼å‡ºè®¾ç½®åŒºåŸŸ */
.export-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
}

.export-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 16px;
}

.export-option {
  display: flex;
  align-items: center;
  gap: 8px;
}

.export-option input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--accent);
}

.export-option label {
  font-size: 0.9rem;
  color: var(--text);
}

.export-formats {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

.format-btn {
  flex: 1;
  padding: 10px;
  border: 1px solid var(--accent-gray);
  border-radius: 8px;
  background: var(--accent-gray);
  color: white;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s;
}

.format-btn:hover {
  background: var(--accent-gray-light);
  color: white;
  border-color: var(--accent-gray-light);
}

/* é€šä¿¡è®¾ç½®åŒºåŸŸ */
.communication-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
}

.communication-item {
  margin-bottom: 20px;
}

.communication-item:last-child {
  margin-bottom: 0;
}

.communication-label {
  display: block;
  margin-bottom: 8px;
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text);
}

.communication-buttons {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}

/* ä¿®æ”¹ï¼šé€šè¯å’Œè§†é¢‘æŒ‰é’®æ”¹ä¸ºinsé»‘ç™½è‰² */
.call-button, .video-button {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  background: #000000;
  color: #ffffff;
  border: 2px solid #000000;
  font-weight: 500;
}

.call-button:hover, .video-button:hover {
  background: #333333;
  color: #ffffff;
  border-color: #333333;
  transform: translateY(-2px);
}

.communication-stats {
  background: rgba(255, 255, 255, 0.7);
  border-radius: 8px;
  padding: 12px;
  margin-top: 16px;
  font-size: 0.85rem;
}

.communication-stats p {
  margin: 6px 0;
}

/* æ–°å¢ï¼šä¸»åŠ¨å‘¼å«è®¾ç½®åŒºåŸŸ */
.active-call-controls {
  background: rgba(255, 255, 255, 0.7);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
  border-left: 4px solid var(--accent);
}

.active-call-item {
  margin-bottom: 16px;
}

.active-call-item:last-child {
  margin-bottom: 0;
}

.active-call-slider {
  width: 100%;
  height: 6px;
  -webkit-appearance: none;
  appearance: none;
  background: linear-gradient(to right, #ccc, var(--accent));
  border-radius: 3px;
  outline: none;
  margin-top: 8px;
}

.active-call-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.active-call-slider::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.active-call-value {
  font-weight: 600;
  color: var(--accent);
  font-size: 1rem;
}

.active-call-preview {
  background: rgba(138, 127, 141, 0.1);
  border-radius: 8px;
  padding: 12px;
  margin-top: 16px;
  font-size: 0.85rem;
  line-height: 1.5;
}

.active-call-preview p {
  margin: 4px 0;
}

/* æ–°å¢ï¼šé¢„è®¾æ¨¡å¼æŒ‰é’® */
.preset-buttons {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  margin-top: 12px;
}

.preset-btn {
  padding: 8px;
  border: 1px solid var(--accent-gray);
  border-radius: 6px;
  background: white;
  color: var(--text);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.preset-btn:hover {
  background: var(--accent-gray-light);
  color: white;
  border-color: var(--accent-gray-light);
}

.preset-btn.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

/* äº‘å¯¼å…¥åŒºåŸŸ */
.cloud-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
}

.cloud-item {
  margin-bottom: 16px;
}

.cloud-item:last-child {
  margin-bottom: 0;
}

.cloud-textarea {
  width: 100%;
  height: 120px;
  padding: 12px;
  border: 1px solid rgba(92, 92, 92, 0.2);
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.85rem;
  line-height: 1.4;
  resize: vertical;
  margin-bottom: 12px;
  box-sizing: border-box;
  font-family: monospace;
}

.cloud-textarea:focus {
  outline: none;
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.9);
}

.cloud-info {
  font-size: 0.8rem;
  color: rgba(92, 92, 92, 0.7);
  margin-top: 12px;
}

/* èƒŒæ™¯è®¾ç½®åŒºåŸŸ */
.background-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
}

.background-item {
  margin-bottom: 16px;
}

.background-item:last-child {
  margin-bottom: 0;
}

.background-preview {
  width: 100%;
  height: 150px;
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 12px;
  border: 2px dashed rgba(92, 92, 92, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  background-size: cover;
  background-position: center;
  position: relative;
}

.background-preview.empty {
  background: rgba(255, 255, 255, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 8px;
}

.background-preview.empty i {
  font-size: 2rem;
  color: rgba(92, 92, 92, 0.3);
}

.background-preview.empty span {
  font-size: 0.85rem;
  color: rgba(92, 92, 92, 0.5);
}

.background-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.background-options {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 16px;
}

.background-option {
  width: 100%;
  height: 60px;
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.background-option:hover {
  transform: scale(1.02);
}

.background-option.active {
  border-color: var(--accent);
}

.background-option img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.background-option.color {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
  color: white;
  font-weight: 500;
  background: #f5f5f5;
  color: var(--text);
}

.background-option.color span {
  position: relative;
  z-index: 2;
}

.background-actions {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

.background-upload-btn {
  flex: 1;
}

/* ä¿®æ”¹ï¼šæ¢å¤é»˜è®¤èƒŒæ™¯æŒ‰é’®æ”¹ä¸ºç°è‰² */
.remove-background-btn {
  background: var(--accent-gray);
  color: white;
  border: none;
  padding: 12px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
  width: 100%;
  margin-top: 10px;
}

.remove-background-btn:hover {
  background: var(--accent-gray-light);
}

/* å¡”ç½—ç‰Œè®¾ç½®åŒºåŸŸ */
.tarot-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
}

.tarot-item {
  margin-bottom: 16px;
}

.tarot-item:last-child {
  margin-bottom: 0;
}

.tarot-switch {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  padding: 12px;
  background: var(--tarot-bg);
  border-radius: 10px;
  border-left: 4px solid var(--tarot-text);
}

.tarot-switch-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
  color: var(--tarot-text);
}

.tarot-switch-label i {
  font-size: 1.2rem;
}

.tarot-count-control {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.tarot-count-label {
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text);
}

.tarot-number-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 16px;
}

.tarot-number {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
}

.tarot-number:hover {
  background: rgba(138, 127, 141, 0.2);
}

.tarot-number.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent-light);
}

.tarot-textarea {
  width: 100%;
  height: 200px;
  padding: 12px;
  border: 1px solid rgba(92, 92, 92, 0.2);
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.85rem;
  line-height: 1.4;
  resize: vertical;
  margin-bottom: 12px;
  box-sizing: border-box;
}

.tarot-textarea:focus {
  outline: none;
  border-color: var(--tarot-text);
  background: rgba(255, 255, 255, 0.9);
}

.tarot-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 16px;
  font-size: 0.85rem;
  color: rgba(92, 92, 92, 0.7);
}

.tarot-status {
  padding: 8px 12px;
  background: var(--tarot-bg);
  border-radius: 8px;
  font-size: 0.85rem;
  color: var(--tarot-text);
  margin-top: 16px;
  border-left: 3px solid var(--tarot-text);
}

/* éšè—çš„æ–‡ä»¶è¾“å…¥ */
.hidden-file-input {
  display: none;
}

/* æ»šåŠ¨æ¡æ ·å¼ */
::-webkit-scrollbar {
  width: 5px;
}

::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.05);
  border-radius: 8px;
}

::-webkit-scrollbar-thumb {
  background: rgba(92, 92, 92, 0.3);
  border-radius: 8px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(92, 92, 92, 0.5);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .container {
    height: 95vh;
    padding: 10px;
    gap: 10px;
  }
  
  .chat-header {
    padding: 5px 0;
  }
  
  .chat-title-area h1 {
    font-size: 1.4rem;
  }
  
  .settings-panel {
    width: 100%;
    right: -100%;
  }
  
  .user-info {
    width: 65px;
  }
  
  .avatar {
    width: 40px;
    height: 40px;
  }
  
  .status-indicator {
    right: 8px;
    width: 8px;
    height: 8px;
  }
  
  .date-inputs {
    flex-direction: column;
  }
  
  .tab-button {
    min-width: 70px;
    padding: 10px 8px;
    font-size: 0.8rem;
  }
  
  .chat-subtitle {
    font-size: 0.7rem;
  }
  
  .love-days {
    font-size: 0.65rem;
    padding: 2px 6px;
  }
  
  .communication-buttons {
    flex-direction: column;
  }
  
  .input-area-buttons {
    flex-wrap: wrap;
  }
  
  .background-options {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .tarot-number-selector {
    justify-content: center;
  }
  
  .message-actions {
    top: -45px; /* ç§»åŠ¨ç«¯è¿›ä¸€æ­¥å¢åŠ é«˜åº¦ */
  }
  
  .message-action-btn {
    padding: 8px 12px; /* ç§»åŠ¨ç«¯ä¿æŒè¾ƒå¤§æŒ‰é’® */
    font-size: 0.75rem;
  }
  
  /* ç§»åŠ¨ç«¯è°ƒæ•´è¾“å…¥æ¡†å¸ƒå±€ */
  .message-input {
    min-width: 150px;
  }
  
  .continue-button {
    width: 40px;
    height: 40px;
    font-size: 1.3rem;
  }
  
  .upload-image-button {
    width: 40px;
    height: 40px;
  }
  
  .send-button {
    padding: 12px 16px;
  }
  
  .preset-buttons {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 480px) {
  .chat-title-area h1 {
    font-size: 1.2rem;
  }
  
  .user-info {
    width: 60px;
  }
  
  .avatar {
    width: 36px;
    height: 36px;
  }
  
  .nickname {
    font-size: 0.7rem;
  }
  
  .status-text,
  .mood-percentage {
    font-size: 0.6rem;
  }
  
  .tab-button {
    min-width: 60px;
    font-size: 0.75rem;
    padding: 8px 6px;
  }
  
  .chat-container {
    padding: 12px;
  }
  
  .message {
    font-size: 0.85rem;
    padding: 6px 10px;
  }
  
  .background-options {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .tarot-number {
    width: 32px;
    height: 32px;
    font-size: 0.8rem;
  }
  
  .message-actions {
    top: -50px;
    flex-direction: column; /* ç§»åŠ¨ç«¯æ”¹ä¸ºå‚ç›´æ’åˆ— */
  }
  
  .message-action-btn {
    padding: 10px 12px; /* ç§»åŠ¨ç«¯æŒ‰é’®æ›´å¤§ */
    width: 100%;
    text-align: center;
  }
  
  /* ç§»åŠ¨ç«¯è¿›ä¸€æ­¥è°ƒæ•´è¾“å…¥æ¡†å¸ƒå±€ */
  .input-area-buttons {
    gap: 6px;
  }
  
  .message-input {
    min-width: 120px;
    padding: 10px 14px;
    font-size: 0.85rem;
  }
  
  .continue-button {
    width: 36px;
    height: 36px;
    font-size: 1.2rem;
  }
  
  .upload-image-button {
    width: 36px;
    height: 36px;
  }
  
  .upload-image-button i {
    font-size: 1rem;
  }
  
  .send-button {
    padding: 10px 14px;
    font-size: 0.85rem;
  }
  
  .preset-buttons {
    grid-template-columns: 1fr;
  }
}

/* é®ç½©å±‚ */
.settings-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(2px);
  z-index: 999;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}

.settings-overlay.active {
  opacity: 1;
  visibility: visible;
}

/* é€šçŸ¥æ ·å¼ */
.notification {
  position: fixed;
  bottom: 15px;
  right: 15px;
  background: var(--accent);
  color: white;
  padding: 10px 16px;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  animation: fadeInOut 3s ease;
  font-size: 0.85rem;
  max-width: 300px;
}

@keyframes fadeInOut {
  0% { opacity: 0; transform: translateY(10px); }
  10% { opacity: 1; transform: translateY(0); }
  90% { opacity: 1; transform: translateY(0); }
  100% { opacity: 0; transform: translateY(10px); }
}

/* é€šè¯/è§†é¢‘å°çª—å£ */
.call-window, .video-window {
  position: fixed;
  width: 40mm;
  height: 40mm;
  background: var(--bg-panel);
  backdrop-filter: blur(8px);
  border-radius: 12px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
  z-index: 2000;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  resize: none;
  cursor: move;
  border: 1px solid rgba(92, 92, 92, 0.2);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  touch-action: none; /* ç¦ç”¨é»˜è®¤è§¦æ‘¸è¡Œä¸ºï¼Œç”¨äºç§»åŠ¨ç«¯æ‹–åŠ¨ */
}

.call-window:hover, .video-window:hover {
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
}

.call-window {
  border-top: 4px solid #000000;
}

.video-window {
  border-top: 4px solid #000000;
}

.call-window.active, .video-window.active {
  transform: scale(1.02);
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
}

.window-header {
  padding: 10px 12px;
  background: rgba(255, 255, 255, 0.9);
  border-bottom: 1px solid rgba(92, 92, 92, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: move;
  touch-action: none; /* ç§»åŠ¨ç«¯æ‹–åŠ¨ */
}

.window-title {
  font-size: 0.9rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
}

.window-title i {
  font-size: 1rem;
}

.call-window .window-title {
  color: #000000;
}

.video-window .window-title {
  color: #000000;
}

.window-controls {
  display: flex;
  gap: 6px;
}

.window-btn {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: none;
  background: rgba(92, 92, 92, 0.1);
  color: var(--text);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
  touch-action: manipulation; /* ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ– */
}

.window-btn:hover {
  background: rgba(92, 92, 92, 0.2);
}

.window-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 15px;
}

.call-avatar, .video-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  overflow: hidden;
  margin-bottom: 10px;
  border: 2px solid;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.call-avatar {
  border-color: #000000;
}

.video-avatar {
  border-color: #000000;
}

.call-avatar img, .video-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.calling-text {
  font-size: 0.8rem;
  color: var(--text);
  margin-bottom: 10px;
  text-align: center;
}

.in-call-text {
  font-size: 0.75rem;
  color: #333;
  background: rgba(0, 0, 0, 0.05);
  padding: 4px 8px;
  border-radius: 6px;
  margin-bottom: 10px;
  font-weight: 500;
}

.call-timer {
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 12px;
  font-family: monospace;
}

.call-buttons {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.accept-btn, .reject-btn, .end-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  min-width: 70px;
  touch-action: manipulation; /* ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ– */
}

.accept-btn {
  background: var(--online);
  color: white;
}

.accept-btn:hover {
  background: #3d8b40;
}

.reject-btn {
  background: #f44336;
  color: white;
}

.reject-btn:hover {
  background: #d32f2f;
}

.end-btn {
  background: #f44336;
  color: white;
}

.end-btn:hover {
  background: #d32f2f;
}

/* é€šè¯è®°å½•æ¶ˆæ¯æ ·å¼ */
.call-message, .video-message {
  background: rgba(0, 0, 0, 0.1);
  border-left: 3px solid #000000;
  color: #000000;
}

.video-message {
  background: rgba(0, 0, 0, 0.1);
  border-left: 3px solid #000000;
  color: #000000;
}

/* å¡”ç½—ç‰Œæ¶ˆæ¯æ ·å¼ */
.tarot-message {
  background: var(--tarot-bg);
  border-left: 3px solid var(--tarot-text);
  color: var(--tarot-text);
}

/* è®¾ç½®å›¾æ ‡å­—ä½“ */
@font-face {
  font-family: 'Material Icons';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/materialicons/v139/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2) format('woff2');
}

.material-icons {
  font-family: 'Material Icons';
  font-weight: normal;
  font-style: normal;
  font-size: 20px;
  line-height: 1;
  letter-spacing: normal;
  text-transform: none;
  display: inline-block;
  white-space: nowrap;
  word-wrap: normal;
  direction: ltr;
  -webkit-font-feature-settings: 'liga';
  -webkit-font-smoothing: antialiased;
}

/* æ˜µç§°ç¼–è¾‘æ¡† */
.nickname-input {
  background: transparent;
  border: none;
  border-bottom: 1px solid var(--accent);
  color: var(--text);
  font-size: 0.8rem;
  text-align: center;
  width: 100%;
  outline: none;
  padding: 2px 0;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(3px);
  z-index: 2000;
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal-content {
  background: var(--bg-panel);
  backdrop-filter: blur(12px);
  border-radius: 18px;
  padding: 24px;
  width: 90%;
  max-width: 350px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.modal-title {
  margin-top: 0;
  margin-bottom: 16px;
  color: var(--accent);
  font-weight: 400;
  text-align: center;
  font-size: 1.3rem;
}

.avatar-preview {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  overflow: hidden;
  margin: 0 auto 16px;
  border: 2px solid var(--accent);
  background-color: white; /* æ¨¡æ€æ¡†å†…ä¹Ÿä½¿ç”¨ç™½è‰²èƒŒæ™¯ */
  display: flex;
  align-items: center;
  justify-content: center;
}

.avatar-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.modal-buttons {
  display: flex;
  gap: 8px;
  margin-top: 16px;
}

.modal-btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
}

.modal-btn.primary {
  background: var(--accent-gray);
  color: white;
}

.modal-btn.secondary {
  background: rgba(92, 92, 92, 0.1);
  color: var(--text);
}

.modal-btn:hover {
  opacity: 0.9;
  transform: translateY(-2px);
}

/* å¼€å…³æ ·å¼ */
.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 26px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: var(--tarot-text);
}

input:checked + .slider:before {
  transform: translateX(24px);
}

/* ç§»åŠ¨ç«¯ä¼˜åŒ– */
@media (max-width: 768px) {
  .call-window, .video-window {
    width: 60mm;
    height: 60mm;
    max-width: 90vw;
    max-height: 90vw;
  }
  
  .call-buttons {
    flex-direction: column;
    width: 100%;
  }
  
  .accept-btn, .reject-btn, .end-btn {
    width: 100%;
    padding: 12px;
  }
}
</style>
</head>
<body>
<!-- èƒŒæ™¯å›¾ç‰‡å®¹å™¨ -->
<div class="background-container" id="backgroundContainer"></div>

<div class="container">
  <!-- è®¾ç½®é®ç½©å±‚ -->
  <div class="settings-overlay" id="settingsOverlay"></div>
  
  <!-- ç”¨æˆ·ä¿¡æ¯ç¼–è¾‘æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="userModal">
    <div class="modal-content">
      <h3 class="modal-title" id="modalTitle">ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯</h3>
      
      <div class="avatar-preview" id="avatarPreview">
        <!-- å¤´åƒé¢„è§ˆ -->
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block; margin-bottom:6px; color:var(--text); font-size:0.85rem;">æ˜µç§°:</label>
        <input type="text" class="nickname-input" id="modalNicknameInput" maxlength="12" style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(92,92,92,0.3); font-size:0.85rem;">
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block; margin-bottom:6px; color:var(--text); font-size:0.85rem;">æ›´æ¢å¤´åƒ:</label>
        <input type="file" id="modalAvatarUpload" class="hidden-file-input" accept="image/*">
        <button class="add-sticker-btn" id="uploadAvatarBtn" style="margin-bottom:0; padding:10px; font-size:0.85rem;">é€‰æ‹©å¤´åƒå›¾ç‰‡</button>
      </div>
      
      <div class="modal-buttons">
        <button class="modal-btn secondary" id="cancelEditBtn">å–æ¶ˆ</button>
        <button class="modal-btn primary" id="saveUserInfoBtn">ä¿å­˜</button>
      </div>
    </div>
  </div>
  
  <!-- èŠå¤©å¤´éƒ¨ -->
  <div class="chat-header">
    <!-- å·¦ä¾§ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯¹æ–¹ï¼‰ -->
    <div class="user-info" id="otherUserInfo">
      <div class="avatar" id="otherAvatar">
        <!-- ç™½è‰²åœ†å½¢ï¼Œæ— æ–‡å­—æ— é»˜è®¤å›¾ç‰‡ -->
      </div>
      <div class="status-indicator" id="otherStatusIndicator"></div>
      <div class="status-text" id="otherStatusText">åœ¨DR</div>
      <div class="mood-percentage" id="otherMoodPercentage">
        <span style="font-size:0.6rem; margin-right:2px;">å¿ƒæƒ…æŒ‡æ•°:</span>
        <span id="otherMoodValue">85%</span>
      </div>
      <div class="nickname" id="otherNickname">å¯¹æ–¹</div>
    </div>
    
    <!-- ä¸­é—´æ ‡é¢˜ -->
    <div class="chat-title-area">
      <h1 id="appTitle">ä¸ƒAndæ„¿</h1>
      <div class="love-days" id="loveDays">
        <i class="material-icons">favorite</i>
        <span id="loveDaysCount">æ‹çˆ±ç¬¬ 0 å¤©</span>
      </div>
      <div class="chat-subtitle" id="appSubtitle">ç»å¯¹ç§å¯†çš„ä¸€å¯¹ä¸€èŠå¤©ç©ºé—´</div>
    </div>
    
    <!-- å³ä¾§ç”¨æˆ·ä¿¡æ¯ï¼ˆè‡ªå·±ï¼‰å’Œè®¾ç½®æŒ‰é’® -->
    <div style="display: flex; align-items: center; gap: 10px;">
      <div class="user-info" id="selfUserInfo">
        <div class="avatar" id="selfAvatar">
          <!-- ç™½è‰²åœ†å½¢ï¼Œæ— æ–‡å­—æ— é»˜è®¤å›¾ç‰‡ -->
        </div>
        <div class="status-text" id="selfStatusText">åœ¨çº¿</div>
        <div class="nickname" id="selfNickname">æˆ‘</div>
      </div>
      
      <div class="settings-toggle" id="settingsToggle">
        <i class="material-icons">settings</i>
      </div>
    </div>
  </div>
  
  <!-- èŠå¤©åŒºåŸŸ -->
  <section class="chat-section">
    <div class="chat-container">
      <div class="messages-area" id="messagesArea">
        <!-- å¯¹æ–¹æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨ -->
        <div class="typing-indicator" id="typingIndicator">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <span style="font-size:0.75rem; margin-left:4px;">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</span>
        </div>
        
        <!-- åˆå§‹æ¶ˆæ¯å°†ä»æœ¬åœ°å­˜å‚¨åŠ è½½ -->
      </div>
      
      <div class="input-area">
        <div class="input-area-buttons">
          <input type="text" class="message-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="200">
          <div class="upload-image-button" id="uploadImageButton" title="å‘é€å›¾ç‰‡">
            <i class="material-icons">image</i>
          </div>
          <input type="file" id="imageUpload" class="hidden-file-input" accept="image/*">
          <button class="continue-button" id="continueButton">...</button>
          <button class="send-button" id="sendButton">å‘é€</button>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- è®¾ç½®é¢æ¿ -->
<div class="settings-panel" id="settingsPanel">
  <div class="settings-header">
    <h2>è®¾ç½®</h2>
    <button class="close-settings" id="closeSettings">
      <i class="material-icons">close</i>
    </button>
  </div>
  
  <div class="settings-tabs">
    <button class="tab-button active" data-tab="stickers">è¡¨æƒ…åŒ…åº“</button>
    <button class="tab-button" data-tab="phrases">å›å¤è¯æ¡</button>
    <button class="tab-button" data-tab="tarot">å¡”ç½—ç‰Œå­—å¡æŠ½å–ğŸ”®</button>
    <button class="tab-button" data-tab="ratio">å‘é€è®¾ç½®</button>
    <button class="tab-button" data-tab="appearance">å¤–è§‚è®¾ç½®</button>
    <button class="tab-button" data-tab="background">èƒŒæ™¯è®¾ç½®</button>
    <button class="tab-button" data-tab="communication">é€šè¯è§†é¢‘</button>
    <button class="tab-button" data-tab="cloud">äº‘å¯¼å…¥</button>
    <button class="tab-button" data-tab="export">å¯¼å‡ºè®°å½•</button>
  </div>
  
  <div class="settings-content">
    <!-- è¡¨æƒ…åŒ…åº“æ ‡ç­¾é¡µ -->
    <div class="tab-content active" id="stickersTab">
      <div class="sticker-library">
        <h3>è¡¨æƒ…åŒ…åº“ç®¡ç†</h3>
        <p>æ·»åŠ å›¾ç‰‡åï¼Œå¯¹æ–¹å¯ä»¥éšæœºå‘é€è¿™äº›è¡¨æƒ…åŒ…ä½œä¸ºå›å¤</p>
        
        <div class="sticker-preview" id="stickerPreview">
          <!-- è¡¨æƒ…åŒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
          <div class="sticker-item" id="addStickerPlaceholder">
            <div class="sticker-placeholder">+</div>
          </div>
        </div>
        
        <input type="file" id="stickerUpload" class="hidden-file-input" accept="image/*" multiple>
        <button class="add-sticker-btn" id="addStickerBtn">ä»ç›¸å†Œæ·»åŠ è¡¨æƒ…åŒ…</button>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šç‚¹å‡»è¡¨æƒ…åŒ…å³ä¸Šè§’çš„Ã—å¯ä»¥åˆ é™¤ã€‚å·²æ·»åŠ  <span id="stickerCount">0</span> ä¸ªè¡¨æƒ…åŒ…
        </p>
      </div>
    </div>
    
    <!-- å›å¤è¯æ¡æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="phrasesTab">
      <div class="phrases-library">
        <h3>å›å¤è¯æ¡ç®¡ç†</h3>
        <p style="margin-bottom: 8px;">å¯¹æ–¹å°†ä»è¿™äº›è¯æ¡ä¸­éšæœºæŠ½å–ä½œä¸ºå›å¤ã€‚æ¯è¡Œä¸€ä¸ªè¯æ¡ï¼Œè‡ªåŠ¨è¯†åˆ«åˆ†è¡Œã€‚</p>
        <p style="font-size:0.75rem; color:#888; margin-bottom: 16px;">æç¤ºï¼šç‚¹å‡»ä»»æ„æ¶ˆæ¯å¯ä»¥å¼•ç”¨oråˆ é™¤oræ’¤å›</p>
        
        <textarea class="phrases-textarea" id="phrasesTextarea" placeholder="è¯·è¾“å…¥å›å¤è¯æ¡ï¼Œæ¯è¡Œä¸€ä¸ª&#10;ä¾‹å¦‚ï¼š&#10;å¥½çš„ï¼Œæ˜ç™½äº†&#10;è¿™å¾ˆæœ‰è¶£&#10;ç»§ç»­èŠå§&#10;è®©æˆ‘æƒ³æƒ³"></textarea>
        
        <div class="phrases-info">
          <span>å½“å‰è¯æ¡æ•°: <span id="phraseCount">0</span></span>
          <span>éšæœºæ··åˆè¡¨æƒ…åŒ…å’Œå­—å¡å‘é€</span>
        </div>
        
        <button class="save-phrases-btn" id="savePhrasesBtn">ä¿å­˜è¯æ¡</button>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šä¿å­˜åï¼Œå¯¹æ–¹å°†ä»è¿™äº›è¯æ¡å’Œè¡¨æƒ…åŒ…ä¸­éšæœºé€‰æ‹©ï¼Œéšæœºæ··åˆå‘é€<br>
          ï¼ˆå¡”ç½—ç‰Œæ¨¡å¼å¼€å¯æ—¶ï¼Œå°†ä¼˜å…ˆä½¿ç”¨å¡”ç½—ç‰Œå­—å¡ï¼‰
        </p>
      </div>
    </div>
    
    <!-- å¡”ç½—ç‰Œå­—å¡æŠ½å–æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="tarotTab">
      <div class="tarot-library">
        <h3>å¡”ç½—ç‰Œå­—å¡æŠ½å–ğŸ”®</h3>
        <p>å¼€å¯å¡”ç½—ç‰Œæ¢¦å æ¨¡å¼ï¼Œå¯¹æ–¹å°†åªæŠ½å–å¡”ç½—ç‰Œå­—å¡è¿›è¡Œå›å¤</p>
        
        <div class="tarot-controls">
          <div class="tarot-switch">
            <div class="tarot-switch-label">
              <i class="material-icons">auto_awesome</i>
              <span>å¡”ç½—ç‰Œæ¢¦å æ¨¡å¼</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="tarotModeToggle">
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="tarot-item">
            <div class="tarot-count-control">
              <div class="tarot-count-label">æ¯æ¬¡æŠ½å–æ•°é‡:</div>
              <div id="tarotCountValue">1</div>
            </div>
            
            <div class="tarot-number-selector" id="tarotNumberSelector">
              <!-- æ•°å­—1-15å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
          
          <div class="tarot-item">
            <label class="communication-label">å¡”ç½—ç‰Œå­—å¡åº“:</label>
            <textarea class="tarot-textarea" id="tarotTextarea" placeholder="è¯·è¾“å…¥å¡”ç½—ç‰Œå­—å¡ï¼Œæ¯è¡Œä¸€ä¸ª&#10;ä¾‹å¦‚ï¼š&#10;æ„šäºº æ­£ä½&#10;é­”æœ¯å¸ˆ é€†ä½&#10;å¥³ç¥­å¸ æ­£ä½&#10;ä¸–ç•Œ é€†ä½"></textarea>
            
            <div class="tarot-info">
              <span>å½“å‰å¡”ç½—ç‰Œå­—å¡æ•°: <span id="tarotPhraseCount">0</span></span>
              <span>æ¯è¡Œä¸€ä¸ªå­—å¡</span>
            </div>
          </div>
          
          <button class="save-tarot-btn" id="saveTarotBtn">ä¿å­˜å¡”ç½—ç‰Œè®¾ç½®</button>
          
          <div class="tarot-status" id="tarotStatus">
            å¡”ç½—ç‰Œæ¨¡å¼å·²å…³é—­ï¼Œå¯¹æ–¹ä½¿ç”¨æ™®é€šè¯æ¡å’Œè¡¨æƒ…åŒ…å›å¤
          </div>
          
          <!-- æ–°å¢ï¼šå¡”ç½—ç‰Œæ“ä½œæŒ‰é’® -->
          <div style="display: flex; gap: 10px; margin-top: 16px;">
            <button class="cloud-btn" id="loadDefaultTarotBtn" style="flex: 1; padding: 10px;">åŠ è½½é»˜è®¤78å¼ å¡”ç½—ç‰Œ</button>
            <button class="cloud-btn" id="clearTarotBtn" style="flex: 1; padding: 10px; background: #888;">æ¸…ç©ºå¡”ç½—ç‰Œåº“</button>
          </div>
          
          <div style="margin-top: 16px; padding: 12px; background: rgba(255, 255, 255, 0.5); border-radius: 8px; border-left: 3px solid var(--tarot-text);">
            <p style="margin: 0 0 8px 0; font-size: 0.85rem; font-weight: 500; color: var(--tarot-text);">æŠ½å–è§„åˆ™è¯´æ˜ï¼š</p>
            <p style="margin: 4px 0; font-size: 0.75rem; color: #666;">
              â€¢ æ™ºèƒ½è¯†åˆ«ç‰Œåï¼šæ”¯æŒ"æ„šäºº æ­£ä½"ã€"æ­£ä½Â·é­”æœ¯å¸ˆ"ã€"é€†ä½-å¥³ç¥­å¸"ç­‰å¤šç§æ ¼å¼
            </p>
            <p style="margin: 4px 0; font-size: 0.75rem; color: #666;">
              â€¢ åŒç‰Œæ­£é€†ä½ä¸é‡å¤ï¼šæŠ½åˆ°"æ„šäºº æ­£ä½"åï¼Œä¸ä¼šå†æŠ½"æ„šäºº é€†ä½"
            </p>
            <p style="margin: 4px 0; font-size: 0.75rem; color: #666;">
              â€¢ æ™ºèƒ½è§„åˆ™åŒæ—¶é€‚ç”¨äºé»˜è®¤ç‰Œå’Œè‡ªå®šä¹‰ç‰Œ
            </p>
            <p style="margin: 4px 0; font-size: 0.75rem; color: #666;">
              â€¢ è‡ªå®šä¹‰ç‰Œåæ— æ³•è¯†åˆ«æ—¶ï¼ŒæŒ‰ç‹¬ç«‹å­—å¡å¤„ç†
            </p>
          </div>
        </div>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šå¼€å¯å¡”ç½—ç‰Œæ¨¡å¼åï¼Œå¯¹æ–¹å›å¤å°†åªä»å¡”ç½—ç‰Œå­—å¡åº“ä¸­æŠ½å–<br>
          å…³é—­å¡”ç½—ç‰Œæ¨¡å¼åï¼Œæ¢å¤ä½¿ç”¨æ™®é€šè¯æ¡å’Œè¡¨æƒ…åŒ…<br>
          å¯ä»¥è®¾ç½®æ¯æ¬¡æŠ½å–1-15å¼ å¡”ç½—ç‰Œå­—å¡<br>
          <strong>æ™ºèƒ½è§„åˆ™ï¼šåŒç‰Œæ­£é€†ä½ä¸é‡å¤æŠ½å–</strong>
        </p>
      </div>
    </div>
    
    <!-- å‘é€è®¾ç½®æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="ratioTab">
      <div class="ratio-library">
        <h3>å‘é€è®¾ç½®</h3>
        <p>è°ƒæ•´å¯¹æ–¹å›å¤æ—¶è¡¨æƒ…åŒ…å’Œå­—å¡çš„å‘é€æ¯”ä¾‹</p>
        
        <div class="ratio-controls">
          <div class="ratio-item">
            <div class="ratio-label">
              <span>è¡¨æƒ…åŒ…å‘é€æ¯”ä¾‹</span>
              <span class="ratio-value" id="stickerRatioValue">50%</span>
            </div>
            <input type="range" min="0" max="100" value="50" class="ratio-slider" id="stickerRatioSlider">
          </div>
          
          <div class="ratio-item">
            <div class="ratio-label">
              <span>å­—å¡å‘é€æ¯”ä¾‹</span>
              <span class="ratio-value" id="phraseRatioValue">50%</span>
            </div>
            <input type="range" min="0" max="100" value="50" class="ratio-slider" id="phraseRatioSlider">
          </div>
          
          <div class="max-count-control">
            <div class="max-count-label">æœ€å¤§å‘é€æ•°é‡:</div>
            <select class="max-count-select" id="maxMessageCount">
              <option value="1">1æ¡</option>
              <option value="2">2æ¡</option>
              <option value="3" selected>3æ¡</option>
              <option value="4">4æ¡</option>
              <option value="5">5æ¡</option>
            </select>
          </div>
          
          <div class="auto-send-controls">
            <div class="auto-send-label">ä¸»åŠ¨å‘é€é¢‘ç‡:</div>
            <select class="auto-send-select" id="autoSendFrequency">
              <option value="0">ä¸ä¸»åŠ¨å‘é€</option>
              <option value="300000">5åˆ†é’Ÿ</option>
              <option value="600000" selected>10åˆ†é’Ÿ</option>
              <option value="1200000">20åˆ†é’Ÿ</option>
              <option value="1800000">30åˆ†é’Ÿ</option>
              <option value="3600000">1å°æ—¶</option>
            </select>
          </div>
        </div>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šå¯¹æ–¹å›å¤æ—¶ä¼šæ ¹æ®æ­¤æ¯”ä¾‹éšæœºæ··åˆå‘é€è¡¨æƒ…åŒ…å’Œå­—å¡<br>
          å¦‚æœå‡ºç°"å¯¹æ–¹æ­£åœ¨è¾“å…¥ä¸­"ï¼Œåˆ™ä¸€å®šä¼šå›å¤<br>
          å¯¹æ–¹ä¹Ÿä¼šæ ¹æ®è®¾ç½®çš„é¢‘ç‡ä¸»åŠ¨å‘é€æ¶ˆæ¯<br>
          ï¼ˆå¡”ç½—ç‰Œæ¨¡å¼å¼€å¯æ—¶ï¼Œå°†å¿½ç•¥æ­¤æ¯”ä¾‹è®¾ç½®ï¼ŒåªæŠ½å–å¡”ç½—ç‰Œå­—å¡ï¼‰
        </p>
      </div>
    </div>
    
    <!-- å¤–è§‚è®¾ç½®æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="appearanceTab">
      <div class="appearance-library">
        <h3>å¤–è§‚è®¾ç½®</h3>
        <p>è‡ªå®šä¹‰èŠå¤©ç•Œé¢çš„å¤–è§‚å’Œæ˜¾ç¤ºä¿¡æ¯</p>
        
        <div class="appearance-controls">
          <div class="appearance-item">
            <label class="appearance-label">åº”ç”¨æ ‡é¢˜:</label>
            <input type="text" class="appearance-input" id="appTitleInput" value="ä¸ƒAndæ„¿" maxlength="20">
          </div>
          
          <div class="appearance-item">
            <label class="appearance-label">åº”ç”¨å‰¯æ ‡é¢˜:</label>
            <input type="text" class="appearance-input" id="appSubtitleInput" value="ç»å¯¹ç§å¯†çš„ä¸€å¯¹ä¸€èŠå¤©ç©ºé—´" maxlength="50">
          </div>
          
          <div class="appearance-item">
            <label class="appearance-label">æ‹çˆ±èµ·å§‹æ—¥æœŸ:</label>
            <div class="date-inputs">
              <input type="number" class="date-input" id="loveYear" placeholder="å¹´" min="2000" max="2100" value="2024">
              <input type="number" class="date-input" id="loveMonth" placeholder="æœˆ" min="1" max="12" value="1">
              <input type="number" class="date-input" id="loveDay" placeholder="æ—¥" min="1" max="31" value="1">
            </div>
          </div>
          
          <div class="appearance-item">
            <label class="appearance-label">å¯¹æ–¹å¿ƒæƒ…å˜åŒ–é¢‘ç‡:</label>
            <select class="appearance-input" id="moodChangeFrequency">
              <option value="60000">1åˆ†é’Ÿ</option>
              <option value="300000">5åˆ†é’Ÿ</option>
              <option value="600000" selected>10åˆ†é’Ÿ</option>
              <option value="1200000">20åˆ†é’Ÿ</option>
              <option value="1800000">30åˆ†é’Ÿ</option>
            </select>
          </div>
        </div>
        
        <button class="save-phrases-btn" id="saveAppearanceBtn">ä¿å­˜å¤–è§‚è®¾ç½®</button>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šä¿å­˜åï¼Œåº”ç”¨æ ‡é¢˜ã€å‰¯æ ‡é¢˜å’Œæ‹çˆ±å¤©æ•°å°†ç«‹å³æ›´æ–°<br>
          æ‹çˆ±å¤©æ•°ä¼šæ ¹æ®è®¾ç½®çš„èµ·å§‹æ—¥æœŸè‡ªåŠ¨è®¡ç®—
        </p>
      </div>
    </div>
    
    <!-- èƒŒæ™¯è®¾ç½®æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="backgroundTab">
      <div class="background-library">
        <h3>èƒŒæ™¯è®¾ç½®</h3>
        <p>è‡ªå®šä¹‰èŠå¤©èƒŒæ™¯ï¼Œå¯ä»¥é€‰æ‹©é¢„è®¾èƒŒæ™¯æˆ–ä¸Šä¼ è‡ªå·±çš„å›¾ç‰‡</p>
        
        <div class="background-controls">
          <div class="background-item">
            <label class="communication-label">å½“å‰èƒŒæ™¯é¢„è§ˆ:</label>
            <div class="background-preview" id="backgroundPreview">
              <div class="empty">
                <i class="material-icons">wallpaper</i>
                <span>é»˜è®¤èƒŒæ™¯</span>
              </div>
            </div>
          </div>
          
          <div class="background-item">
            <label class="communication-label">ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡:</label>
            <div class="background-options">
              <div class="background-option color" id="uploadBackgroundOption">
                <span>ç‚¹å‡»ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡</span>
              </div>
            </div>
            <input type="file" id="backgroundUpload" class="hidden-file-input" accept="image/*">
          </div>
          
          <div class="background-item">
            <label class="communication-label">èƒŒæ™¯é€æ˜åº¦:</label>
            <input type="range" min="0" max="100" value="100" class="ratio-slider" id="backgroundOpacitySlider">
            <div style="display:flex; justify-content:space-between; margin-top:8px;">
              <span style="font-size:0.8rem;">é€æ˜</span>
              <span style="font-size:0.8rem;" id="backgroundOpacityValue">100%</span>
              <span style="font-size:0.8rem;">ä¸é€æ˜</span>
            </div>
          </div>
          
          <button class="remove-background-btn" id="removeBackgroundBtn">æ¢å¤é»˜è®¤èƒŒæ™¯</button>
        </div>
        
        <button class="save-background-btn" id="saveBackgroundBtn">ä¿å­˜èƒŒæ™¯è®¾ç½®</button>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šèƒŒæ™¯å›¾ç‰‡æ”¯æŒJPGã€PNGæ ¼å¼<br>
          èƒŒæ™¯é€æ˜åº¦è°ƒèŠ‚åªå½±å“èƒŒæ™¯å›¾ç‰‡ï¼Œä¸å½±å“èŠå¤©ç•Œé¢<br>
          ä¸Šä¼ çš„å›¾ç‰‡ä¼šä¿å­˜åœ¨æœ¬åœ°ï¼Œåˆ·æ–°é¡µé¢ä¸ä¼šä¸¢å¤±
        </p>
      </div>
    </div>
    
    <!-- é€šä¿¡è®¾ç½®æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="communicationTab">
      <div class="communication-library">
        <h3>é€šè¯ä¸è§†é¢‘</h3>
        <p>æ¨¡æ‹Ÿé€šè¯å’Œè§†é¢‘åŠŸèƒ½ï¼Œå¯¹æ–¹å¯ä»¥ä¸»åŠ¨é‚€è¯·æˆ–å“åº”ç”¨æˆ·çš„é‚€è¯·</p>
        
        <div class="communication-controls">
          <div class="communication-item">
            <div class="communication-label">ä¸»åŠ¨å‘¼å«å¯¹æ–¹</div>
            <div class="communication-buttons">
              <button class="call-button" id="startCallButton">
                <i class="material-icons">call</i>
                è¯­éŸ³é€šè¯
              </button>
              <button class="video-button" id="startVideoButton">
                <i class="material-icons">videocam</i>
                è§†é¢‘é€šè¯
              </button>
            </div>
          </div>
          
          <div class="communication-item">
            <div class="communication-label">é€šè¯è®¾ç½®</div>
            <div style="margin-top: 10px;">
              <label style="display:flex; align-items:center; gap:8px; font-size:0.85rem; margin-bottom:8px;">
                <input type="checkbox" id="autoAcceptCalls" checked>
                <span>è‡ªåŠ¨æ¥å¬å¯¹æ–¹æ¥ç”µ</span>
              </label>
              <label style="display:flex; align-items:center; gap:8px; font-size:0.85rem;">
                <input type="checkbox" id="autoAcceptVideos" checked>
                <span>è‡ªåŠ¨æ¥å¬å¯¹æ–¹è§†é¢‘é‚€è¯·</span>
              </label>
            </div>
          </div>
          
          <!-- æ–°å¢ï¼šä¸»åŠ¨å‘¼å«è®¾ç½® -->
          <div class="active-call-controls">
            <div class="communication-label">å¯¹æ–¹ä¸»åŠ¨å‘¼å«è®¾ç½®</div>
            
            <div class="active-call-item">
              <div class="ratio-label">
                <span>æ€»ä½“å‘¼å«é¢‘ç‡</span>
                <span class="active-call-value" id="overallFrequencyValue">30%</span>
              </div>
              <input type="range" min="0" max="100" value="30" class="active-call-slider" id="overallFrequencySlider">
              <div style="display:flex; justify-content:space-between; margin-top:4px;">
                <span style="font-size:0.75rem; color:#888;">å…³é—­</span>
                <span style="font-size:0.75rem; color:#888;">æœ€é«˜</span>
              </div>
            </div>
            
            <div class="active-call-item">
              <div class="ratio-label">
                <span>å‘¼å«ç±»å‹åå¥½</span>
                <span class="active-call-value" id="callPreferenceValue">ç”µè¯ 50% / è§†é¢‘ 50%</span>
              </div>
              <input type="range" min="0" max="100" value="50" class="active-call-slider" id="callPreferenceSlider">
              <div style="display:flex; justify-content:space-between; margin-top:4px;">
                <span style="font-size:0.75rem; color:#888;">çº¯ç”µè¯</span>
                <span style="font-size:0.75rem; color:#888;">çº¯è§†é¢‘</span>
              </div>
            </div>
            
            <!-- é¢„è®¾æ¨¡å¼ -->
            <div class="active-call-item">
              <div class="ratio-label">
                <span>é¢„è®¾æ¨¡å¼</span>
              </div>
              <div class="preset-buttons">
                <button class="preset-btn" data-preset="quiet">å®‰é™æ¨¡å¼</button>
                <button class="preset-btn" data-preset="daily">æ—¥å¸¸æ¨¡å¼</button>
                <button class="preset-btn" data-preset="intimate">äº²å¯†æ¨¡å¼</button>
                <button class="preset-btn active" data-preset="custom">è‡ªå®šä¹‰</button>
              </div>
            </div>
            
            <!-- è¯¦ç»†é¢„è§ˆ -->
            <div class="active-call-preview" id="activeCallPreview">
              <p><strong>å½“å‰è®¾ç½®é¢„è§ˆï¼š</strong></p>
              <p>â€¢ æ€»ä½“é¢‘ç‡ï¼š<span id="previewFrequency">ä¸­ç­‰ (30%)</span></p>
              <p>â€¢ å‘¼å«ç±»å‹ï¼š<span id="previewType">ç”µè¯ 50% / è§†é¢‘ 50%</span></p>
              <p>â€¢ é¢„è®¡æ¯å¤©ï¼š<span id="previewDaily">2-4æ¬¡å‘¼å«</span></p>
              <p>â€¢ ä¸‹æ¬¡å‘¼å«ï¼š<span id="previewNext">15-30åˆ†é’Ÿå†…</span></p>
            </div>
          </div>
          
          <div class="communication-stats">
            <p style="margin:0 0 8px 0; font-weight:500;">é€šè¯ç»Ÿè®¡</p>
            <p style="margin:6px 0;">ä»Šæ—¥é€šè¯: <span id="todayCalls">0</span> æ¬¡</p>
            <p style="margin:6px 0;">æ€»é€šè¯æ—¶é•¿: <span id="totalCallTime">0</span> åˆ†é’Ÿ</p>
            <p style="margin:6px 0;">ä»Šæ—¥è§†é¢‘: <span id="todayVideos">0</span> æ¬¡</p>
            <p style="margin:6px 0;">æ€»è§†é¢‘æ—¶é•¿: <span id="totalVideoTime">0</span> åˆ†é’Ÿ</p>
            <p style="margin:6px 0; font-size:0.8rem; color:#666;">å¯¹æ–¹ä»Šæ—¥ä¸»åŠ¨å‘¼å«: <span id="todayIncomingCalls">0</span> æ¬¡</p>
          </div>
        </div>
        
        <button class="communication-btn" id="saveCommunicationBtn">ä¿å­˜é€šè¯è®¾ç½®</button>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šé€šè¯/è§†é¢‘å°çª—å£å¯ä»¥éšæ„æ‹–åŠ¨ä½ç½®ï¼ˆæ”¯æŒæ‰‹æœºè§¦æ‘¸æ‹–åŠ¨ï¼‰<br>
          é€šè¯è®°å½•ä¼šè‡ªåŠ¨ä¿å­˜åˆ°èŠå¤©ä¸­<br>
          å¯¹æ–¹ä¼šæ ¹æ®æ‚¨çš„è®¾ç½®ä¸»åŠ¨å‘èµ·é€šè¯æˆ–è§†é¢‘é‚€è¯·
        </p>
      </div>
    </div>
    
    <!-- äº‘å¯¼å…¥æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="cloudTab">
      <div class="cloud-library">
        <h3>äº‘æ•°æ®å¯¼å…¥</h3>
        <p>å¯¼å…¥ä¹‹å‰å¯¼å‡ºçš„èŠå¤©è®°å½•æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰</p>
        
        <div class="cloud-controls">
          <div class="cloud-item">
            <label class="communication-label">å¯¼å…¥JSONæ•°æ®:</label>
            <textarea class="cloud-textarea" id="cloudImportTextarea" placeholder="è¯·ç²˜è´´ä¹‹å‰å¯¼å‡ºçš„JSONæ•°æ®..."></textarea>
            <div style="display:flex; gap:10px;">
              <button class="cloud-btn" id="importCloudBtn">å¯¼å…¥æ•°æ®</button>
              <button class="cloud-btn" style="background:#888;" id="clearCloudBtn">æ¸…ç©º</button>
            </div>
          </div>
          
          <div class="cloud-item">
            <div class="communication-label">ä»æ–‡ä»¶å¯¼å…¥:</div>
            <input type="file" id="cloudFileUpload" class="hidden-file-input" accept=".json,.txt">
            <button class="cloud-btn" id="importFileBtn">é€‰æ‹©æ–‡ä»¶å¯¼å…¥</button>
          </div>
          
          <div class="cloud-info">
            <p>å¯¼å…¥è¯´æ˜ï¼š</p>
            <p>1. åªèƒ½å¯¼å…¥ä¹‹å‰ä»æ­¤åº”ç”¨å¯¼å‡ºçš„JSONæ ¼å¼æ•°æ®</p>
            <p>2. å¯¼å…¥ä¼šè¦†ç›–å½“å‰çš„æ‰€æœ‰èŠå¤©è®°å½•å’Œè®¾ç½®</p>
            <p>3. å»ºè®®åœ¨å¯¼å…¥å‰å…ˆå¯¼å‡ºå½“å‰æ•°æ®å¤‡ä»½</p>
            <p>4. å¯¼å…¥åéœ€è¦åˆ·æ–°é¡µé¢ç”Ÿæ•ˆ</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å¯¼å‡ºè®°å½•æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="exportTab">
      <div class="export-library">
        <h3>èŠå¤©è®°å½•å¯¼å‡º</h3>
        <p>å¯¼å‡ºèŠå¤©è®°å½•ï¼Œæ”¯æŒå¤šç§æ ¼å¼</p>
        
        <div class="export-controls">
          <div class="export-options">
            <div class="export-option">
              <input type="checkbox" id="exportMessages" checked>
              <label for="exportMessages">å¯¼å‡ºèŠå¤©æ¶ˆæ¯</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportSettings" checked>
              <label for="exportSettings">å¯¼å‡ºè®¾ç½®ä¿¡æ¯</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportStickers" checked>
              <label for="exportStickers">å¯¼å‡ºè¡¨æƒ…åŒ…ä¿¡æ¯</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportPhrases" checked>
              <label for="exportPhrases">å¯¼å‡ºè¯æ¡ä¿¡æ¯</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportTarot" checked>
              <label for="exportTarot">å¯¼å‡ºå¡”ç½—ç‰Œè®¾ç½®</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportBackground" checked>
              <label for="exportBackground">å¯¼å‡ºèƒŒæ™¯è®¾ç½®</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportCommunication" checked>
              <label for="exportCommunication">å¯¼å‡ºé€šè¯è®°å½•</label>
            </div>
          </div>
          
          <div class="export-formats">
            <button class="format-btn" id="exportTxtBtn">å¯¼å‡ºä¸ºTXT</button>
            <button class="format-btn" id="exportJsonBtn">å¯¼å‡ºä¸ºJSON</button>
            <button class="format-btn" id="exportHtmlBtn">å¯¼å‡ºä¸ºHTML</button>
          </div>
        </div>
        
        <button class="export-btn" id="exportAllBtn">å¯¼å‡ºå…¨éƒ¨æ•°æ®</button>
        
        <p style="font-size:0.75rem; margin-top:16px; color:#888;">
          æç¤ºï¼šå¯¼å‡ºæ•°æ®åŒ…å«æ‰€æœ‰èŠå¤©è®°å½•å’Œè®¾ç½®<br>
          å¯ä»¥åœ¨å…¶ä»–è®¾å¤‡æˆ–æµè§ˆå™¨ä¸­å¯¼å…¥ä½¿ç”¨<br>
          æ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼Œå…³é—­é¡µé¢ä¹Ÿä¸ä¼šä¸¢å¤±
        </p>
      </div>
    </div>
  </div>
</div>

<!-- é€šè¯/è§†é¢‘å°çª—å£ä¼šåŠ¨æ€åˆ›å»º -->

<script>
// åº”ç”¨æ•°æ® - åˆå§‹åŒ–ä¸ºç©ºï¼Œå°†ä»æœ¬åœ°å­˜å‚¨åŠ è½½
const appData = {
  // ç”¨æˆ·ä¿¡æ¯ - ä¿®æ”¹ï¼šavatarTextä¸ºç©ºå­—ç¬¦ä¸²
  selfInfo: {
    nickname: 'æˆ‘',
    avatar: '',
    avatarText: '', // æ”¹ä¸ºç©ºå­—ç¬¦ä¸²
    status: 'åœ¨çº¿'
  },
  otherInfo: {
    nickname: 'å¯¹æ–¹',
    avatar: '',
    avatarText: '', // æ”¹ä¸ºç©ºå­—ç¬¦ä¸²
    status: 'åœ¨DR',
    mood: 85, // å¿ƒæƒ…æŒ‡æ•° 0-100
  },
  
  // å¿ƒæƒ…å›¾æ ‡å¯¹åº”å…³ç³»
  moodIcons: {
    'ğŸ˜Š': { min: 80, max: 100, color: '#ffcc00' }, // å¼€å¿ƒ
    'ğŸ˜': { min: 50, max: 79, color: '#4caf50' }, // ä¸€èˆ¬
    'ğŸ˜”': { min: 20, max: 49, color: '#9c27b0' }, // ä½è½
    'ğŸ˜ ': { min: 0, max: 19, color: '#f44336' }  // ç”Ÿæ°”
  },
  
  // çŠ¶æ€å®šä¹‰
  statusOptions: [
    { text: 'åœ¨DR', class: 'dr', color: '#2196f3' },
    { text: 'åœ¨CR', class: 'cr', color: '#9c27b0' },
    { text: 'åœ¨çº¿', class: 'online', color: '#4caf50' },
    { text: 'åœ¨å¿™', class: 'busy', color: '#ff9800' },
    { text: 'åœ¨æˆ‘èº«è¾¹', class: 'nearby', color: '#ff5722' }
  ],
  
  // çŠ¶æ€åˆ‡æ¢æ—¶é—´ï¼ˆç§’ï¼‰- å¢åŠ æ—¶é—´ï¼Œé™ä½åˆ‡æ¢é¢‘ç‡
  statusChangeTimes: [120, 300, 600, 900, 1800, 2700, 3600, 5400, 7200],
  
  // å‘é€è®¾ç½®
  sendSettings: {
    stickerRatio: 50, // è¡¨æƒ…åŒ…å‘é€æ¯”ä¾‹
    phraseRatio: 50,  // å­—å¡å‘é€æ¯”ä¾‹
    maxMessageCount: 3, // æœ€å¤§å‘é€æ•°é‡
    autoSendFrequency: 600000 // ä¸»åŠ¨å‘é€é¢‘ç‡ï¼ˆ10åˆ†é’Ÿï¼‰
  },
  
  // å¤–è§‚è®¾ç½®
  appearanceSettings: {
    appTitle: 'ä¸ƒAndæ„¿',
    appSubtitle: 'ç»å¯¹ç§å¯†çš„ä¸€å¯¹ä¸€èŠå¤©ç©ºé—´',
    loveStartDate: new Date(2024, 0, 1), // 2024å¹´1æœˆ1æ—¥
    moodChangeFrequency: 600000 // å¿ƒæƒ…å˜åŒ–é¢‘ç‡ï¼ˆ10åˆ†é’Ÿï¼‰
  },
  
  // èƒŒæ™¯è®¾ç½®
  backgroundSettings: {
    backgroundImage: null, // èƒŒæ™¯å›¾ç‰‡URL
    backgroundType: 'default', // èƒŒæ™¯ç±»å‹ï¼šdefault, preset, custom
    opacity: 100 // èƒŒæ™¯é€æ˜åº¦ 0-100
  },
  
  // å¡”ç½—ç‰Œè®¾ç½®
  tarotSettings: {
    enabled: false, // æ˜¯å¦å¯ç”¨å¡”ç½—ç‰Œæ¨¡å¼
    drawCount: 1, // æ¯æ¬¡æŠ½å–æ•°é‡ 1-15
    // é»˜è®¤å¡”ç½—ç‰Œå­—å¡åº“ï¼ˆ78å¼ å®Œæ•´å¡”ç½—ç‰Œï¼‰
    defaultPhrases: [],
    // ç”¨æˆ·è‡ªå®šä¹‰å¡”ç½—ç‰Œå­—å¡åº“
    customPhrases: [],
    // å½“å‰ä½¿ç”¨çš„å­—å¡åº“ï¼ˆé»˜è®¤+è‡ªå®šä¹‰ï¼‰
    phrases: [],
    // å·²æŠ½å–çš„ç‰Œåè®°å½•ï¼ˆç”¨äºåŒç‰Œæ­£é€†ä½ä¸é‡å¤è§„åˆ™ï¼‰
    drawnCards: new Set()
  },
  
  // é€šä¿¡è®¾ç½® - æ–°å¢ä¸»åŠ¨å‘¼å«è®¾ç½®
  communicationSettings: {
    autoAcceptCalls: true,
    autoAcceptVideos: true,
    todayCalls: 0,
    todayVideos: 0,
    totalCallTime: 0, // åˆ†é’Ÿ
    totalVideoTime: 0, // åˆ†é’Ÿ
    todayIncomingCalls: 0, // ä»Šæ—¥å¯¹æ–¹ä¸»åŠ¨å‘¼å«æ¬¡æ•°
    
    // æ–°å¢ï¼šä¸»åŠ¨å‘¼å«è®¾ç½®
    activeCallSettings: {
      enabled: true,           // æ€»å¼€å…³ï¼ˆæ€»ä½“é¢‘ç‡>0æ—¶å¼€å¯ï¼‰
      overallFrequency: 30,    // æ€»ä½“é¢‘ç‡ç™¾åˆ†æ¯” 0-100
      callPreference: 50,      // ç”µè¯åå¥½ç™¾åˆ†æ¯” 0-100 (è§†é¢‘=100-ç”µè¯)
      
      // é¢„è®¾æ¨¡å¼
      presetMode: 'custom',    // é¢„è®¾æ¨¡å¼ï¼šquiet, daily, intimate, custom
      
      // æ—¶é—´æ§åˆ¶ï¼ˆåˆ†é’Ÿï¼‰
      minInterval: 15,         // æœ€å°é—´éš”
      maxInterval: 45,         // æœ€å¤§é—´éš”
      
      // æ™ºèƒ½è§„åˆ™
      respectBusyStatus: true, // é¿å¼€å¿™ç¢ŒçŠ¶æ€
      timeSensitivity: true,   // æ—¶é—´æ•æ„Ÿï¼ˆå¤œé—´é™ä½ï¼‰
      adaptToActivity: true    // é€‚åº”èŠå¤©æ´»è·ƒåº¦
    },
    
    // å‘¼å«ç»Ÿè®¡
    outgoingCallStats: {
      attemptedToday: 0,       // ä»Šæ—¥å°è¯•å‘¼å«æ¬¡æ•°
      succeededToday: 0,       // ä»Šæ—¥æˆåŠŸæ¥é€šæ¬¡æ•°
      averageInterval: 25      // å¹³å‡é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
    }
  },
  
  // åˆå§‹å›å¤è¯æ¡
  responsePhrases: [
    "å¥½çš„ï¼Œæ˜ç™½äº†",
    "è¿™å¾ˆæœ‰è¶£",
    "ç»§ç»­èŠå§",
    "è®©æˆ‘æƒ³æƒ³",
    "å¾ˆæœ‰æ„æ€çš„è§‚ç‚¹",
    "æˆ‘ä¸å¤ªç¡®å®š",
    "å¯ä»¥è¯¦ç»†è¯´è¯´å—",
    "æˆ‘åŒæ„",
    "è¿™æ˜¯ä¸ªå¥½é—®é¢˜",
    "è°¢è°¢åˆ†äº«"
  ],
  
  // è¡¨æƒ…åŒ…å­˜å‚¨
  stickers: [],
  
  // å½“å‰å¯¹è¯
  messages: [],
  
  // å¯¹æ–¹æ˜¯å¦æ­£åœ¨è¾“å…¥
  isTyping: false,
  
  // å½“å‰ç¼–è¾‘çš„ç”¨æˆ·ç±»å‹
  editingUserType: null,
  
  // çŠ¶æ€åˆ‡æ¢å®šæ—¶å™¨
  statusTimer: null,
  
  // å¿ƒæƒ…å˜åŒ–å®šæ—¶å™¨
  moodTimer: null,
  
  // ä¸»åŠ¨å‘é€å®šæ—¶å™¨
  autoSendTimer: null,
  
  // ä¸»åŠ¨å‘¼å«å®šæ—¶å™¨
  activeCallTimer: null,
  
  // æ˜¯å¦æ­£åœ¨ç­‰å¾…å¯¹æ–¹å›å¤
  waitingForReply: false,
  
  // æ‹çˆ±å¤©æ•°
  loveDays: 0,
  
  // å·²è¯»ä¸å›æ¶ˆæ¯IDè®°å½•
  readNoReplyMessageIds: [],
  
  // å½“å‰å¼•ç”¨çš„æ¶ˆæ¯
  quotedMessage: null,
  
  // é€šè¯ç›¸å…³
  activeCall: null,
  activeVideo: null,
  callTimer: null,
  callStartTime: null,
  callDuration: 0,
  
  // ä»Šæ—¥æ—¥æœŸï¼ˆç”¨äºé‡ç½®æ¯æ—¥ç»Ÿè®¡ï¼‰
  todayDate: new Date().toDateString(),
  
  // å½“å‰æ˜¾ç¤ºçš„æ¶ˆæ¯æ“ä½œèœå•
  activeMessageActions: null
};

// æœ¬åœ°å­˜å‚¨é”®å
const STORAGE_KEYS = {
  // ä¸»è¦æ•°æ®å­˜å‚¨é”®
  APP_DATA: 'seven_and_wish_complete_data_v7',
  // å¤‡ä»½å­˜å‚¨é”®ï¼ˆä»¥é˜²ä¸»è¦æ•°æ®æŸåï¼‰
  BACKUP_DATA: 'seven_and_wish_backup_data_v7',
  // ç‰ˆæœ¬æ§åˆ¶
  DATA_VERSION: 'seven_and_wish_data_version_v7',
  // æœ€åä¿å­˜æ—¶é—´
  LAST_SAVE_TIME: 'seven_and_wish_last_save_v7'
};

// æ•°æ®ç‰ˆæœ¬
const DATA_VERSION = '7.0';

// é»˜è®¤å¡”ç½—ç‰Œå­—å¡åº“ - 78å¼ å®Œæ•´å¡”ç½—ç‰Œ
const DEFAULT_TAROT_CARDS = [
  // 22å¼ å¤§é˜¿å¡çº³
  "æ„šäºº æ­£ä½", "æ„šäºº é€†ä½",
  "é­”æœ¯å¸ˆ æ­£ä½", "é­”æœ¯å¸ˆ é€†ä½",
  "å¥³ç¥­å¸ æ­£ä½", "å¥³ç¥­å¸ é€†ä½",
  "å¥³çš‡ æ­£ä½", "å¥³çš‡ é€†ä½",
  "çš‡å¸ æ­£ä½", "çš‡å¸ é€†ä½",
  "æ•™çš‡ æ­£ä½", "æ•™çš‡ é€†ä½",
  "æ‹äºº æ­£ä½", "æ‹äºº é€†ä½",
  "æˆ˜è½¦ æ­£ä½", "æˆ˜è½¦ é€†ä½",
  "åŠ›é‡ æ­£ä½", "åŠ›é‡ é€†ä½",
  "éšå£« æ­£ä½", "éšå£« é€†ä½",
  "å‘½è¿ä¹‹è½® æ­£ä½", "å‘½è¿ä¹‹è½® é€†ä½",
  "æ­£ä¹‰ æ­£ä½", "æ­£ä¹‰ é€†ä½",
  "å€’åŠäºº æ­£ä½", "å€’åŠäºº é€†ä½",
  "æ­»ç¥ æ­£ä½", "æ­»ç¥ é€†ä½",
  "èŠ‚åˆ¶ æ­£ä½", "èŠ‚åˆ¶ é€†ä½",
  "æ¶é­” æ­£ä½", "æ¶é­” é€†ä½",
  "é«˜å¡” æ­£ä½", "é«˜å¡” é€†ä½",
  "æ˜Ÿæ˜Ÿ æ­£ä½", "æ˜Ÿæ˜Ÿ é€†ä½",
  "æœˆäº® æ­£ä½", "æœˆäº® é€†ä½",
  "å¤ªé˜³ æ­£ä½", "å¤ªé˜³ é€†ä½",
  "å®¡åˆ¤ æ­£ä½", "å®¡åˆ¤ é€†ä½",
  "ä¸–ç•Œ æ­£ä½", "ä¸–ç•Œ é€†ä½",
  
  // æƒæ–ç‰Œç»„
  "æƒæ–ä¸€ æ­£ä½", "æƒæ–ä¸€ é€†ä½",
  "æƒæ–äºŒ æ­£ä½", "æƒæ–äºŒ é€†ä½",
  "æƒæ–ä¸‰ æ­£ä½", "æƒæ–ä¸‰ é€†ä½",
  "æƒæ–å›› æ­£ä½", "æƒæ–å›› é€†ä½",
  "æƒæ–äº” æ­£ä½", "æƒæ–äº” é€†ä½",
  "æƒæ–å…­ æ­£ä½", "æƒæ–å…­ é€†ä½",
  "æƒæ–ä¸ƒ æ­£ä½", "æƒæ–ä¸ƒ é€†ä½",
  "æƒæ–å…« æ­£ä½", "æƒæ–å…« é€†ä½",
  "æƒæ–ä¹ æ­£ä½", "æƒæ–ä¹ é€†ä½",
  "æƒæ–å æ­£ä½", "æƒæ–å é€†ä½",
  "æƒæ–ä¾ä» æ­£ä½", "æƒæ–ä¾ä» é€†ä½",
  "æƒæ–éª‘å£« æ­£ä½", "æƒæ–éª‘å£« é€†ä½",
  "æƒæ–çš‡å æ­£ä½", "æƒæ–çš‡å é€†ä½",
  "æƒæ–å›½ç‹ æ­£ä½", "æƒæ–å›½ç‹ é€†ä½",
  
  // åœ£æ¯ç‰Œç»„
  "åœ£æ¯ä¸€ æ­£ä½", "åœ£æ¯ä¸€ é€†ä½",
  "åœ£æ¯äºŒ æ­£ä½", "åœ£æ¯äºŒ é€†ä½",
  "åœ£æ¯ä¸‰ æ­£ä½", "åœ£æ¯ä¸‰ é€†ä½",
  "åœ£æ¯å›› æ­£ä½", "åœ£æ¯å›› é€†ä½",
  "åœ£æ¯äº” æ­£ä½", "åœ£æ¯äº” é€†ä½",
  "åœ£æ¯å…­ æ­£ä½", "åœ£æ¯å…­ é€†ä½",
  "åœ£æ¯ä¸ƒ æ­£ä½", "åœ£æ¯ä¸ƒ é€†ä½",
  "åœ£æ¯å…« æ­£ä½", "åœ£æ¯å…« é€†ä½",
  "åœ£æ¯ä¹ æ­£ä½", "åœ£æ¯ä¹ é€†ä½",
  "åœ£æ¯å æ­£ä½", "åœ£æ¯å é€†ä½",
  "åœ£æ¯ä¾ä» æ­£ä½", "åœ£æ¯ä¾ä» é€†ä½",
  "åœ£æ¯éª‘å£« æ­£ä½", "åœ£æ¯éª‘å£« é€†ä½",
  "åœ£æ¯çš‡å æ­£ä½", "åœ£æ¯çš‡å é€†ä½",
  "åœ£æ¯å›½ç‹ æ­£ä½", "åœ£æ¯å›½ç‹ é€†ä½",
  
  // å®å‰‘ç‰Œç»„
  "å®å‰‘ä¸€ æ­£ä½", "å®å‰‘ä¸€ é€†ä½",
  "å®å‰‘äºŒ æ­£ä½", "å®å‰‘äºŒ é€†ä½",
  "å®å‰‘ä¸‰ æ­£ä½", "å®å‰‘ä¸‰ é€†ä½",
  "å®å‰‘å›› æ­£ä½", "å®å‰‘å›› é€†ä½",
  "å®å‰‘äº” æ­£ä½", "å®å‰‘äº” é€†ä½",
  "å®å‰‘å…­ æ­£ä½", "å®å‰‘å…­ é€†ä½",
  "å®å‰‘ä¸ƒ æ­£ä½", "å®å‰‘ä¸ƒ é€†ä½",
  "å®å‰‘å…« æ­£ä½", "å®å‰‘å…« é€†ä½",
  "å®å‰‘ä¹ æ­£ä½", "å®å‰‘ä¹ é€†ä½",
  "å®å‰‘å æ­£ä½", "å®å‰‘å é€†ä½",
  "å®å‰‘ä¾ä» æ­£ä½", "å®å‰‘ä¾ä» é€†ä½",
  "å®å‰‘éª‘å£« æ­£ä½", "å®å‰‘éª‘å£« é€†ä½",
  "å®å‰‘çš‡å æ­£ä½", "å®å‰‘çš‡å é€†ä½",
  "å®å‰‘å›½ç‹ æ­£ä½", "å®å‰‘å›½ç‹ é€†ä½",
  
  // æ˜Ÿå¸ç‰Œç»„
  "æ˜Ÿå¸ä¸€ æ­£ä½", "æ˜Ÿå¸ä¸€ é€†ä½",
  "æ˜Ÿå¸äºŒ æ­£ä½", "æ˜Ÿå¸äºŒ é€†ä½",
  "æ˜Ÿå¸ä¸‰ æ­£ä½", "æ˜Ÿå¸ä¸‰ é€†ä½",
  "æ˜Ÿå¸å›› æ­£ä½", "æ˜Ÿå¸å›› é€†ä½",
  "æ˜Ÿå¸äº” æ­£ä½", "æ˜Ÿå¸äº” é€†ä½",
  "æ˜Ÿå¸å…­ æ­£ä½", "æ˜Ÿå¸å…­ é€†ä½",
  "æ˜Ÿå¸ä¸ƒ æ­£ä½", "æ˜Ÿå¸ä¸ƒ é€†ä½",
  "æ˜Ÿå¸å…« æ­£ä½", "æ˜Ÿå¸å…« é€†ä½",
  "æ˜Ÿå¸ä¹ æ­£ä½", "æ˜Ÿå¸ä¹ é€†ä½",
  "æ˜Ÿå¸å æ­£ä½", "æ˜Ÿå¸å é€†ä½",
  "æ˜Ÿå¸ä¾ä» æ­£ä½", "æ˜Ÿå¸ä¾ä» é€†ä½",
  "æ˜Ÿå¸éª‘å£« æ­£ä½", "æ˜Ÿå¸éª‘å£« é€†ä½",
  "æ˜Ÿå¸çš‡å æ­£ä½", "æ˜Ÿå¸çš‡å é€†ä½",
  "æ˜Ÿå¸å›½ç‹ æ­£ä½", "æ˜Ÿå¸å›½ç‹ é€†ä½"
];

// DOMå…ƒç´ 
const messagesArea = document.getElementById('messagesArea');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const continueButton = document.getElementById('continueButton');
const uploadImageButton = document.getElementById('uploadImageButton');
const imageUpload = document.getElementById('imageUpload');
const settingsToggle = document.getElementById('settingsToggle');
const settingsPanel = document.getElementById('settingsPanel');
const settingsOverlay = document.getElementById('settingsOverlay');
const closeSettings = document.getElementById('closeSettings');
const stickerPreview = document.getElementById('stickerPreview');
const stickerUpload = document.getElementById('stickerUpload');
const addStickerBtn = document.getElementById('addStickerBtn');
const addStickerPlaceholder = document.getElementById('addStickerPlaceholder');
const stickerCount = document.getElementById('stickerCount');
const phrasesTextarea = document.getElementById('phrasesTextarea');
const phraseCount = document.getElementById('phraseCount');
const savePhrasesBtn = document.getElementById('savePhrasesBtn');
const tabButtons = document.querySelectorAll('.tab-button');
const tabContents = document.querySelectorAll('.tab-content');
const typingIndicator = document.getElementById('typingIndicator');

// å¡”ç½—ç‰Œç›¸å…³DOM
const tarotModeToggle = document.getElementById('tarotModeToggle');
const tarotNumberSelector = document.getElementById('tarotNumberSelector');
const tarotCountValue = document.getElementById('tarotCountValue');
const tarotTextarea = document.getElementById('tarotTextarea');
const tarotPhraseCount = document.getElementById('tarotPhraseCount');
const saveTarotBtn = document.getElementById('saveTarotBtn');
const tarotStatus = document.getElementById('tarotStatus');
const loadDefaultTarotBtn = document.getElementById('loadDefaultTarotBtn');
const clearTarotBtn = document.getElementById('clearTarotBtn');

// èƒŒæ™¯è®¾ç½®ç›¸å…³DOM
const backgroundContainer = document.getElementById('backgroundContainer');
const backgroundPreview = document.getElementById('backgroundPreview');
const backgroundUpload = document.getElementById('backgroundUpload');
const uploadBackgroundOption = document.getElementById('uploadBackgroundOption');
const removeBackgroundBtn = document.getElementById('removeBackgroundBtn');
const backgroundOpacitySlider = document.getElementById('backgroundOpacitySlider');
const backgroundOpacityValue = document.getElementById('backgroundOpacityValue');
const saveBackgroundBtn = document.getElementById('saveBackgroundBtn');

// å‘é€è®¾ç½®ç›¸å…³DOM
const stickerRatioSlider = document.getElementById('stickerRatioSlider');
const phraseRatioSlider = document.getElementById('phraseRatioSlider');
const stickerRatioValue = document.getElementById('stickerRatioValue');
const phraseRatioValue = document.getElementById('phraseRatioValue');
const maxMessageCount = document.getElementById('maxMessageCount');
const autoSendFrequency = document.getElementById('autoSendFrequency');

// å¤–è§‚è®¾ç½®ç›¸å…³DOM
const appTitleInput = document.getElementById('appTitleInput');
const appSubtitleInput = document.getElementById('appSubtitleInput');
const loveYear = document.getElementById('loveYear');
const loveMonth = document.getElementById('loveMonth');
const loveDay = document.getElementById('loveDay');
const moodChangeFrequency = document.getElementById('moodChangeFrequency');
const saveAppearanceBtn = document.getElementById('saveAppearanceBtn');

// é€šä¿¡è®¾ç½®ç›¸å…³DOM
const startCallButton = document.getElementById('startCallButton');
const startVideoButton = document.getElementById('startVideoButton');
const autoAcceptCalls = document.getElementById('autoAcceptCalls');
const autoAcceptVideos = document.getElementById('autoAcceptVideos');
const todayCalls = document.getElementById('todayCalls');
const totalCallTime = document.getElementById('totalCallTime');
const todayVideos = document.getElementById('todayVideos');
const totalVideoTime = document.getElementById('totalVideoTime');
const todayIncomingCalls = document.getElementById('todayIncomingCalls');
const saveCommunicationBtn = document.getElementById('saveCommunicationBtn');

// æ–°å¢ï¼šä¸»åŠ¨å‘¼å«è®¾ç½®ç›¸å…³DOM
const overallFrequencySlider = document.getElementById('overallFrequencySlider');
const overallFrequencyValue = document.getElementById('overallFrequencyValue');
const callPreferenceSlider = document.getElementById('callPreferenceSlider');
const callPreferenceValue = document.getElementById('callPreferenceValue');
const presetButtons = document.querySelectorAll('.preset-btn');
const activeCallPreview = document.getElementById('activeCallPreview');
const previewFrequency = document.getElementById('previewFrequency');
const previewType = document.getElementById('previewType');
const previewDaily = document.getElementById('previewDaily');
const previewNext = document.getElementById('previewNext');

// äº‘å¯¼å…¥ç›¸å…³DOM
const cloudImportTextarea = document.getElementById('cloudImportTextarea');
const importCloudBtn = document.getElementById('importCloudBtn');
const clearCloudBtn = document.getElementById('clearCloudBtn');
const cloudFileUpload = document.getElementById('cloudFileUpload');
const importFileBtn = document.getElementById('importFileBtn');

// å¯¼å‡ºç›¸å…³DOM
const exportMessages = document.getElementById('exportMessages');
const exportSettings = document.getElementById('exportSettings');
const exportStickers = document.getElementById('exportStickers');
const exportPhrases = document.getElementById('exportPhrases');
const exportTarot = document.getElementById('exportTarot');
const exportBackground = document.getElementById('exportBackground');
const exportCommunication = document.getElementById('exportCommunication');
const exportTxtBtn = document.getElementById('exportTxtBtn');
const exportJsonBtn = document.getElementById('exportJsonBtn');
const exportHtmlBtn = document.getElementById('exportHtmlBtn');
const exportAllBtn = document.getElementById('exportAllBtn');

// ç”¨æˆ·ç›¸å…³DOM
const selfUserInfo = document.getElementById('selfUserInfo');
const otherUserInfo = document.getElementById('otherUserInfo');
const selfAvatar = document.getElementById('selfAvatar');
const otherAvatar = document.getElementById('otherAvatar');
const selfNickname = document.getElementById('selfNickname');
const otherNickname = document.getElementById('otherNickname');
const otherStatusIndicator = document.getElementById('otherStatusIndicator');
const otherStatusText = document.getElementById('otherStatusText');
const selfStatusText = document.getElementById('selfStatusText');
const otherMoodValue = document.getElementById('otherMoodValue');

// åº”ç”¨æ ‡é¢˜ç›¸å…³DOM
const appTitle = document.getElementById('appTitle');
const appSubtitle = document.getElementById('appSubtitle');
const loveDaysElement = document.getElementById('loveDays');
const loveDaysCount = document.getElementById('loveDaysCount');

// æ¨¡æ€æ¡†ç›¸å…³DOM
const userModal = document.getElementById('userModal');
const modalTitle = document.getElementById('modalTitle');
const avatarPreview = document.getElementById('avatarPreview');
const modalNicknameInput = document.getElementById('modalNicknameInput');
const modalAvatarUpload = document.getElementById('modalAvatarUpload');
const uploadAvatarBtn = document.getElementById('uploadAvatarBtn');
const cancelEditBtn = document.getElementById('cancelEditBtn');
const saveUserInfoBtn = document.getElementById('saveUserInfoBtn');

// é¢„è®¾æ¨¡å¼é…ç½®
const PRESET_MODES = {
  quiet: {
    name: 'å®‰é™æ¨¡å¼',
    overallFrequency: 10,
    callPreference: 30,
    minInterval: 45,
    maxInterval: 120,
    description: 'ä½é¢‘é€šè¯ï¼Œåå¥½æ–‡å­—æ²Ÿé€š'
  },
  daily: {
    name: 'æ—¥å¸¸æ¨¡å¼',
    overallFrequency: 30,
    callPreference: 50,
    minInterval: 20,
    maxInterval: 60,
    description: 'é€‚ä¸­é¢‘ç‡ï¼Œå‡è¡¡åˆ†é…'
  },
  intimate: {
    name: 'äº²å¯†æ¨¡å¼',
    overallFrequency: 50,
    callPreference: 70,
    minInterval: 10,
    maxInterval: 30,
    description: 'é«˜é¢‘é€šè¯ï¼Œåå¥½è§†é¢‘äº¤æµ'
  },
  custom: {
    name: 'è‡ªå®šä¹‰',
    description: 'æ‰‹åŠ¨è°ƒæ•´æ‰€æœ‰è®¾ç½®'
  }
};

// ============================
// å¡”ç½—ç‰Œç›¸å…³åŠŸèƒ½
// ============================

// è§£æå¡”ç½—ç‰Œå­—å¡ï¼Œæå–ç‰Œåå’Œæ­£é€†ä½
function parseTarotCard(phrase) {
  // ç§»é™¤å¤šä½™ç©ºæ ¼
  const trimmed = phrase.trim();
  
  // å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å„ç§æ ¼å¼
  const patterns = [
    // "æ„šäºº æ­£ä½"
    /^([^æ­£é€†ä½]+)(æ­£ä½|é€†ä½)$/,
    // "æ­£ä½Â·æ„šè€…"
    /^(æ­£ä½|é€†ä½)[Â·\-](.+)$/,
    // "æ­£ä½-å¥³ç¥­å¸"
    /^(æ­£ä½|é€†ä½)[\-](.+)$/,
    // "æ„šè€… - æ­£ä½"
    /^(.+)[\-]\s*(æ­£ä½|é€†ä½)$/,
    // "æ„šè€… (æ­£ä½)"
    /^(.+)\s*[\(ï¼ˆ](æ­£ä½|é€†ä½)[\)ï¼‰]$/,
    // "æ„šè€… - æè¿° (æ­£ä½)"
    /^(.+?)[\-].*?[\(ï¼ˆ](æ­£ä½|é€†ä½)[\)ï¼‰]$/,
    // "æ„šè€… - æè¿° - æ­£ä½"
    /^(.+?)[\-].*?[\-]\s*(æ­£ä½|é€†ä½)$/
  ];
  
  for (const pattern of patterns) {
    const match = trimmed.match(pattern);
    if (match) {
      // æå–ç‰Œåå’Œæ­£é€†ä½
      let cardName = '';
      let position = '';
      
      if (pattern.toString().includes('[^æ­£é€†ä½]+')) {
        // ç¬¬ä¸€ç§æ¨¡å¼ï¼š"ç‰Œå æ­£é€†ä½"
        cardName = match[1].trim();
        position = match[2].trim();
      } else if (pattern.toString().includes('^(æ­£ä½|é€†ä½)')) {
        // ç¬¬äºŒç§æ¨¡å¼ï¼š"æ­£é€†ä½ ç‰Œå"
        position = match[1].trim();
        cardName = match[2].trim();
      } else {
        // å…¶ä»–æ¨¡å¼
        cardName = match[1].trim();
        position = match[2].trim();
      }
      
      // æ¸…ç†ç‰Œåä¸­çš„å¤šä½™å­—ç¬¦
      cardName = cardName.replace(/^[Â·\-]\s*|\s*[Â·\-]$/g, '').trim();
      
      return {
        original: trimmed,
        cardName: cardName,
        position: position,
        isValid: true
      };
    }
  }
  
  // å¦‚æœæ— æ³•è§£æï¼Œè¿”å›åŸå§‹æ–‡æœ¬ä½œä¸ºç‰Œå
  return {
    original: trimmed,
    cardName: trimmed,
    position: '',
    isValid: false
  };
}

// æ£€æŸ¥æ˜¯å¦å¯ä»¥æŠ½å–è¿™å¼ ç‰Œï¼ˆåŒç‰Œæ­£é€†ä½ä¸é‡å¤è§„åˆ™ï¼‰
function canDrawCard(parsedCard) {
  if (!parsedCard.isValid || !parsedCard.position) {
    // æ— æ³•è§£ææˆ–æ²¡æœ‰æ­£é€†ä½çš„ç‰Œï¼Œæ€»æ˜¯å¯ä»¥æŠ½å–
    return true;
  }
  
  // æ£€æŸ¥è¿™å¼ ç‰Œçš„æ­£ä½æˆ–é€†ä½æ˜¯å¦å·²ç»è¢«æŠ½å–è¿‡
  const cardKey = parsedCard.cardName;
  return !appData.tarotSettings.drawnCards.has(cardKey);
}

// æ ‡è®°ç‰Œä¸ºå·²æŠ½å–
function markCardAsDrawn(parsedCard) {
  if (parsedCard.isValid && parsedCard.cardName) {
    appData.tarotSettings.drawnCards.add(parsedCard.cardName);
  }
}

// é‡ç½®å·²æŠ½å–çš„ç‰Œè®°å½•
function resetDrawnCards() {
  appData.tarotSettings.drawnCards.clear();
}

// åˆå¹¶é»˜è®¤å’Œè‡ªå®šä¹‰å¡”ç½—ç‰Œå­—å¡
function mergeTarotPhrases() {
  appData.tarotSettings.phrases = [
    ...appData.tarotSettings.defaultPhrases,
    ...appData.tarotSettings.customPhrases
  ];
}

// åŠ è½½é»˜è®¤å¡”ç½—ç‰Œ
function loadDefaultTarotCards() {
  appData.tarotSettings.defaultPhrases = [...DEFAULT_TAROT_CARDS];
  mergeTarotPhrases();
  
  // æ›´æ–°UIæ˜¾ç¤º
  updateTarotTextarea();
  updateTarotPhraseCount();
  
  showNotification('å·²åŠ è½½78å¼ é»˜è®¤å¡”ç½—ç‰Œï¼ˆ22å¼ å¤§é˜¿å¡çº³ + 56å¼ å°é˜¿å¡çº³ï¼‰');
  
  // é‡ç½®å·²æŠ½å–è®°å½•
  resetDrawnCards();
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// æ¸…ç©ºå¡”ç½—ç‰Œåº“
function clearTarotCards() {
  if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¡”ç½—ç‰Œå­—å¡å—ï¼Ÿ\nï¼ˆåŒ…æ‹¬é»˜è®¤ç‰Œå’Œè‡ªå®šä¹‰ç‰Œï¼‰')) {
    appData.tarotSettings.defaultPhrases = [];
    appData.tarotSettings.customPhrases = [];
    appData.tarotSettings.phrases = [];
    
    // æ›´æ–°UIæ˜¾ç¤º
    updateTarotTextarea();
    updateTarotPhraseCount();
    
    // é‡ç½®å·²æŠ½å–è®°å½•
    resetDrawnCards();
    
    showNotification('å·²æ¸…ç©ºæ‰€æœ‰å¡”ç½—ç‰Œå­—å¡');
    
    // ä¿å­˜æ•°æ®
    saveCompleteDataToLocalStorage();
  }
}

// æ›´æ–°å¡”ç½—ç‰Œæ–‡æœ¬æ¡†æ˜¾ç¤º
function updateTarotTextarea() {
  // æ˜¾ç¤ºåˆå¹¶åçš„æ‰€æœ‰å­—å¡
  tarotTextarea.value = appData.tarotSettings.phrases.join('\n');
}

// ============================
// åˆå§‹åŒ–åº”ç”¨
// ============================

// åˆå§‹åŒ–åº”ç”¨
function initApp() {
  console.log('åˆå§‹åŒ–åº”ç”¨...');
  
  // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ‰€æœ‰æ•°æ®
  const loadSuccess = loadCompleteDataFromLocalStorage();
  
  if (!loadSuccess || appData.messages.length === 0) {
    // å¦‚æœæ²¡æœ‰æ•°æ®æˆ–åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
    console.log('ä½¿ç”¨é»˜è®¤æ•°æ®åˆå§‹åŒ–...');
    initializeDefaultData();
  }
  
  // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®æ¯æ—¥ç»Ÿè®¡
  checkResetDailyStats();
  
  // æ‰“å¼€é¡µé¢æ—¶å°†æ‰€æœ‰å¯¹æ–¹å‘é€çš„æ¶ˆæ¯æ ‡è®°ä¸ºå·²è¯»
  markOtherMessagesAsRead();
  
  // è®¡ç®—æ‹çˆ±å¤©æ•°
  calculateLoveDays();
  
  // æ¸²æŸ“æ‰€æœ‰ç•Œé¢
  renderAllUI();
  
  // å¯åŠ¨æ‰€æœ‰å®šæ—¶å™¨
  startAllTimers();
  
  // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
  setupEventListeners();
  
  // æ˜¾ç¤ºåŠ è½½æˆåŠŸé€šçŸ¥
  showNotification('èŠå¤©è®°å½•å·²åŠ è½½');
  
  console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆï¼Œå…±åŠ è½½', appData.messages.length, 'æ¡æ¶ˆæ¯');
}

// ä»æœ¬åœ°å­˜å‚¨åŠ è½½å®Œæ•´æ•°æ®
function loadCompleteDataFromLocalStorage() {
  try {
    console.log('å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®...');
    
    // æ£€æŸ¥æ•°æ®ç‰ˆæœ¬
    const savedVersion = localStorage.getItem(STORAGE_KEYS.DATA_VERSION);
    if (savedVersion !== DATA_VERSION) {
      console.log('æ•°æ®ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œå¯èƒ½éœ€è¦è¿ç§»æˆ–ä½¿ç”¨é»˜è®¤æ•°æ®');
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ•°æ®è¿ç§»é€»è¾‘
    }
    
    // å°è¯•åŠ è½½ä¸»è¦æ•°æ®
    const savedData = localStorage.getItem(STORAGE_KEYS.APP_DATA);
    if (!savedData) {
      console.log('æœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰æ‰¾åˆ°ä¸»è¦æ•°æ®');
      return false;
    }
    
    const parsedData = JSON.parse(savedData);
    
    // éªŒè¯æ•°æ®å®Œæ•´æ€§
    if (!parsedData || typeof parsedData !== 'object') {
      console.log('æ•°æ®æ ¼å¼æ— æ•ˆ');
      return false;
    }
    
    // æ¢å¤æ‰€æœ‰æ•°æ®
    if (parsedData.selfInfo) appData.selfInfo = parsedData.selfInfo;
    if (parsedData.otherInfo) appData.otherInfo = parsedData.otherInfo;
    if (parsedData.sendSettings) appData.sendSettings = parsedData.sendSettings;
    if (parsedData.appearanceSettings) appData.appearanceSettings = parsedData.appearanceSettings;
    if (parsedData.backgroundSettings) appData.backgroundSettings = parsedData.backgroundSettings;
    if (parsedData.tarotSettings) appData.tarotSettings = parsedData.tarotSettings;
    if (parsedData.communicationSettings) appData.communicationSettings = parsedData.communicationSettings;
    if (parsedData.responsePhrases) appData.responsePhrases = parsedData.responsePhrases;
    if (parsedData.messages) appData.messages = parsedData.messages;
    if (parsedData.stickers) appData.stickers = parsedData.stickers;
    if (parsedData.loveDays) appData.loveDays = parsedData.loveDays;
    if (parsedData.readNoReplyMessageIds) appData.readNoReplyMessageIds = parsedData.readNoReplyMessageIds;
    if (parsedData.todayDate) appData.todayDate = parsedData.todayDate;
    
    // æ¢å¤æ—¥æœŸå¯¹è±¡
    if (parsedData.appearanceSettings && parsedData.appearanceSettings.loveStartDate) {
      appData.appearanceSettings.loveStartDate = new Date(parsedData.appearanceSettings.loveStartDate);
    }
    
    // ç¡®ä¿å¤´åƒæ–‡æœ¬ä¸ºç©ºå­—ç¬¦ä¸²
    if (!appData.selfInfo.avatarText) {
      appData.selfInfo.avatarText = '';
    }
    if (!appData.otherInfo.avatarText) {
      appData.otherInfo.avatarText = '';
    }
    
    // ç¡®ä¿å¡”ç½—ç‰Œè®¾ç½®å­˜åœ¨ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
    if (!appData.tarotSettings.defaultPhrases) {
      appData.tarotSettings.defaultPhrases = [];
    }
    if (!appData.tarotSettings.customPhrases) {
      appData.tarotSettings.customPhrases = [];
    }
    if (!appData.tarotSettings.drawnCards || !(appData.tarotSettings.drawnCards instanceof Set)) {
      appData.tarotSettings.drawnCards = new Set();
    }
    
    // åˆå¹¶å¡”ç½—ç‰Œå­—å¡
    if (appData.tarotSettings.phrases && appData.tarotSettings.phrases.length > 0) {
      // å¦‚æœä»æ—§ç‰ˆæœ¬åŠ è½½ï¼Œå°†æ‰€æœ‰å­—å¡è§†ä¸ºè‡ªå®šä¹‰å­—å¡
      appData.tarotSettings.customPhrases = [...appData.tarotSettings.phrases];
      appData.tarotSettings.defaultPhrases = [];
    }
    
    // åˆå¹¶å­—å¡
    mergeTarotPhrases();
    
    // ç¡®ä¿ä¸»åŠ¨å‘¼å«è®¾ç½®å­˜åœ¨ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
    if (!appData.communicationSettings.activeCallSettings) {
      appData.communicationSettings.activeCallSettings = {
        enabled: true,
        overallFrequency: 30,
        callPreference: 50,
        presetMode: 'custom',
        minInterval: 15,
        maxInterval: 45,
        respectBusyStatus: true,
        timeSensitivity: true,
        adaptToActivity: true
      };
    }
    
    if (!appData.communicationSettings.outgoingCallStats) {
      appData.communicationSettings.outgoingCallStats = {
        attemptedToday: 0,
        succeededToday: 0,
        averageInterval: 25
      };
    }
    
    if (appData.communicationSettings.todayIncomingCalls === undefined) {
      appData.communicationSettings.todayIncomingCalls = 0;
    }
    
    console.log('æ•°æ®åŠ è½½æˆåŠŸ:', {
      æ¶ˆæ¯æ•°é‡: appData.messages.length,
      è¡¨æƒ…åŒ…æ•°é‡: appData.stickers.length,
      è¯æ¡æ•°é‡: appData.responsePhrases.length,
      å¡”ç½—ç‰Œå­—å¡æ•°é‡: appData.tarotSettings.phrases.length,
      é»˜è®¤å¡”ç½—ç‰Œ: appData.tarotSettings.defaultPhrases.length,
      è‡ªå®šä¹‰å¡”ç½—ç‰Œ: appData.tarotSettings.customPhrases.length,
      å¡”ç½—ç‰Œæ¨¡å¼: appData.tarotSettings.enabled ? 'å¼€å¯' : 'å…³é—­',
      ç”¨æˆ·æ˜µç§°: { è‡ªå·±: appData.selfInfo.nickname, å¯¹æ–¹: appData.otherInfo.nickname },
      ä¸»åŠ¨å‘¼å«è®¾ç½®: appData.communicationSettings.activeCallSettings
    });
    
    return true;
    
  } catch (error) {
    console.error('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®å¤±è´¥:', error);
    
    // å°è¯•åŠ è½½å¤‡ä»½æ•°æ®
    try {
      const backupData = localStorage.getItem(STORAGE_KEYS.BACKUP_DATA);
      if (backupData) {
        console.log('å°è¯•åŠ è½½å¤‡ä»½æ•°æ®...');
        const parsedBackup = JSON.parse(backupData);
        
        // æ¢å¤å¤‡ä»½æ•°æ®
        if (parsedBackup.selfInfo) appData.selfInfo = parsedBackup.selfInfo;
        if (parsedBackup.otherInfo) appData.otherInfo = parsedBackup.otherInfo;
        if (parsedBackup.messages) appData.messages = parsedBackup.messages;
        
        // ç¡®ä¿å¤´åƒæ–‡æœ¬ä¸ºç©ºå­—ç¬¦ä¸²
        if (!appData.selfInfo.avatarText) {
          appData.selfInfo.avatarText = '';
        }
        if (!appData.otherInfo.avatarText) {
          appData.otherInfo.avatarText = '';
        }
        
        console.log('å¤‡ä»½æ•°æ®åŠ è½½æˆåŠŸ');
        return true;
      }
    } catch (backupError) {
      console.error('å¤‡ä»½æ•°æ®åŠ è½½ä¹Ÿå¤±è´¥:', backupError);
    }
    
    return false;
  }
}

// åˆå§‹åŒ–é»˜è®¤æ•°æ®
function initializeDefaultData() {
  appData.messages = [
    { 
      id: Date.now() - 10000,
      text: "ä½ å¥½ï¼æ¬¢è¿ä½¿ç”¨ä¸ƒAndæ„¿ç§å¯†èŠå¤©ã€‚", 
      sender: "other", 
      time: getFormattedTime(Date.now() - 10000),
      read: true
    },
    { 
      id: Date.now() - 8000,
      text: "ç‚¹å‡»å³ä¸Šè§’çš„é½¿è½®å›¾æ ‡å¯ä»¥ç®¡ç†è¡¨æƒ…åŒ…å’Œå›å¤è¯æ¡ã€‚", 
      sender: "other", 
      time: getFormattedTime(Date.now() - 8000),
      read: true
    },
    { 
      id: Date.now() - 5000,
      text: "å¥½çš„ï¼Œå¼€å§‹èŠå¤©å§ã€‚", 
      sender: "self", 
      time: getFormattedTime(Date.now() - 5000),
      read: false
    }
  ];
  
  // åˆå§‹åŒ–é»˜è®¤å¡”ç½—ç‰Œå­—å¡
  if (appData.tarotSettings.defaultPhrases.length === 0) {
    loadDefaultTarotCards();
  }
}

// æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®æ¯æ—¥ç»Ÿè®¡
function checkResetDailyStats() {
  const currentDate = new Date().toDateString();
  if (appData.todayDate !== currentDate) {
    // æ–°çš„ä¸€å¤©ï¼Œé‡ç½®æ¯æ—¥ç»Ÿè®¡
    appData.communicationSettings.todayCalls = 0;
    appData.communicationSettings.todayVideos = 0;
    appData.communicationSettings.todayIncomingCalls = 0;
    appData.communicationSettings.outgoingCallStats.attemptedToday = 0;
    appData.communicationSettings.outgoingCallStats.succeededToday = 0;
    appData.todayDate = currentDate;
    console.log('å·²é‡ç½®æ¯æ—¥é€šè¯ç»Ÿè®¡');
  }
}

// ä¿å­˜å®Œæ•´æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
function saveCompleteDataToLocalStorage() {
  try {
    console.log('ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨...');
    
    // å‡†å¤‡ä¿å­˜çš„æ•°æ®ï¼ˆSetéœ€è¦è½¬æ¢ä¸ºArrayï¼‰
    const dataToSave = {
      // æ•°æ®ç‰ˆæœ¬
      version: DATA_VERSION,
      
      // ç”¨æˆ·ä¿¡æ¯
      selfInfo: appData.selfInfo,
      otherInfo: appData.otherInfo,
      
      // è®¾ç½®
      sendSettings: appData.sendSettings,
      appearanceSettings: appData.appearanceSettings,
      backgroundSettings: appData.backgroundSettings,
      tarotSettings: {
        enabled: appData.tarotSettings.enabled,
        drawCount: appData.tarotSettings.drawCount,
        defaultPhrases: appData.tarotSettings.defaultPhrases,
        customPhrases: appData.tarotSettings.customPhrases,
        phrases: appData.tarotSettings.phrases,
        drawnCards: Array.from(appData.tarotSettings.drawnCards) // è½¬æ¢Setä¸ºArray
      },
      communicationSettings: appData.communicationSettings,
      
      // å†…å®¹
      responsePhrases: appData.responsePhrases,
      messages: appData.messages,
      stickers: appData.stickers,
      
      // å…¶ä»–æ•°æ®
      loveDays: appData.loveDays,
      readNoReplyMessageIds: appData.readNoReplyMessageIds,
      todayDate: appData.todayDate,
      
      // ä¿å­˜æ—¶é—´
      saveTime: new Date().toISOString()
    };
    
    // ä¿å­˜ä¸»è¦æ•°æ®
    localStorage.setItem(STORAGE_KEYS.APP_DATA, JSON.stringify(dataToSave));
    
    // åŒæ—¶ä¿å­˜å¤‡ä»½æ•°æ®ï¼ˆåªä¿å­˜æœ€é‡è¦çš„éƒ¨åˆ†ï¼‰
    const backupData = {
      selfInfo: appData.selfInfo,
      otherInfo: appData.otherInfo,
      messages: appData.messages,
      saveTime: new Date().toISOString()
    };
    localStorage.setItem(STORAGE_KEYS.BACKUP_DATA, JSON.stringify(backupData));
    
    // ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯
    localStorage.setItem(STORAGE_KEYS.DATA_VERSION, DATA_VERSION);
    
    // ä¿å­˜æœ€åä¿å­˜æ—¶é—´
    localStorage.setItem(STORAGE_KEYS.LAST_SAVE_TIME, new Date().toISOString());
    
    console.log('æ•°æ®ä¿å­˜æˆåŠŸ');
    return true;
    
  } catch (error) {
    console.error('ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
    
    // å°è¯•ä½¿ç”¨æ›´ç®€å•çš„æ–¹å¼ä¿å­˜
    try {
      // åªä¿å­˜æœ€åŸºæœ¬çš„æ•°æ®
      const minimalData = {
        messages: appData.messages,
        selfInfo: appData.selfInfo,
        otherInfo: appData.otherInfo,
        saveTime: new Date().toISOString()
      };
      localStorage.setItem('seven_and_wish_minimal_data', JSON.stringify(minimalData));
      console.log('æœ€å°æ•°æ®ä¿å­˜æˆåŠŸ');
    } catch (minimalError) {
      console.error('æœ€å°æ•°æ®ä¿å­˜ä¹Ÿå¤±è´¥:', minimalError);
    }
    
    return false;
  }
}

// æ¸²æŸ“æ‰€æœ‰UI
function renderAllUI() {
  renderMessages();
  renderStickerPreview();
  renderPhrasesTextarea();
  renderTarotUI();
  renderBackgroundUI();
  renderUserInfo();
  renderAppearance();
  renderCommunicationStats();
  initSendSettings();
  initAppearanceSettings();
  initCommunicationSettings();
  initActiveCallSettings();
  
  updateStickerCount();
  updatePhraseCount();
  updateTarotPhraseCount();
}

// å¯åŠ¨æ‰€æœ‰å®šæ—¶å™¨
function startAllTimers() {
  // å¼€å§‹å¯¹æ–¹çŠ¶æ€åˆ‡æ¢
  startStatusSwitching();
  
  // å¼€å§‹å¿ƒæƒ…å˜åŒ–
  startMoodChanging();
  
  // å¼€å§‹ä¸»åŠ¨å‘é€
  startAutoSending();
  
  // å¼€å§‹ä¸»åŠ¨å‘¼å«
  startActiveCallScheduler();
  
  // è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨ï¼ˆæ¯10ç§’ä¿å­˜ä¸€æ¬¡ï¼‰
  setInterval(() => {
    saveCompleteDataToLocalStorage();
  }, 10000);
  
  // é¡µé¢å…³é—­å‰ä¿å­˜
  window.addEventListener('beforeunload', () => {
    saveCompleteDataToLocalStorage();
  });
}

// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupEventListeners() {
  // å‘é€æ¶ˆæ¯
  sendButton.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendMessage();
  });
  
  // ç»§ç»­å‘é€æŒ‰é’®ï¼ˆç°åœ¨æ˜¾ç¤ºä¸º"..."ï¼‰
  continueButton.addEventListener('click', requestContinueMessages);
  
  // å›¾ç‰‡ä¸Šä¼ 
  uploadImageButton.addEventListener('click', () => imageUpload.click());
  imageUpload.addEventListener('change', handleImageUpload);
  
  // è®¾ç½®é¢æ¿
  settingsToggle.addEventListener('click', openSettings);
  settingsOverlay.addEventListener('click', closeSettingsPanel);
  closeSettings.addEventListener('click', closeSettingsPanel);
  
  // è¡¨æƒ…åŒ…
  addStickerBtn.addEventListener('click', () => stickerUpload.click());
  addStickerPlaceholder.addEventListener('click', () => stickerUpload.click());
  stickerUpload.addEventListener('change', handleStickerUpload);
  
  // è¯æ¡
  savePhrasesBtn.addEventListener('click', savePhrases);
  phrasesTextarea.addEventListener('input', updatePhraseCount);
  
  // å¡”ç½—ç‰Œè®¾ç½®
  tarotModeToggle.addEventListener('change', updateTarotMode);
  saveTarotBtn.addEventListener('click', saveTarotSettings);
  tarotTextarea.addEventListener('input', updateTarotPhraseCount);
  loadDefaultTarotBtn.addEventListener('click', loadDefaultTarotCards);
  clearTarotBtn.addEventListener('click', clearTarotCards);
  
  // èƒŒæ™¯è®¾ç½®
  uploadBackgroundOption.addEventListener('click', () => backgroundUpload.click());
  backgroundUpload.addEventListener('change', handleBackgroundUpload);
  removeBackgroundBtn.addEventListener('click', removeBackground);
  backgroundOpacitySlider.addEventListener('input', updateBackgroundOpacity);
  saveBackgroundBtn.addEventListener('click', saveBackgroundSettings);
  
  // æ ‡ç­¾é¡µ
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const tabId = button.getAttribute('data-tab');
      switchTab(tabId);
    });
  });
  
  // å‘é€è®¾ç½®
  stickerRatioSlider.addEventListener('input', updateStickerRatio);
  phraseRatioSlider.addEventListener('input', updatePhraseRatio);
  maxMessageCount.addEventListener('change', updateMaxMessageCount);
  autoSendFrequency.addEventListener('change', updateAutoSendFrequency);
  
  // å¤–è§‚è®¾ç½®
  saveAppearanceBtn.addEventListener('click', saveAppearanceSettings);
  loveDaysElement.addEventListener('click', () => switchTab('appearance'));
  
  // é€šä¿¡è®¾ç½®
  startCallButton.addEventListener('click', startCall);
  startVideoButton.addEventListener('click', startVideo);
  autoAcceptCalls.addEventListener('change', updateAutoAcceptCalls);
  autoAcceptVideos.addEventListener('change', updateAutoAcceptVideos);
  saveCommunicationBtn.addEventListener('click', saveCommunicationSettings);
  
  // æ–°å¢ï¼šä¸»åŠ¨å‘¼å«è®¾ç½®
  overallFrequencySlider.addEventListener('input', updateOverallFrequency);
  callPreferenceSlider.addEventListener('input', updateCallPreference);
  presetButtons.forEach(button => {
    button.addEventListener('click', function() {
      const preset = this.getAttribute('data-preset');
      applyPresetMode(preset);
    });
  });
  
  // äº‘å¯¼å…¥
  importCloudBtn.addEventListener('click', importCloudData);
  clearCloudBtn.addEventListener('click', clearCloudTextarea);
  importFileBtn.addEventListener('click', () => cloudFileUpload.click());
  cloudFileUpload.addEventListener('change', handleCloudFileUpload);
  
  // å¯¼å‡º
  exportTxtBtn.addEventListener('click', () => exportChatHistory('txt'));
  exportJsonBtn.addEventListener('click', () => exportChatHistory('json'));
  exportHtmlBtn.addEventListener('click', () => exportChatHistory('html'));
  exportAllBtn.addEventListener('click', exportAllData);
  
  // ç”¨æˆ·ä¿¡æ¯
  selfUserInfo.addEventListener('click', () => openUserEditModal('self'));
  otherUserInfo.addEventListener('click', () => openUserEditModal('other'));
  
  // æ¨¡æ€æ¡†
  cancelEditBtn.addEventListener('click', closeUserEditModal);
  saveUserInfoBtn.addEventListener('click', saveUserInfo);
  uploadAvatarBtn.addEventListener('click', () => modalAvatarUpload.click());
  modalAvatarUpload.addEventListener('change', handleAvatarUpload);
  
  // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­æ¶ˆæ¯æ“ä½œèœå•
  document.addEventListener('click', function(e) {
    if (appData.activeMessageActions && !appData.activeMessageActions.contains(e.target)) {
      appData.activeMessageActions.style.display = 'none';
      appData.activeMessageActions = null;
    }
  });
}

// åˆå§‹åŒ–ä¸»åŠ¨å‘¼å«è®¾ç½®
function initActiveCallSettings() {
  // è®¾ç½®æ»‘å—åˆå§‹å€¼
  overallFrequencySlider.value = appData.communicationSettings.activeCallSettings.overallFrequency;
  callPreferenceSlider.value = appData.communicationSettings.activeCallSettings.callPreference;
  
  // æ›´æ–°æ˜¾ç¤ºå€¼
  updateOverallFrequencyDisplay();
  updateCallPreferenceDisplay();
  updateActiveCallPreview();
  
  // è®¾ç½®é¢„è®¾æ¨¡å¼æŒ‰é’®çŠ¶æ€
  updatePresetButtons();
}

// æ›´æ–°æ€»ä½“é¢‘ç‡
function updateOverallFrequency() {
  const value = parseInt(overallFrequencySlider.value);
  appData.communicationSettings.activeCallSettings.overallFrequency = value;
  appData.communicationSettings.activeCallSettings.enabled = value > 0;
  appData.communicationSettings.activeCallSettings.presetMode = 'custom';
  
  updateOverallFrequencyDisplay();
  updatePresetButtons();
  updateActiveCallPreview();
  
  // é‡å¯å®šæ—¶å™¨
  restartActiveCallScheduler();
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// æ›´æ–°æ€»ä½“é¢‘ç‡æ˜¾ç¤º
function updateOverallFrequencyDisplay() {
  const value = appData.communicationSettings.activeCallSettings.overallFrequency;
  overallFrequencyValue.textContent = `${value}%`;
}

// æ›´æ–°å‘¼å«åå¥½
function updateCallPreference() {
  const value = parseInt(callPreferenceSlider.value);
  appData.communicationSettings.activeCallSettings.callPreference = value;
  appData.communicationSettings.activeCallSettings.presetMode = 'custom';
  
  updateCallPreferenceDisplay();
  updatePresetButtons();
  updateActiveCallPreview();
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// æ›´æ–°å‘¼å«åå¥½æ˜¾ç¤º
function updateCallPreferenceDisplay() {
  const value = appData.communicationSettings.activeCallSettings.callPreference;
  const callPercent = value;
  const videoPercent = 100 - value;
  callPreferenceValue.textContent = `ç”µè¯ ${callPercent}% / è§†é¢‘ ${videoPercent}%`;
}

// åº”ç”¨é¢„è®¾æ¨¡å¼
function applyPresetMode(preset) {
  if (!PRESET_MODES[preset]) return;
  
  const presetConfig = PRESET_MODES[preset];
  
  // æ›´æ–°è®¾ç½®
  appData.communicationSettings.activeCallSettings.overallFrequency = presetConfig.overallFrequency || 30;
  appData.communicationSettings.activeCallSettings.callPreference = presetConfig.callPreference || 50;
  appData.communicationSettings.activeCallSettings.presetMode = preset;
  
  if (presetConfig.minInterval !== undefined) {
    appData.communicationSettings.activeCallSettings.minInterval = presetConfig.minInterval;
  }
  if (presetConfig.maxInterval !== undefined) {
    appData.communicationSettings.activeCallSettings.maxInterval = presetConfig.maxInterval;
  }
  
  // æ›´æ–°UI
  overallFrequencySlider.value = appData.communicationSettings.activeCallSettings.overallFrequency;
  callPreferenceSlider.value = appData.communicationSettings.activeCallSettings.callPreference;
  
  updateOverallFrequencyDisplay();
  updateCallPreferenceDisplay();
  updatePresetButtons();
  updateActiveCallPreview();
  
  // é‡å¯å®šæ—¶å™¨
  restartActiveCallScheduler();
  
  // æ˜¾ç¤ºé€šçŸ¥
  showNotification(`å·²åˆ‡æ¢åˆ°${presetConfig.name}: ${presetConfig.description}`);
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// æ›´æ–°é¢„è®¾æŒ‰é’®çŠ¶æ€
function updatePresetButtons() {
  const currentPreset = appData.communicationSettings.activeCallSettings.presetMode;
  
  presetButtons.forEach(button => {
    const preset = button.getAttribute('data-preset');
    if (preset === currentPreset) {
      button.classList.add('active');
    } else {
      button.classList.remove('active');
    }
  });
}

// æ›´æ–°ä¸»åŠ¨å‘¼å«é¢„è§ˆ
function updateActiveCallPreview() {
  const frequency = appData.communicationSettings.activeCallSettings.overallFrequency;
  const callPref = appData.communicationSettings.activeCallSettings.callPreference;
  
  // é¢‘ç‡æè¿°
  let frequencyDesc = '';
  if (frequency === 0) {
    frequencyDesc = 'å…³é—­';
  } else if (frequency <= 15) {
    frequencyDesc = 'å¾ˆä½';
  } else if (frequency <= 30) {
    frequencyDesc = 'è¾ƒä½';
  } else if (frequency <= 50) {
    frequencyDesc = 'ä¸­ç­‰';
  } else if (frequency <= 75) {
    frequencyDesc = 'è¾ƒé«˜';
  } else {
    frequencyDesc = 'å¾ˆé«˜';
  }
  
  // ç±»å‹æè¿°
  let typeDesc = '';
  if (callPref <= 20) {
    typeDesc = 'ä¸»è¦è§†é¢‘ (ç”µè¯ 20% / è§†é¢‘ 80%)';
  } else if (callPref <= 40) {
    typeDesc = 'åè§†é¢‘ (ç”µè¯ 40% / è§†é¢‘ 60%)';
  } else if (callPref <= 60) {
    typeDesc = 'å‡è¡¡ (ç”µè¯ 50% / è§†é¢‘ 50%)';
  } else if (callPref <= 80) {
    typeDesc = 'åç”µè¯ (ç”µè¯ 60% / è§†é¢‘ 40%)';
  } else {
    typeDesc = 'ä¸»è¦ç”µè¯ (ç”µè¯ 80% / è§†é¢‘ 20%)';
  }
  
  // é¢„è®¡æ¯å¤©å‘¼å«æ¬¡æ•°
  let dailyCalls = 0;
  if (frequency === 0) {
    dailyCalls = 0;
  } else if (frequency <= 15) {
    dailyCalls = Math.floor(Math.random() * 2) + 1; // 1-2æ¬¡
  } else if (frequency <= 30) {
    dailyCalls = Math.floor(Math.random() * 3) + 2; // 2-4æ¬¡
  } else if (frequency <= 50) {
    dailyCalls = Math.floor(Math.random() * 4) + 3; // 3-6æ¬¡
  } else if (frequency <= 75) {
    dailyCalls = Math.floor(Math.random() * 5) + 4; // 4-8æ¬¡
  } else {
    dailyCalls = Math.floor(Math.random() * 6) + 5; // 5-10æ¬¡
  }
  
  // ä¸‹æ¬¡å‘¼å«æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
  let nextCallMin = 0;
  let nextCallMax = 0;
  if (frequency === 0) {
    nextCallMin = nextCallMax = 0;
  } else {
    // é¢‘ç‡è¶Šé«˜ï¼Œé—´éš”è¶ŠçŸ­
    const baseInterval = 120; // 2å°æ—¶åŸºå‡†
    const interval = Math.max(5, baseInterval * (100 - frequency) / 100);
    nextCallMin = Math.floor(interval * 0.6);
    nextCallMax = Math.floor(interval * 1.4);
  }
  
  // æ›´æ–°é¢„è§ˆ
  previewFrequency.textContent = `${frequencyDesc} (${frequency}%)`;
  previewType.textContent = typeDesc;
  previewDaily.textContent = frequency === 0 ? 'æ— å‘¼å«' : `${dailyCalls}æ¬¡å‘¼å«`;
  previewNext.textContent = frequency === 0 ? 'æ— è®¡åˆ’' : `${nextCallMin}-${nextCallMax}åˆ†é’Ÿå†…`;
}

// å¼€å§‹ä¸»åŠ¨å‘¼å«å®šæ—¶å™¨
function startActiveCallScheduler() {
  if (appData.activeCallTimer) {
    clearInterval(appData.activeCallTimer);
  }
  
  if (!appData.communicationSettings.activeCallSettings.enabled) {
    console.log('ä¸»åŠ¨å‘¼å«å·²å…³é—­');
    return;
  }
  
  const frequency = appData.communicationSettings.activeCallSettings.overallFrequency;
  if (frequency <= 0) {
    console.log('ä¸»åŠ¨å‘¼å«é¢‘ç‡ä¸º0ï¼Œä¸å¯åŠ¨å®šæ—¶å™¨');
    return;
  }
  
  // è®¡ç®—æ£€æŸ¥é—´éš”ï¼ˆé¢‘ç‡è¶Šé«˜ï¼Œæ£€æŸ¥è¶Šé¢‘ç¹ï¼‰
  const baseInterval = 60000; // 1åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  const checkInterval = baseInterval * (100 / Math.max(frequency, 10));
  
  console.log(`å¯åŠ¨ä¸»åŠ¨å‘¼å«å®šæ—¶å™¨ï¼Œæ£€æŸ¥é—´éš”: ${checkInterval/1000}ç§’ï¼Œé¢‘ç‡: ${frequency}%`);
  
  appData.activeCallTimer = setInterval(() => {
    // è€ƒè™‘å„ç§å› ç´ è°ƒæ•´å®é™…æ¦‚ç‡
    const adjustedProbability = calculateAdjustedCallProbability();
    
    // æ£€æŸ¥æ˜¯å¦åº”è¯¥å‘èµ·å‘¼å«
    if (Math.random() * 100 < adjustedProbability) {
      // å†³å®šæ˜¯ç”µè¯è¿˜æ˜¯è§†é¢‘
      const callType = determineCallType();
      simulateIncomingCall(callType);
    }
  }, checkInterval);
}

// é‡å¯ä¸»åŠ¨å‘¼å«å®šæ—¶å™¨
function restartActiveCallScheduler() {
  if (appData.activeCallTimer) {
    clearInterval(appData.activeCallTimer);
  }
  startActiveCallScheduler();
}

// è®¡ç®—è°ƒæ•´åçš„å‘¼å«æ¦‚ç‡
function calculateAdjustedCallProbability() {
  const settings = appData.communicationSettings.activeCallSettings;
  let baseProbability = settings.overallFrequency;
  
  // é¿å¼€å¿™ç¢ŒçŠ¶æ€
  if (settings.respectBusyStatus && appData.otherInfo.status === 'åœ¨å¿™') {
    baseProbability *= 0.3; // å¿™ç¢Œæ—¶é™ä½70%æ¦‚ç‡
  }
  
  // æ—¶é—´æ•æ„Ÿï¼ˆå¤œé—´é™ä½ï¼‰
  if (settings.timeSensitivity) {
    const hour = new Date().getHours();
    if (hour >= 22 || hour < 9) { // 22:00-9:00ä¸ºå¤œé—´
      baseProbability *= 0.4; // å¤œé—´é™ä½60%æ¦‚ç‡
      // å®Œå…¨å…³é—­è§†é¢‘å‘¼å«
      if (settings.callPreference > 50) { // å¦‚æœåå¥½è§†é¢‘
        baseProbability *= 0.5; // è¿›ä¸€æ­¥é™ä½
      }
    } else if (hour >= 9 && hour < 12) { // ä¸Šåˆ
      baseProbability *= 1.2; // ä¸Šåˆæé«˜20%
    } else if (hour >= 18 && hour < 22) { // æ™šä¸Š
      baseProbability *= 1.3; // æ™šä¸Šæé«˜30%
    }
  }
  
  // é€‚åº”èŠå¤©æ´»è·ƒåº¦
  if (settings.adaptToActivity) {
    // æ£€æŸ¥æœ€è¿‘5åˆ†é’Ÿå†…æ˜¯å¦æœ‰ç”¨æˆ·æ¶ˆæ¯
    const recentMessages = appData.messages.filter(msg => {
      if (msg.sender !== 'self') return false;
      // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æ¯”è¾ƒæ¶ˆæ¯æ—¶é—´
      return true;
    }).slice(-3);
    
    if (recentMessages.length > 0) {
      // æœ€è¿‘æœ‰èŠå¤©ï¼Œæé«˜å‘¼å«æ¦‚ç‡
      baseProbability *= 1.5;
    } else {
      // é•¿æ—¶é—´æ— èŠå¤©ï¼Œé™ä½å‘¼å«æ¦‚ç‡
      baseProbability *= 0.7;
    }
  }
  
  // è€ƒè™‘å¯¹æ–¹å¿ƒæƒ…
  if (appData.otherInfo.mood < 30) {
    // å¿ƒæƒ…ä¸å¥½æ—¶é™ä½å‘¼å«æ¦‚ç‡
    baseProbability *= 0.6;
  } else if (appData.otherInfo.mood > 80) {
    // å¿ƒæƒ…å¥½æ—¶æé«˜å‘¼å«æ¦‚ç‡ï¼Œç‰¹åˆ«æ˜¯è§†é¢‘
    baseProbability *= 1.2;
  }
  
  // ç¡®ä¿æ¦‚ç‡åœ¨åˆç†èŒƒå›´å†…
  return Math.max(0, Math.min(100, baseProbability));
}

// å†³å®šå‘¼å«ç±»å‹
function determineCallType() {
  const callPref = appData.communicationSettings.activeCallSettings.callPreference;
  const random = Math.random() * 100;
  
  if (random < callPref) {
    return 'call'; // ç”µè¯
  } else {
    return 'video'; // è§†é¢‘
  }
}

// æ¨¡æ‹Ÿå¯¹æ–¹æ¥ç”µ
function simulateIncomingCall(type) {
  // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰é€šè¯åœ¨è¿›è¡Œä¸­
  if (appData.activeCall || appData.activeVideo) {
    console.log('å½“å‰å·²æœ‰é€šè¯è¿›è¡Œä¸­ï¼Œè·³è¿‡æ­¤æ¬¡å‘¼å«');
    return;
  }
  
  // æ›´æ–°ç»Ÿè®¡
  appData.communicationSettings.todayIncomingCalls++;
  appData.communicationSettings.outgoingCallStats.attemptedToday++;
  renderCommunicationStats();
  
  console.log(`æ¨¡æ‹Ÿå¯¹æ–¹${type === 'call' ? 'æ¥ç”µ' : 'è§†é¢‘é‚€è¯·'}ï¼Œä»Šæ—¥ç¬¬${appData.communicationSettings.todayIncomingCalls}æ¬¡`);
  
  if (type === 'call') {
    createCallWindow('incoming');
    showNotification('å¯¹æ–¹æ¥ç”µ');
  } else {
    createVideoWindow('incoming');
    showNotification('å¯¹æ–¹å‘èµ·è§†é¢‘é€šè¯');
  }
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// ä¿å­˜é€šä¿¡è®¾ç½®
function saveCommunicationSettings() {
  // ä¿å­˜è‡ªåŠ¨æ¥å¬è®¾ç½®
  appData.communicationSettings.autoAcceptCalls = autoAcceptCalls.checked;
  appData.communicationSettings.autoAcceptVideos = autoAcceptVideos.checked;
  
  // é‡å¯ä¸»åŠ¨å‘¼å«å®šæ—¶å™¨
  restartActiveCallScheduler();
  
  showNotification('é€šè¯è®¾ç½®å·²ä¿å­˜');
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
  
  // åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
  closeSettingsPanel();
}

// è®¡ç®—æ‹çˆ±å¤©æ•°
function calculateLoveDays() {
  const today = new Date();
  const startDate = appData.appearanceSettings.loveStartDate;
  
  // è®¡ç®—å¤©æ•°å·®
  const timeDiff = today.getTime() - startDate.getTime();
  appData.loveDays = Math.floor(timeDiff / (1000 * 3600 * 24)) + 1;
  
  // ç¡®ä¿å¤©æ•°ä¸ä¸ºè´Ÿæ•°
  if (appData.loveDays < 1) {
    appData.loveDays = 1;
  }
}

// æ¸²æŸ“å¡”ç½—ç‰ŒUI
function renderTarotUI() {
  // è®¾ç½®å¼€å…³çŠ¶æ€
  tarotModeToggle.checked = appData.tarotSettings.enabled;
  
  // è®¾ç½®æŠ½å–æ•°é‡
  tarotCountValue.textContent = appData.tarotSettings.drawCount;
  
  // ç”Ÿæˆæ•°å­—é€‰æ‹©å™¨
  tarotNumberSelector.innerHTML = '';
  for (let i = 1; i <= 15; i++) {
    const numberDiv = document.createElement('div');
    numberDiv.className = `tarot-number ${i === appData.tarotSettings.drawCount ? 'active' : ''}`;
    numberDiv.textContent = i;
    numberDiv.dataset.number = i;
    numberDiv.addEventListener('click', () => selectTarotNumber(i));
    tarotNumberSelector.appendChild(numberDiv);
  }
  
  // è®¾ç½®å­—å¡å†…å®¹
  updateTarotTextarea();
  updateTarotPhraseCount();
  
  // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
  updateTarotStatus();
}

// æ¸²æŸ“èƒŒæ™¯UI
function renderBackgroundUI() {
  // æ›´æ–°èƒŒæ™¯é¢„è§ˆ
  updateBackgroundPreview();
  
  // è®¾ç½®é€æ˜åº¦æ»‘å—
  backgroundOpacitySlider.value = appData.backgroundSettings.opacity;
  backgroundOpacityValue.textContent = `${appData.backgroundSettings.opacity}%`;
  
  // åº”ç”¨èƒŒæ™¯è®¾ç½®
  applyBackgroundSettings();
}

// åˆå§‹åŒ–å‘é€è®¾ç½®
function initSendSettings() {
  // è®¾ç½®æ»‘å—åˆå§‹å€¼
  stickerRatioSlider.value = appData.sendSettings.stickerRatio;
  phraseRatioSlider.value = appData.sendSettings.phraseRatio;
  maxMessageCount.value = appData.sendSettings.maxMessageCount;
  autoSendFrequency.value = appData.sendSettings.autoSendFrequency;
  
  // æ›´æ–°æ˜¾ç¤ºå€¼
  stickerRatioValue.textContent = `${appData.sendSettings.stickerRatio}%`;
  phraseRatioValue.textContent = `${appData.sendSettings.phraseRatio}%`;
}

// åˆå§‹åŒ–å¤–è§‚è®¾ç½®
function initAppearanceSettings() {
  // è®¾ç½®è¾“å…¥æ¡†åˆå§‹å€¼
  appTitleInput.value = appData.appearanceSettings.appTitle;
  appSubtitleInput.value = appData.appearanceSettings.appSubtitle;
  
  const startDate = appData.appearanceSettings.loveStartDate;
  loveYear.value = startDate.getFullYear();
  loveMonth.value = startDate.getMonth() + 1; // æœˆä»½ä»0å¼€å§‹
  loveDay.value = startDate.getDate();
  
  moodChangeFrequency.value = appData.appearanceSettings.moodChangeFrequency;
}

// åˆå§‹åŒ–é€šä¿¡è®¾ç½®
function initCommunicationSettings() {
  // è®¾ç½®å¤é€‰æ¡†åˆå§‹å€¼
  autoAcceptCalls.checked = appData.communicationSettings.autoAcceptCalls;
  autoAcceptVideos.checked = appData.communicationSettings.autoAcceptVideos;
}

// æ¸²æŸ“é€šä¿¡ç»Ÿè®¡
function renderCommunicationStats() {
  todayCalls.textContent = appData.communicationSettings.todayCalls;
  totalCallTime.textContent = appData.communicationSettings.totalCallTime;
  todayVideos.textContent = appData.communicationSettings.todayVideos;
  totalVideoTime.textContent = appData.communicationSettings.totalVideoTime;
  todayIncomingCalls.textContent = appData.communicationSettings.todayIncomingCalls;
}

// æ›´æ–°å¡”ç½—ç‰Œæ¨¡å¼
function updateTarotMode() {
  appData.tarotSettings.enabled = tarotModeToggle.checked;
  updateTarotStatus();
  saveCompleteDataToLocalStorage();
  showNotification(`å¡”ç½—ç‰Œæ¢¦å æ¨¡å¼ ${appData.tarotSettings.enabled ? 'å·²å¼€å¯' : 'å·²å…³é—­'}`);
}

// é€‰æ‹©å¡”ç½—ç‰ŒæŠ½å–æ•°é‡
function selectTarotNumber(number) {
  appData.tarotSettings.drawCount = number;
  tarotCountValue.textContent = number;
  
  // æ›´æ–°æ•°å­—é€‰æ‹©å™¨æ ·å¼
  document.querySelectorAll('.tarot-number').forEach(el => {
    el.classList.remove('active');
    if (parseInt(el.dataset.number) === number) {
      el.classList.add('active');
    }
  });
  
  saveCompleteDataToLocalStorage();
  showNotification(`å¡”ç½—ç‰ŒæŠ½å–æ•°é‡è®¾ç½®ä¸º: ${number}`);
}

// æ›´æ–°å¡”ç½—ç‰ŒçŠ¶æ€æ˜¾ç¤º
function updateTarotStatus() {
  const defaultCount = appData.tarotSettings.defaultPhrases.length;
  const customCount = appData.tarotSettings.customPhrases.length;
  const totalCount = appData.tarotSettings.phrases.length;
  
  if (appData.tarotSettings.enabled) {
    tarotStatus.innerHTML = `
      <strong>å¡”ç½—ç‰Œæ¢¦å æ¨¡å¼å·²å¼€å¯ ğŸ”®</strong><br>
      å¯¹æ–¹å°†æŠ½å– <strong>${appData.tarotSettings.drawCount}</strong> å¼ å¡”ç½—ç‰Œå­—å¡è¿›è¡Œå›å¤<br>
      å¡”ç½—ç‰Œå­—å¡åº“: <strong>${totalCount}</strong> å¼  (é»˜è®¤${defaultCount} + è‡ªå®šä¹‰${customCount})<br>
      <span style="font-size:0.75rem; opacity:0.8;">æ™ºèƒ½è§„åˆ™ï¼šåŒç‰Œæ­£é€†ä½ä¸é‡å¤æŠ½å–</span>
    `;
    tarotStatus.style.background = 'var(--tarot-bg)';
    tarotStatus.style.color = 'var(--tarot-text)';
    tarotStatus.style.borderLeft = '3px solid var(--tarot-text)';
  } else {
    tarotStatus.innerHTML = `
      <strong>å¡”ç½—ç‰Œæ¢¦å æ¨¡å¼å·²å…³é—­</strong><br>
      å¯¹æ–¹ä½¿ç”¨æ™®é€šè¯æ¡å’Œè¡¨æƒ…åŒ…å›å¤
    `;
    tarotStatus.style.background = 'rgba(255, 255, 255, 0.7)';
    tarotStatus.style.color = 'var(--text)';
    tarotStatus.style.borderLeft = '3px solid #ccc';
  }
}

// ä¿å­˜å¡”ç½—ç‰Œè®¾ç½®
function saveTarotSettings() {
  const text = tarotTextarea.value.trim();
  
  // æŒ‰è¡Œåˆ†å‰²ï¼Œè¿‡æ»¤ç©ºè¡Œ
  const phrases = text.split('\n')
    .map(phrase => phrase.trim())
    .filter(phrase => phrase.length > 0);
  
  // å°†æ–°è¾“å…¥çš„å­—å¡ä¿å­˜ä¸ºè‡ªå®šä¹‰å­—å¡
  appData.tarotSettings.customPhrases = phrases;
  
  // åˆå¹¶å­—å¡
  mergeTarotPhrases();
  
  // é‡ç½®å·²æŠ½å–è®°å½•
  resetDrawnCards();
  
  updateTarotPhraseCount();
  updateTarotStatus();
  
  if (phrases.length === 0) {
    showNotification('å·²æ¸…ç©ºè‡ªå®šä¹‰å¡”ç½—ç‰Œå­—å¡');
  } else {
    showNotification(`å·²ä¿å­˜ ${phrases.length} å¼ è‡ªå®šä¹‰å¡”ç½—ç‰Œå­—å¡`);
  }
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
  
  // åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
  closeSettingsPanel();
}

// æ›´æ–°å¡”ç½—ç‰Œå­—å¡è®¡æ•°
function updateTarotPhraseCount() {
  const defaultCount = appData.tarotSettings.defaultPhrases.length;
  const customCount = appData.tarotSettings.customPhrases.length;
  const totalCount = appData.tarotSettings.phrases.length;
  
  tarotPhraseCount.textContent = `${totalCount} (é»˜è®¤${defaultCount} + è‡ªå®šä¹‰${customCount})`;
}

// æ›´æ–°èƒŒæ™¯é¢„è§ˆ
function updateBackgroundPreview() {
  if (appData.backgroundSettings.backgroundImage) {
    backgroundPreview.innerHTML = `<img src="${appData.backgroundSettings.backgroundImage}" alt="èƒŒæ™¯é¢„è§ˆ">`;
    backgroundPreview.style.backgroundImage = `url(${appData.backgroundSettings.backgroundImage})`;
    backgroundPreview.style.backgroundSize = 'cover';
    backgroundPreview.style.backgroundPosition = 'center';
  } else {
    backgroundPreview.innerHTML = `
      <div class="empty">
        <i class="material-icons">wallpaper</i>
        <span>é»˜è®¤èƒŒæ™¯</span>
      </div>
    `;
  }
}

// åº”ç”¨èƒŒæ™¯è®¾ç½®
function applyBackgroundSettings() {
  // è®¾ç½®èƒŒæ™¯å®¹å™¨æ ·å¼
  if (appData.backgroundSettings.backgroundImage) {
    backgroundContainer.style.backgroundImage = `url(${appData.backgroundSettings.backgroundImage})`;
    backgroundContainer.style.backgroundColor = 'transparent';
    backgroundContainer.style.opacity = (appData.backgroundSettings.opacity / 100).toString();
  } else {
    // é»˜è®¤èƒŒæ™¯
    backgroundContainer.style.backgroundImage = 'none';
    backgroundContainer.style.backgroundColor = '';
    backgroundContainer.style.opacity = '1';
  }
}

// å¤„ç†èƒŒæ™¯ä¸Šä¼ 
function handleBackgroundUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  
  reader.onload = function(event) {
    appData.backgroundSettings.backgroundImage = event.target.result;
    appData.backgroundSettings.backgroundType = 'custom';
    
    updateBackgroundPreview();
    applyBackgroundSettings();
    showNotification('èƒŒæ™¯å›¾ç‰‡å·²ä¸Šä¼ ');
    
    // ä¿å­˜æ•°æ®
    saveCompleteDataToLocalStorage();
  };
  
  reader.readAsDataURL(file);
  
  // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
  e.target.value = '';
}

// ç§»é™¤èƒŒæ™¯
function removeBackground() {
  appData.backgroundSettings.backgroundImage = null;
  appData.backgroundSettings.backgroundType = 'default';
  appData.backgroundSettings.opacity = 100;
  
  backgroundOpacitySlider.value = 100;
  backgroundOpacityValue.textContent = '100%';
  
  updateBackgroundPreview();
  applyBackgroundSettings();
  showNotification('å·²æ¢å¤é»˜è®¤èƒŒæ™¯');
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// æ›´æ–°èƒŒæ™¯é€æ˜åº¦
function updateBackgroundOpacity() {
  const opacity = parseInt(backgroundOpacitySlider.value);
  appData.backgroundSettings.opacity = opacity;
  backgroundOpacityValue.textContent = `${opacity}%`;
  applyBackgroundSettings();
}

// ä¿å­˜èƒŒæ™¯è®¾ç½®
function saveBackgroundSettings() {
  saveCompleteDataToLocalStorage();
  showNotification('èƒŒæ™¯è®¾ç½®å·²ä¿å­˜');
  closeSettingsPanel();
}

// æ›´æ–°è¡¨æƒ…åŒ…æ¯”ä¾‹
function updateStickerRatio() {
  const value = parseInt(stickerRatioSlider.value);
  appData.sendSettings.stickerRatio = value;
  stickerRatioValue.textContent = `${value}%`;
  
  // è‡ªåŠ¨è°ƒæ•´å­—å¡æ¯”ä¾‹ä½¿æ€»å’Œä¸º100%
  appData.sendSettings.phraseRatio = 100 - value;
  phraseRatioSlider.value = appData.sendSettings.phraseRatio;
  phraseRatioValue.textContent = `${appData.sendSettings.phraseRatio}%`;
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// æ›´æ–°å­—å¡æ¯”ä¾‹
function updatePhraseRatio() {
  const value = parseInt(phraseRatioSlider.value);
  appData.sendSettings.phraseRatio = value;
  phraseRatioValue.textContent = `${value}%`;
  
  // è‡ªåŠ¨è°ƒæ•´è¡¨æƒ…åŒ…æ¯”ä¾‹ä½¿æ€»å’Œä¸º100%
  appData.sendSettings.stickerRatio = 100 - value;
  stickerRatioSlider.value = appData.sendSettings.stickerRatio;
  stickerRatioValue.textContent = `${appData.sendSettings.stickerRatio}%`;
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// æ›´æ–°æœ€å¤§æ¶ˆæ¯æ•°é‡
function updateMaxMessageCount() {
  appData.sendSettings.maxMessageCount = parseInt(maxMessageCount.value);
  saveCompleteDataToLocalStorage();
}

// æ›´æ–°ä¸»åŠ¨å‘é€é¢‘ç‡
function updateAutoSendFrequency() {
  appData.sendSettings.autoSendFrequency = parseInt(autoSendFrequency.value);
  
  // é‡å¯ä¸»åŠ¨å‘é€å®šæ—¶å™¨
  clearInterval(appData.autoSendTimer);
  startAutoSending();
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// æ›´æ–°è‡ªåŠ¨æ¥å¬ç”µè¯è®¾ç½®
function updateAutoAcceptCalls() {
  appData.communicationSettings.autoAcceptCalls = autoAcceptCalls.checked;
  saveCompleteDataToLocalStorage();
}

// æ›´æ–°è‡ªåŠ¨æ¥å¬è§†é¢‘è®¾ç½®
function updateAutoAcceptVideos() {
  appData.communicationSettings.autoAcceptVideos = autoAcceptVideos.checked;
  saveCompleteDataToLocalStorage();
}

// å¼€å§‹ä¸»åŠ¨å‘é€
function startAutoSending() {
  if (appData.sendSettings.autoSendFrequency > 0) {
    appData.autoSendTimer = setInterval(() => {
      // éšæœºå†³å®šæ˜¯å¦ä¸»åŠ¨å‘é€ï¼ˆ50%æ¦‚ç‡ï¼‰
      if (Math.random() > 0.5) {
        autoSendMessage();
      }
    }, appData.sendSettings.autoSendFrequency);
  }
}

// ä¸»åŠ¨å‘é€æ¶ˆæ¯
function autoSendMessage() {
  // æ˜¾ç¤ºå¯¹æ–¹æ­£åœ¨è¾“å…¥
  appData.isTyping = true;
  renderMessages();
  
  // å»¶è¿Ÿåå‘é€æ¶ˆæ¯
  setTimeout(() => {
    appData.isTyping = false;
    generateAutoSendReply();
  }, 1000 + Math.random() * 2000);
}

// ç”Ÿæˆä¸»åŠ¨å‘é€çš„å›å¤
function generateAutoSendReply() {
  // æ£€æŸ¥æ˜¯å¦å¯ç”¨å¡”ç½—ç‰Œæ¨¡å¼
  if (appData.tarotSettings.enabled && appData.tarotSettings.phrases.length > 0) {
    // å¡”ç½—ç‰Œæ¨¡å¼ï¼šæŒ‰è®¾ç½®æ•°é‡å‘é€å¡”ç½—ç‰Œå­—å¡
    generateTarotReply('auto');
    return;
  }
  
  // æ™®é€šæ¨¡å¼ï¼šéšæœºå†³å®šå‘é€1-3æ¡æ¶ˆæ¯
  const messageCount = Math.floor(Math.random() * 3) + 1;
  
  // æ ¹æ®æ¯”ä¾‹è®¡ç®—è¡¨æƒ…åŒ…å’Œå­—å¡æ•°é‡
  const totalRatio = appData.sendSettings.stickerRatio + appData.sendSettings.phraseRatio;
  const stickerProbability = appData.sendSettings.stickerRatio / totalRatio;
  
  // åˆ›å»ºæ¶ˆæ¯æ•°ç»„ï¼Œæ ¹æ®æ¯”ä¾‹æ··åˆå­—å¡å’Œè¡¨æƒ…åŒ…
  const messagesToSend = [];
  
  for (let i = 0; i < messageCount; i++) {
    // æ ¹æ®æ¯”ä¾‹éšæœºå†³å®šæ˜¯è¡¨æƒ…åŒ…è¿˜æ˜¯å­—å¡
    const isSticker = Math.random() < stickerProbability && appData.stickers.length > 0;
    
    if (isSticker) {
      // éšæœºé€‰æ‹©ä¸€ä¸ªè¡¨æƒ…åŒ…
      const randomSticker = appData.stickers[Math.floor(Math.random() * appData.stickers.length)];
      messagesToSend.push({
        type: 'sticker',
        data: randomSticker.data
      });
    } else {
      // éšæœºé€‰æ‹©ä¸€ä¸ªå­—å¡
      const randomPhrase = appData.responsePhrases[Math.floor(Math.random() * appData.responsePhrases.length)];
      messagesToSend.push({
        type: 'text',
        data: randomPhrase
      });
    }
  }
  
  // å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯
  const firstMsg = messagesToSend[0];
  const firstMessage = {
    id: Date.now(),
    isSticker: firstMsg.type === 'sticker',
    [firstMsg.type === 'sticker' ? 'stickerData' : 'text']: firstMsg.data,
    sender: 'other',
    time: getCurrentTimeWithSeconds(),
    read: true // å¯¹æ–¹ä¸»åŠ¨å‘é€çš„æ¶ˆæ¯ï¼Œè‡ªåŠ¨å·²è¯»
  };
  
  // æ·»åŠ å¼•ç”¨é€»è¾‘ï¼š20%æ¦‚ç‡å¼•ç”¨æœ€è¿‘çš„ç”¨æˆ·æ¶ˆæ¯
  if (Math.random() < 0.2) {
    const recentUserMessages = appData.messages
      .filter(msg => msg.sender === 'self')
      .slice(-3);
    
    if (recentUserMessages.length > 0) {
      const randomUserMessage = recentUserMessages[Math.floor(Math.random() * recentUserMessages.length)];
      firstMessage.quotedMessage = {
        id: randomUserMessage.id,
        text: randomUserMessage.text || '',
        isSticker: randomUserMessage.isSticker || false,
        stickerData: randomUserMessage.stickerData || null,
        sender: randomUserMessage.sender,
        time: randomUserMessage.time
      };
    }
  }
  
  appData.messages.push(firstMessage);
  renderMessages();
  
  // å¦‚æœæœ‰æ›´å¤šæ¶ˆæ¯ï¼Œå»¶è¿Ÿå‘é€
  if (messagesToSend.length > 1) {
    for (let i = 1; i < messagesToSend.length; i++) {
      setTimeout(() => {
        const msg = messagesToSend[i];
        const additionalMessage = {
          id: Date.now() + i,
          isSticker: msg.type === 'sticker',
          [msg.type === 'sticker' ? 'stickerData' : 'text']: msg.data,
          sender: 'other',
          time: getCurrentTimeWithSeconds(),
          read: true // å¯¹æ–¹ä¸»åŠ¨å‘é€çš„æ¶ˆæ¯ï¼Œè‡ªåŠ¨å·²è¯»
        };
        
        appData.messages.push(additionalMessage);
        renderMessages();
      }, (i * 800) + Math.random() * 500);
    }
  }
  
  showNotification('å¯¹æ–¹ä¸»åŠ¨å‘é€äº†æ¶ˆæ¯');
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// ç”Ÿæˆå¡”ç½—ç‰Œå›å¤
function generateTarotReply(source = 'reply') {
  if (!appData.tarotSettings.enabled || appData.tarotSettings.phrases.length === 0) {
    // å¦‚æœå¡”ç½—ç‰Œæ¨¡å¼æœªå¯ç”¨æˆ–æ²¡æœ‰å­—å¡ï¼Œå›é€€åˆ°æ™®é€šæ¨¡å¼
    if (source === 'reply') {
      generateReply();
    } else {
      generateAutoSendReply();
    }
    return;
  }
  
  // æŒ‰è®¾ç½®çš„æ•°é‡æŠ½å–å¡”ç½—ç‰Œå­—å¡
  const drawCount = Math.min(appData.tarotSettings.drawCount, appData.tarotSettings.phrases.length);
  
  // è¿‡æ»¤å¯ä»¥æŠ½å–çš„ç‰Œï¼ˆåº”ç”¨åŒç‰Œæ­£é€†ä½ä¸é‡å¤è§„åˆ™ï¼‰
  const availablePhrases = appData.tarotSettings.phrases.filter(phrase => {
    const parsedCard = parseTarotCard(phrase);
    return canDrawCard(parsedCard);
  });
  
  if (availablePhrases.length === 0) {
    // å¦‚æœæ²¡æœ‰å¯æŠ½å–çš„ç‰Œï¼ˆå¯èƒ½æ‰€æœ‰ç‰Œçš„æ­£é€†ä½éƒ½æŠ½è¿‡äº†ï¼‰ï¼Œé‡ç½®è®°å½•
    resetDrawnCards();
    
    // å†æ¬¡å°è¯•
    const retryAvailable = appData.tarotSettings.phrases.filter(phrase => {
      const parsedCard = parseTarotCard(phrase);
      return canDrawCard(parsedCard);
    });
    
    if (retryAvailable.length === 0) {
      // ä»ç„¶æ²¡æœ‰å¯æŠ½å–çš„ç‰Œï¼Œä½¿ç”¨æ™®é€šå›å¤
      if (source === 'reply') {
        generateReply();
      } else {
        generateAutoSendReply();
      }
      return;
    }
    
    // ä½¿ç”¨é‡ç½®åçš„å¯ç”¨ç‰Œ
    const finalDrawCount = Math.min(drawCount, retryAvailable.length);
    const selectedPhrases = [];
    
    for (let i = 0; i < finalDrawCount && retryAvailable.length > 0; i++) {
      const randomIndex = Math.floor(Math.random() * retryAvailable.length);
      selectedPhrases.push(retryAvailable[randomIndex]);
      
      // æ ‡è®°ä¸ºå·²æŠ½å–
      const parsedCard = parseTarotCard(retryAvailable[randomIndex]);
      markCardAsDrawn(parsedCard);
      
      // ä»å¯ç”¨åˆ—è¡¨ä¸­ç§»é™¤
      retryAvailable.splice(randomIndex, 1);
    }
    
    sendTarotMessages(selectedPhrases, source, 'ï¼ˆç‰Œåº“å·²é‡ç½®ï¼‰');
    return;
  }
  
  // æ­£å¸¸æŠ½å–
  const finalDrawCount = Math.min(drawCount, availablePhrases.length);
  const selectedPhrases = [];
  
  for (let i = 0; i < finalDrawCount && availablePhrases.length > 0; i++) {
    const randomIndex = Math.floor(Math.random() * availablePhrases.length);
    selectedPhrases.push(availablePhrases[randomIndex]);
    
    // æ ‡è®°ä¸ºå·²æŠ½å–
    const parsedCard = parseTarotCard(availablePhrases[randomIndex]);
    markCardAsDrawn(parsedCard);
    
    // ä»å¯ç”¨åˆ—è¡¨ä¸­ç§»é™¤
    availablePhrases.splice(randomIndex, 1);
  }
  
  sendTarotMessages(selectedPhrases, source);
}

// å‘é€å¡”ç½—ç‰Œæ¶ˆæ¯
function sendTarotMessages(selectedPhrases, source, extraInfo = '') {
  // å‘é€ç¬¬ä¸€æ¡å¡”ç½—ç‰Œæ¶ˆæ¯
  const firstMessage = {
    id: Date.now(),
    text: selectedPhrases[0],
    sender: 'other',
    time: getCurrentTimeWithSeconds(),
    read: true,
    isTarot: true
  };
  
  // æ·»åŠ å¼•ç”¨é€»è¾‘ï¼šå¡”ç½—ç‰Œæ¨¡å¼ä¸‹25%æ¦‚ç‡å¼•ç”¨
  if (Math.random() < 0.25) {
    const recentUserMessages = appData.messages
      .filter(msg => msg.sender === 'self')
      .slice(-3);
    
    if (recentUserMessages.length > 0) {
      const randomUserMessage = recentUserMessages[Math.floor(Math.random() * recentUserMessages.length)];
      firstMessage.quotedMessage = {
        id: randomUserMessage.id,
        text: randomUserMessage.text || '',
        isSticker: randomUserMessage.isSticker || false,
        stickerData: randomUserMessage.stickerData || null,
        sender: randomUserMessage.sender,
        time: randomUserMessage.time
      };
    }
  }
  
  appData.messages.push(firstMessage);
  renderMessages();
  
  // å¦‚æœæœ‰æ›´å¤šå¡”ç½—ç‰Œï¼Œå»¶è¿Ÿå‘é€
  if (selectedPhrases.length > 1) {
    for (let i = 1; i < selectedPhrases.length; i++) {
      setTimeout(() => {
        const additionalMessage = {
          id: Date.now() + i,
          text: selectedPhrases[i],
          sender: 'other',
          time: getCurrentTimeWithSeconds(),
          read: true,
          isTarot: true
        };
        
        appData.messages.push(additionalMessage);
        renderMessages();
      }, (i * 1000) + Math.random() * 500);
    }
  }
  
  // æ˜¾ç¤ºé€šçŸ¥
  const notificationText = source === 'auto' ? 
    `å¯¹æ–¹ä¸»åŠ¨æŠ½å–äº†${selectedPhrases.length}å¼ å¡”ç½—ç‰Œ ğŸ”® ${extraInfo}` : 
    `å¯¹æ–¹å›å¤äº†${selectedPhrases.length}å¼ å¡”ç½—ç‰Œ ğŸ”® ${extraInfo}`;
  
  showNotification(notificationText);
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// å°†æ‰€æœ‰å¯¹æ–¹å‘é€çš„æ¶ˆæ¯æ ‡è®°ä¸ºå·²è¯»
function markOtherMessagesAsRead() {
  appData.messages.forEach(msg => {
    if (msg.sender === 'other') {
      msg.read = true;
    }
  });
}

// æ¸²æŸ“æ¶ˆæ¯
function renderMessages() {
  messagesArea.innerHTML = '';
  
  // æ·»åŠ "å¯¹æ–¹æ­£åœ¨è¾“å…¥"æŒ‡ç¤ºå™¨
  messagesArea.appendChild(typingIndicator);
  
  // æ˜¾ç¤ºæˆ–éšè—æŒ‡ç¤ºå™¨
  if (appData.isTyping) {
    typingIndicator.classList.add('active');
  } else {
    typingIndicator.classList.remove('active');
  }
  
  // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæç¤º
  if (appData.messages.length === 0) {
    const emptyMessage = document.createElement('div');
    emptyMessage.className = 'message other';
    emptyMessage.innerHTML = `
      è¿˜æ²¡æœ‰èŠå¤©è®°å½•ï¼Œå¼€å§‹èŠå¤©å§ï¼
      <div class="message-time">
        <span>${getCurrentTimeWithSeconds()}</span>
        <span class="message-status">
          <span class="status-check double">âœ“âœ“</span>
          <span>å·²è¯»</span>
        </span>
      </div>
    `;
    messagesArea.appendChild(emptyMessage);
  } else {
    // æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
    appData.messages.forEach(msg => {
      const messageContainer = document.createElement('div');
      messageContainer.className = `message-container ${msg.sender}`;
      
      // å¤´åƒ
      const messageAvatar = document.createElement('div');
      messageAvatar.className = 'message-avatar';
      
      if (msg.sender === 'self') {
        if (appData.selfInfo.avatar) {
          messageAvatar.innerHTML = `<img src="${appData.selfInfo.avatar}" alt="${appData.selfInfo.nickname}">`;
        } else {
          messageAvatar.innerHTML = `<span></span>`; // ç©ºspan
        }
      } else {
        if (appData.otherInfo.avatar) {
          messageAvatar.innerHTML = `<img src="${appData.otherInfo.avatar}" alt="${appData.otherInfo.nickname}">`;
        } else {
          messageAvatar.innerHTML = `<span></span>`; // ç©ºspan
        }
      }
      
      // æ¶ˆæ¯å†…å®¹
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${msg.sender}`;
      
      // åˆ›å»ºæ¶ˆæ¯æ“ä½œèœå•
      const messageActions = document.createElement('div');
      messageActions.className = 'message-actions';
      messageActions.innerHTML = `
        <button class="message-action-btn quote" data-id="${msg.id}">å¼•ç”¨</button>
        <button class="message-action-btn delete" data-id="${msg.id}">åˆ é™¤</button>
        <button class="message-action-btn recall" data-id="${msg.id}">æ’¤å›</button>
      `;
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç”¨äºæ˜¾ç¤ºæ“ä½œèœå•
      messageDiv.addEventListener('click', (e) => {
        e.stopPropagation();
        
        // å…³é—­å…¶ä»–æ“ä½œèœå•
        if (appData.activeMessageActions && appData.activeMessageActions !== messageActions) {
          appData.activeMessageActions.style.display = 'none';
        }
        
        // åˆ‡æ¢å½“å‰æ“ä½œèœå•
        if (messageActions.style.display === 'flex') {
          messageActions.style.display = 'none';
          appData.activeMessageActions = null;
        } else {
          messageActions.style.display = 'flex';
          appData.activeMessageActions = messageActions;
        }
      });
      
      // æ£€æŸ¥æ˜¯å¦ä¸ºé€šè¯/è§†é¢‘æ¶ˆæ¯
      const isCallMessage = msg.type === 'call' || msg.type === 'video';
      const isTarotMessage = msg.isTarot;
      
      if (isCallMessage) {
        messageDiv.classList.add(`${msg.type}-message`);
      } else if (isTarotMessage) {
        messageDiv.classList.add('tarot-message');
      }
      
      // æ£€æŸ¥æ˜¯å¦ä¸ºå·²è¯»ä¸å›æ¶ˆæ¯
      const isReadNoReply = msg.id && appData.readNoReplyMessageIds.includes(msg.id);
      
      // å¦‚æœæœ‰å¼•ç”¨æ¶ˆæ¯ï¼Œæ˜¾ç¤ºå¼•ç”¨
      let quotedContent = '';
      if (msg.quotedMessage) {
        const quoted = msg.quotedMessage;
        quotedContent = `
          <div class="quoted-message" data-id="${quoted.id}">
            ${quoted.isSticker ? 
              `<img src="${quoted.stickerData}" alt="è¡¨æƒ…åŒ…" style="max-height:20px;">` : 
              quoted.text}
          </div>
        `;
      }
      
      // å¡”ç½—ç‰Œæ¶ˆæ¯æ·»åŠ å›¾æ ‡
      let tarotIcon = '';
      if (isTarotMessage) {
        tarotIcon = 'ğŸ”® ';
      }
      
      // å¦‚æœæ˜¯è¡¨æƒ…åŒ…ï¼Œæ˜¾ç¤ºå›¾ç‰‡
      if (msg.isSticker && msg.stickerData) {
        messageDiv.innerHTML = `
          ${quotedContent}
          <img src="${msg.stickerData}" alt="è¡¨æƒ…åŒ…" style="max-width: 100px; border-radius: 6px;">
          <div class="message-time">
            <span>${msg.time}</span>
            <span class="message-status">
              <span class="status-check ${msg.read ? 'double' : 'single'}">${msg.read ? 'âœ“âœ“' : 'âœ“'}</span>
              <span>${msg.read ? 'å·²è¯»' : 'æœªè¯»'}</span>
              ${isReadNoReply ? '<span class="read-no-reply">ğŸ‘€ å·²è¯»ä¸å›</span>' : ''}
            </span>
          </div>
        `;
      } else if (isCallMessage) {
        // é€šè¯/è§†é¢‘æ¶ˆæ¯
        messageDiv.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px;">
            <i class="material-icons" style="font-size:1.2rem;">${msg.type === 'call' ? 'call' : 'videocam'}</i>
            <div>
              <div style="font-weight:500;">${msg.title || ''}</div>
              <div style="font-size:0.8rem;">${msg.duration || ''}</div>
            </div>
          </div>
          <div class="message-time">
            <span>${msg.time}</span>
            <span class="message-status">
              <span class="status-check double">âœ“âœ“</span>
              <span>å·²è¯»</span>
            </span>
          </div>
        `;
      } else {
        // æ™®é€šæ–‡æœ¬æ¶ˆæ¯æˆ–å¡”ç½—ç‰Œæ¶ˆæ¯
        messageDiv.innerHTML = `
          ${quotedContent}
          ${tarotIcon}${msg.text || ''}
          <div class="message-time">
            <span>${msg.time}</span>
            <span class="message-status">
              <span class="status-check ${msg.read ? 'double' : 'single'}">${msg.read ? 'âœ“âœ“' : 'âœ“'}</span>
              <span>${msg.read ? 'å·²è¯»' : 'æœªè¯»'}</span>
              ${isReadNoReply ? '<span class="read-no-reply">ğŸ‘€ å·²è¯»ä¸å›</span>' : ''}
            </span>
          </div>
        `;
      }
      
      messageContent.appendChild(messageDiv);
      messageContent.appendChild(messageActions);
      messageContainer.appendChild(messageAvatar);
      messageContainer.appendChild(messageContent);
      messagesArea.appendChild(messageContainer);
      
      // ä¸ºæ“ä½œèœå•æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      messageActions.querySelector('.message-action-btn.quote').addEventListener('click', (e) => {
        e.stopPropagation();
        quoteMessage(msg);
        messageActions.style.display = 'none';
        appData.activeMessageActions = null;
      });
      
      messageActions.querySelector('.message-action-btn.delete').addEventListener('click', (e) => {
        e.stopPropagation();
        deleteMessage(msg.id);
        messageActions.style.display = 'none';
        appData.activeMessageActions = null;
      });
      
      messageActions.querySelector('.message-action-btn.recall').addEventListener('click', (e) => {
        e.stopPropagation();
        recallMessage(msg.id);
        messageActions.style.display = 'none';
        appData.activeMessageActions = null;
      });
    });
  }
  
  // æ»šåŠ¨åˆ°åº•éƒ¨
  messagesArea.scrollTop = messagesArea.scrollHeight;
}

// å¼•ç”¨æ¶ˆæ¯
function quoteMessage(message) {
  if (!message) return;
  
  // è®¾ç½®å½“å‰å¼•ç”¨çš„æ¶ˆæ¯
  appData.quotedMessage = {
    id: message.id,
    text: message.text || '',
    isSticker: message.isSticker || false,
    stickerData: message.stickerData || null,
    sender: message.sender,
    time: message.time
  };
  
  // åœ¨è¾“å…¥æ¡†ä¸­æ˜¾ç¤ºå¼•ç”¨æç¤º
  let quoteText = '';
  if (message.isSticker) {
    quoteText = '[è¡¨æƒ…åŒ…]';
  } else if (message.text) {
    // æˆªæ–­è¿‡é•¿çš„æ–‡æœ¬
    quoteText = message.text.length > 30 ? message.text.substring(0, 30) + '...' : message.text;
  }
  
  messageInput.placeholder = `å›å¤ "${quoteText}"...`;
  messageInput.focus();
  
  showNotification('å·²å¼•ç”¨æ¶ˆæ¯ï¼Œè¾“å…¥å›å¤å†…å®¹åå‘é€');
}

// åˆ é™¤æ¶ˆæ¯
function deleteMessage(messageId) {
  if (!messageId) return;
  
  // ä»æ¶ˆæ¯åˆ—è¡¨ä¸­åˆ é™¤
  const initialLength = appData.messages.length;
  appData.messages = appData.messages.filter(msg => msg.id !== messageId);
  
  // ä»å·²è¯»ä¸å›åˆ—è¡¨ä¸­åˆ é™¤
  const index = appData.readNoReplyMessageIds.indexOf(messageId);
  if (index > -1) {
    appData.readNoReplyMessageIds.splice(index, 1);
  }
  
  if (appData.messages.length < initialLength) {
    renderMessages();
    showNotification('æ¶ˆæ¯å·²åˆ é™¤');
    
    // ä¿å­˜æ•°æ®
    saveCompleteDataToLocalStorage();
  }
}

// æ’¤å›æ¶ˆæ¯
function recallMessage(messageId) {
  if (!messageId) return;
  
  // æŸ¥æ‰¾æ¶ˆæ¯
  const messageIndex = appData.messages.findIndex(msg => msg.id === messageId);
  if (messageIndex === -1) return;
  
  const message = appData.messages[messageIndex];
  
  // åªèƒ½æ’¤å›è‡ªå·±å‘é€çš„æ¶ˆæ¯
  if (message.sender !== 'self') {
    showNotification('åªèƒ½æ’¤å›è‡ªå·±å‘é€çš„æ¶ˆæ¯');
    return;
  }
  
  // æ ‡è®°ä¸ºå·²æ’¤å›
  appData.messages[messageIndex].recalled = true;
  appData.messages[messageIndex].text = '[å·²æ’¤å›]';
  appData.messages[messageIndex].isSticker = false;
  appData.messages[messageIndex].stickerData = null;
  
  renderMessages();
  showNotification('æ¶ˆæ¯å·²æ’¤å›');
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// æ¸…é™¤å¼•ç”¨
function clearQuote() {
  appData.quotedMessage = null;
  messageInput.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
}

// æ¸²æŸ“ç”¨æˆ·ä¿¡æ¯
function renderUserInfo() {
  // è‡ªå·±
  if (appData.selfInfo.avatar) {
    selfAvatar.innerHTML = `<img src="${appData.selfInfo.avatar}" alt="${appData.selfInfo.nickname}">`;
  } else {
    selfAvatar.innerHTML = `<span></span>`; // ç©ºspanï¼Œä¸æ˜¾ç¤ºä»»ä½•å†…å®¹
  }
  selfNickname.textContent = appData.selfInfo.nickname;
  selfStatusText.textContent = appData.selfInfo.status;
  
  // å¯¹æ–¹
  if (appData.otherInfo.avatar) {
    otherAvatar.innerHTML = `<img src="${appData.otherInfo.avatar}" alt="${appData.otherInfo.nickname}">`;
  } else {
    otherAvatar.innerHTML = `<span></span>`; // ç©ºspanï¼Œä¸æ˜¾ç¤ºä»»ä½•å†…å®¹
  }
  otherNickname.textContent = appData.otherInfo.nickname;
  otherStatusText.textContent = appData.otherInfo.status;
  
  // æ›´æ–°å¯¹æ–¹çŠ¶æ€æŒ‡ç¤ºå™¨
  updateOtherStatusIndicator();
  
  // æ›´æ–°å¯¹æ–¹å¿ƒæƒ…æ˜¾ç¤º
  updateOtherMoodDisplay();
}

// æ¸²æŸ“å¤–è§‚è®¾ç½®
function renderAppearance() {
  // æ›´æ–°åº”ç”¨æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
  appTitle.textContent = appData.appearanceSettings.appTitle;
  appSubtitle.textContent = appData.appearanceSettings.appSubtitle;
  
  // æ›´æ–°æ‹çˆ±å¤©æ•°
  loveDaysCount.textContent = `æ‹çˆ±ç¬¬ ${appData.loveDays} å¤©`;
}

// æ›´æ–°å¯¹æ–¹çŠ¶æ€æŒ‡ç¤ºå™¨
function updateOtherStatusIndicator() {
  // æ¸…é™¤ç°æœ‰ç±»
  otherStatusIndicator.className = 'status-indicator';
  
  // æ·»åŠ å¯¹åº”çš„çŠ¶æ€ç±»
  const status = appData.statusOptions.find(s => s.text === appData.otherInfo.status);
  if (status) {
    otherStatusIndicator.classList.add(status.class);
    otherStatusIndicator.style.backgroundColor = status.color;
  }
}

// æ›´æ–°å¯¹æ–¹å¿ƒæƒ…æ˜¾ç¤º
function updateOtherMoodDisplay() {
  const mood = appData.otherInfo.mood;
  
  // æ›´æ–°å¿ƒæƒ…ç™¾åˆ†æ¯”æ˜¾ç¤º
  otherMoodValue.textContent = `${mood}%`;
}

// å¼€å§‹å¯¹æ–¹çŠ¶æ€åˆ‡æ¢
function startStatusSwitching() {
  // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
  if (appData.statusTimer) {
    clearTimeout(appData.statusTimer);
  }
  
  // éšæœºåˆ‡æ¢çŠ¶æ€
  function switchStatus() {
    // åªæœ‰30%çš„æ¦‚ç‡åˆ‡æ¢çŠ¶æ€ï¼ˆé™ä½åˆ‡æ¢é¢‘ç‡ï¼‰
    if (Math.random() > 0.3) {
      // ä¸åˆ‡æ¢çŠ¶æ€ï¼Œè®¾ç½®ä¸‹ä¸€ä¸ªæ£€æŸ¥æ—¶é—´
      const timeIndex = Math.floor(Math.random() * appData.statusChangeTimes.length);
      const nextTime = appData.statusChangeTimes[timeIndex];
      appData.statusTimer = setTimeout(switchStatus, nextTime * 1000);
      return;
    }
    
    // éšæœºé€‰æ‹©ä¸€ä¸ªæ–°çŠ¶æ€ï¼ˆä¸èƒ½ä¸å½“å‰çŠ¶æ€ç›¸åŒï¼‰
    let newStatus;
    do {
      const randomIndex = Math.floor(Math.random() * appData.statusOptions.length);
      newStatus = appData.statusOptions[randomIndex];
    } while (newStatus.text === appData.otherInfo.status);
    
    // æ›´æ–°çŠ¶æ€
    appData.otherInfo.status = newStatus.text;
    renderUserInfo();
    
    // éšæœºé€‰æ‹©ä¸‹ä¸€ä¸ªåˆ‡æ¢æ—¶é—´ï¼ˆä½¿ç”¨è¾ƒé•¿çš„æ—¶é—´ï¼‰
    const timeIndex = Math.floor(Math.random() * appData.statusChangeTimes.length);
    const nextTime = appData.statusChangeTimes[timeIndex];
    
    // è®¾ç½®ä¸‹ä¸€ä¸ªåˆ‡æ¢
    appData.statusTimer = setTimeout(switchStatus, nextTime * 1000);
    
    // ä¿å­˜æ•°æ®
    saveCompleteDataToLocalStorage();
  }
  
  // åˆå§‹å»¶è¿Ÿåå¼€å§‹åˆ‡æ¢
  setTimeout(switchStatus, 10000);
}

// å¼€å§‹å¿ƒæƒ…å˜åŒ–
function startMoodChanging() {
  // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
  if (appData.moodTimer) {
    clearInterval(appData.moodTimer);
  }
  
  // å®šæœŸæ›´æ–°å¿ƒæƒ…
  appData.moodTimer = setInterval(() => {
    changeMood();
  }, appData.appearanceSettings.moodChangeFrequency);
}

// æ”¹å˜å¿ƒæƒ…
function changeMood() {
  // éšæœºæ”¹å˜å¿ƒæƒ…å€¼ï¼ˆ-10åˆ°+10ä¹‹é—´ï¼‰
  const change = Math.floor(Math.random() * 21) - 10;
  appData.otherInfo.mood += change;
  
  // ç¡®ä¿å¿ƒæƒ…å€¼åœ¨0-100ä¹‹é—´
  if (appData.otherInfo.mood < 0) {
    appData.otherInfo.mood = 0;
  } else if (appData.otherInfo.mood > 100) {
    appData.otherInfo.mood = 100;
  }
  
  // æ›´æ–°æ˜¾ç¤º
  updateOtherMoodDisplay();
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// å‘é€æ¶ˆæ¯
function sendMessage() {
  const text = messageInput.value.trim();
  const hasImage = imageUpload.files.length > 0;
  
  if (!text && !hasImage && !appData.quotedMessage) {
    return;
  }
  
  // å¦‚æœæœ‰å›¾ç‰‡ï¼Œå…ˆå‘é€å›¾ç‰‡
  if (hasImage) {
    handleImageUpload({target: imageUpload});
    imageUpload.value = '';
    return;
  }
  
  // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
  const userMessage = {
    id: Date.now(),
    text,
    sender: 'self',
    time: getCurrentTimeWithSeconds(),
    read: false, // è‡ªå·±å‘é€çš„æ¶ˆæ¯åˆå§‹æœªè¯»
    quotedMessage: appData.quotedMessage ? {...appData.quotedMessage} : null
  };
  
  appData.messages.push(userMessage);
  renderMessages();
  
  // æ¸…ç©ºè¾“å…¥æ¡†å’Œå¼•ç”¨
  messageInput.value = '';
  clearQuote();
  
  // éšæœºå†³å®šå¯¹æ–¹æ˜¯å¦å›å¤
  const willReply = Math.random() > 0.2; // 80%æ¦‚ç‡å›å¤
  
  if (willReply) {
    // å¯¹æ–¹ä¼šå›å¤ï¼Œæ˜¾ç¤ºæ­£åœ¨è¾“å…¥
    appData.waitingForReply = true;
    startTypingIndicator();
    
    // æ¨¡æ‹Ÿå¯¹æ–¹å›å¤ï¼ˆå»¶è¿Ÿï¼‰
    const delay = 1500 + Math.random() * 2000;
    setTimeout(() => {
      // æ£€æŸ¥æ˜¯å¦å¯ç”¨å¡”ç½—ç‰Œæ¨¡å¼
      if (appData.tarotSettings.enabled && appData.tarotSettings.phrases.length > 0) {
        generateTarotReply('reply');
      } else {
        generateReply(userMessage.id);
      }
    }, delay);
  } else {
    // å¯¹æ–¹ä¸å›å¤ï¼Œå·²è¯»ä¸å›
    appData.waitingForReply = false;
    
    // æ¨¡æ‹Ÿå¯¹æ–¹å·²è¯»ï¼ˆå»¶è¿Ÿï¼‰
    setTimeout(() => {
      // æ ‡è®°è‡ªå·±å‘é€çš„æ¶ˆæ¯ä¸ºå·²è¯»
      markSelfMessagesAsRead();
      
      // è®°å½•ä¸ºå·²è¯»ä¸å›æ¶ˆæ¯
      if (userMessage.id) {
        appData.readNoReplyMessageIds.push(userMessage.id);
      }
      
      renderMessages();
      showNotification('å¯¹æ–¹å·²è¯»ä¸å›');
      
      // ä¿å­˜æ•°æ®
      saveCompleteDataToLocalStorage();
    }, 1000 + Math.random() * 3000);
  }
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// è¯·æ±‚ç»§ç»­å‘é€æ¶ˆæ¯ï¼ˆç°åœ¨æ˜¾ç¤ºä¸º"..."æŒ‰é’®ï¼‰
function requestContinueMessages() {
  // æ˜¾ç¤ºå¯¹æ–¹æ­£åœ¨è¾“å…¥
  appData.isTyping = true;
  renderMessages();
  
  // å»¶è¿Ÿåå‘é€å¤šæ¡æ¶ˆæ¯
  setTimeout(() => {
    appData.isTyping = false;
    
    // æ£€æŸ¥æ˜¯å¦å¯ç”¨å¡”ç½—ç‰Œæ¨¡å¼
    if (appData.tarotSettings.enabled && appData.tarotSettings.phrases.length > 0) {
      // å¡”ç½—ç‰Œæ¨¡å¼ï¼šæŒ‰è®¾ç½®æ•°é‡æŠ½å–å¡”ç½—ç‰Œ
      generateTarotReply('continue');
      showNotification(`å¯¹æ–¹æŠ½å–äº†å¡”ç½—ç‰Œè¿›è¡Œå åœ ğŸ”®`);
    } else {
      // æ™®é€šæ¨¡å¼ï¼šéšæœºå‘é€1-3æ¡æ¶ˆæ¯
      const messageCount = Math.floor(Math.random() * 3) + 1;
      generateMultipleMessages(messageCount);
      showNotification(`å¯¹æ–¹ç»§ç»­å‘é€äº†${messageCount}æ¡æ¶ˆæ¯`);
    }
  }, 1000 + Math.random() * 2000);
}

// ç”Ÿæˆå¤šæ¡æ¶ˆæ¯
function generateMultipleMessages(count) {
  // æ ¹æ®æ¯”ä¾‹è®¡ç®—è¡¨æƒ…åŒ…å’Œå­—å¡æ•°é‡
  const totalRatio = appData.sendSettings.stickerRatio + appData.sendSettings.phraseRatio;
  const stickerProbability = appData.sendSettings.stickerRatio / totalRatio;
  
  for (let i = 0; i < count; i++) {
    setTimeout(() => {
      // æ ¹æ®æ¯”ä¾‹éšæœºå†³å®šæ˜¯è¡¨æƒ…åŒ…è¿˜æ˜¯å­—å¡
      const isSticker = Math.random() < stickerProbability && appData.stickers.length > 0;
      
      let message;
      if (isSticker) {
        // éšæœºé€‰æ‹©ä¸€ä¸ªè¡¨æƒ…åŒ…
        const randomSticker = appData.stickers[Math.floor(Math.random() * appData.stickers.length)];
        message = {
          id: Date.now() + i,
          isSticker: true,
          stickerData: randomSticker.data,
          sender: 'other',
          time: getCurrentTimeWithSeconds(),
          read: true
        };
      } else {
        // éšæœºé€‰æ‹©ä¸€ä¸ªå­—å¡
        const randomPhrase = appData.responsePhrases[Math.floor(Math.random() * appData.responsePhrases.length)];
        message = {
          id: Date.now() + i,
          text: randomPhrase,
          sender: 'other',
          time: getCurrentTimeWithSeconds(),
          read: true
        };
      }
      
      // æ·»åŠ å¼•ç”¨é€»è¾‘ï¼šç»§ç»­å¯¹è¯æ—¶40%æ¦‚ç‡å¼•ç”¨æœ€è¿‘çš„ç”¨æˆ·æ¶ˆæ¯
      if (Math.random() < 0.4 && i === 0) {
        const recentUserMessages = appData.messages
          .filter(msg => msg.sender === 'self')
          .slice(-3);
        
        if (recentUserMessages.length > 0) {
          const randomUserMessage = recentUserMessages[Math.floor(Math.random() * recentUserMessages.length)];
          message.quotedMessage = {
            id: randomUserMessage.id,
            text: randomUserMessage.text || '',
            isSticker: randomUserMessage.isSticker || false,
            stickerData: randomUserMessage.stickerData || null,
            sender: randomUserMessage.sender,
            time: randomUserMessage.time
          };
        }
      }
      
      appData.messages.push(message);
      renderMessages();
      
      // å¦‚æœæ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œä¿å­˜æ•°æ®
      if (i === count - 1) {
        saveCompleteDataToLocalStorage();
      }
    }, i * 500 + Math.random() * 300);
  }
}

// å¤„ç†å›¾ç‰‡ä¸Šä¼ 
function handleImageUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  
  reader.onload = function(event) {
    // æ·»åŠ å›¾ç‰‡æ¶ˆæ¯
    const imageMessage = {
      id: Date.now(),
      isSticker: true,
      stickerData: event.target.result,
      sender: 'self',
      time: getCurrentTimeWithSeconds(),
      read: false,
      quotedMessage: appData.quotedMessage ? {...appData.quotedMessage} : null
    };
    
    appData.messages.push(imageMessage);
    renderMessages();
    
    // æ¸…ç©ºå¼•ç”¨
    clearQuote();
    
    // éšæœºå†³å®šå¯¹æ–¹æ˜¯å¦å›å¤
    const willReply = Math.random() > 0.3; // 70%æ¦‚ç‡å›å¤å›¾ç‰‡
    
    if (willReply) {
      // å¯¹æ–¹ä¼šå›å¤ï¼Œæ˜¾ç¤ºæ­£åœ¨è¾“å…¥
      appData.waitingForReply = true;
      startTypingIndicator();
      
      // æ¨¡æ‹Ÿå¯¹æ–¹å›å¤ï¼ˆå»¶è¿Ÿï¼‰
      const delay = 1500 + Math.random() * 2000;
      setTimeout(() => {
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨å¡”ç½—ç‰Œæ¨¡å¼
        if (appData.tarotSettings.enabled && appData.tarotSettings.phrases.length > 0) {
          generateTarotReply('reply');
        } else {
          generateReply(imageMessage.id);
        }
      }, delay);
    } else {
      // å¯¹æ–¹ä¸å›å¤ï¼Œå·²è¯»ä¸å›
      appData.waitingForReply = false;
      
      // æ¨¡æ‹Ÿå¯¹æ–¹å·²è¯»ï¼ˆå»¶è¿Ÿï¼‰
      setTimeout(() => {
        // æ ‡è®°è‡ªå·±å‘é€çš„æ¶ˆæ¯ä¸ºå·²è¯»
        markSelfMessagesAsRead();
        
        // è®°å½•ä¸ºå·²è¯»ä¸å›æ¶ˆæ¯
        if (imageMessage.id) {
          appData.readNoReplyMessageIds.push(imageMessage.id);
        }
        
        renderMessages();
        showNotification('å¯¹æ–¹å·²è¯»ä¸å›');
        
        // ä¿å­˜æ•°æ®
        saveCompleteDataToLocalStorage();
      }, 1000 + Math.random() * 3000);
    }
    
    // ä¿å­˜æ•°æ®
    saveCompleteDataToLocalStorage();
  };
  
  reader.readAsDataURL(file);
}

// æ ‡è®°è‡ªå·±å‘é€çš„æ¶ˆæ¯ä¸ºå·²è¯»
function markSelfMessagesAsRead() {
  appData.messages.forEach(msg => {
    if (msg.sender === 'self') {
      msg.read = true;
    }
  });
}

// ç”Ÿæˆå›å¤ - æ ¹æ®æ¯”ä¾‹æ··åˆå­—å¡å’Œè¡¨æƒ…åŒ…
function generateReply(messageId) {
  // åœæ­¢"æ­£åœ¨è¾“å…¥"æŒ‡ç¤ºå™¨
  stopTypingIndicator();
  
  // æ ‡è®°è‡ªå·±å‘é€çš„æ¶ˆæ¯ä¸ºå·²è¯»ï¼ˆå› ä¸ºå¯¹æ–¹å›å¤äº†ï¼‰
  markSelfMessagesAsRead();
  
  // å¦‚æœæ¶ˆæ¯IDå­˜åœ¨ï¼Œä»å·²è¯»ä¸å›åˆ—è¡¨ä¸­ç§»é™¤
  if (messageId) {
    const index = appData.readNoReplyMessageIds.indexOf(messageId);
    if (index > -1) {
      appData.readNoReplyMessageIds.splice(index, 1);
    }
  }
  
  // éšæœºå†³å®šå‘é€1-æœ€å¤§æ•°é‡çš„æ¶ˆæ¯
  const messageCount = Math.floor(Math.random() * appData.sendSettings.maxMessageCount) + 1;
  
  // æ ¹æ®æ¯”ä¾‹è®¡ç®—è¡¨æƒ…åŒ…å’Œå­—å¡æ•°é‡
  const totalRatio = appData.sendSettings.stickerRatio + appData.sendSettings.phraseRatio;
  const stickerProbability = appData.sendSettings.stickerRatio / totalRatio;
  
  // åˆ›å»ºæ¶ˆæ¯æ•°ç»„ï¼Œæ ¹æ®æ¯”ä¾‹æ··åˆå­—å¡å’Œè¡¨æƒ…åŒ…
  const messagesToSend = [];
  
  for (let i = 0; i < messageCount; i++) {
    // æ ¹æ®æ¯”ä¾‹éšæœºå†³å®šæ˜¯è¡¨æƒ…åŒ…è¿˜æ˜¯å­—å¡
    const isSticker = Math.random() < stickerProbability && appData.stickers.length > 0;
    
    if (isSticker) {
      // éšæœºé€‰æ‹©ä¸€ä¸ªè¡¨æƒ…åŒ…
      const randomSticker = appData.stickers[Math.floor(Math.random() * appData.stickers.length)];
      messagesToSend.push({
        type: 'sticker',
        data: randomSticker.data
      });
    } else {
      // éšæœºé€‰æ‹©ä¸€ä¸ªå­—å¡
      const randomPhrase = appData.responsePhrases[Math.floor(Math.random() * appData.responsePhrases.length)];
      messagesToSend.push({
        type: 'text',
        data: randomPhrase
      });
    }
  }
  
  // å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯
  const firstMsg = messagesToSend[0];
  const firstMessage = {
    id: Date.now(),
    isSticker: firstMsg.type === 'sticker',
    [firstMsg.type === 'sticker' ? 'stickerData' : 'text']: firstMsg.data,
    sender: 'other',
    time: getCurrentTimeWithSeconds(),
    read: true // å¯¹æ–¹å‘é€çš„æ¶ˆæ¯ï¼Œæ‰“å¼€é¡µé¢æ—¶è‡ªåŠ¨å·²è¯»
  };
  
  // æ·»åŠ å¼•ç”¨é€»è¾‘ï¼šç”¨æˆ·å‘é€åå¯¹æ–¹å›å¤æ—¶40%æ¦‚ç‡å¼•ç”¨
  if (Math.random() < 0.4) {
    // æŸ¥æ‰¾æœ€è¿‘3æ¡ç”¨æˆ·æ¶ˆæ¯
    const recentUserMessages = appData.messages
      .filter(msg => msg.sender === 'self')
      .slice(-3);
    
    if (recentUserMessages.length > 0) {
      // éšæœºé€‰æ‹©ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯è¿›è¡Œå¼•ç”¨
      const randomUserMessage = recentUserMessages[Math.floor(Math.random() * recentUserMessages.length)];
      firstMessage.quotedMessage = {
        id: randomUserMessage.id,
        text: randomUserMessage.text || '',
        isSticker: randomUserMessage.isSticker || false,
        stickerData: randomUserMessage.stickerData || null,
        sender: randomUserMessage.sender,
        time: randomUserMessage.time
      };
    }
  }
  
  appData.messages.push(firstMessage);
  renderMessages();
  
  // å¦‚æœæœ‰æ›´å¤šæ¶ˆæ¯ï¼Œå»¶è¿Ÿå‘é€
  if (messagesToSend.length > 1) {
    for (let i = 1; i < messagesToSend.length; i++) {
      setTimeout(() => {
        const msg = messagesToSend[i];
        const additionalMessage = {
          id: Date.now() + i,
          isSticker: msg.type === 'sticker',
          [msg.type === 'sticker' ? 'stickerData' : 'text']: msg.data,
          sender: 'other',
          time: getCurrentTimeWithSeconds(),
          read: true // å¯¹æ–¹å‘é€çš„æ¶ˆæ¯ï¼Œæ‰“å¼€é¡µé¢æ—¶è‡ªåŠ¨å·²è¯»
        };
        
        appData.messages.push(additionalMessage);
        renderMessages();
        
        // å¦‚æœæ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œæ˜¾ç¤ºé€šçŸ¥
        if (i === messagesToSend.length - 1) {
          const stickerCount = messagesToSend.filter(m => m.type === 'sticker').length;
          const textCount = messagesToSend.filter(m => m.type === 'text').length;
          let notificationText = `å¯¹æ–¹å›å¤äº†${messagesToSend.length}æ¡æ¶ˆæ¯`;
          if (stickerCount > 0 && textCount > 0) {
            notificationText += `ï¼ˆ${textCount}æ¡æ–‡å­—ï¼Œ${stickerCount}ä¸ªè¡¨æƒ…åŒ…ï¼‰`;
          } else if (stickerCount > 0) {
            notificationText += `ï¼ˆ${stickerCount}ä¸ªè¡¨æƒ…åŒ…ï¼‰`;
          }
          showNotification(notificationText);
        }
      }, (i * 800) + Math.random() * 500);
    }
  } else {
    const msgType = messagesToSend[0].type === 'sticker' ? 'ä¸€ä¸ªè¡¨æƒ…åŒ…' : '1æ¡æ¶ˆæ¯';
    showNotification(`å¯¹æ–¹å›å¤äº†${msgType}`);
  }
  
  appData.waitingForReply = false;
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// ä¿å­˜å¤–è§‚è®¾ç½®
function saveAppearanceSettings() {
  // ä¿å­˜åº”ç”¨æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
  const newTitle = appTitleInput.value.trim();
  const newSubtitle = appSubtitleInput.value.trim();
  
  if (newTitle) {
    appData.appearanceSettings.appTitle = newTitle;
  }
  
  if (newSubtitle) {
    appData.appearanceSettings.appSubtitle = newSubtitle;
  }
  
  // ä¿å­˜æ‹çˆ±èµ·å§‹æ—¥æœŸ
  const year = parseInt(loveYear.value);
  const month = parseInt(loveMonth.value) - 1; // æœˆä»½ä»0å¼€å§‹
  const day = parseInt(loveDay.value);
  
  if (year && month >= 0 && day) {
    appData.appearanceSettings.loveStartDate = new Date(year, month, day);
  }
  
  // ä¿å­˜å¿ƒæƒ…å˜åŒ–é¢‘ç‡
  appData.appearanceSettings.moodChangeFrequency = parseInt(moodChangeFrequency.value);
  
  // é‡å¯å¿ƒæƒ…å˜åŒ–å®šæ—¶å™¨
  clearInterval(appData.moodTimer);
  startMoodChanging();
  
  // é‡æ–°è®¡ç®—æ‹çˆ±å¤©æ•°
  calculateLoveDays();
  
  // æ›´æ–°æ˜¾ç¤º
  renderAppearance();
  
  showNotification('å¤–è§‚è®¾ç½®å·²ä¿å­˜');
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
  
  // åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
  closeSettingsPanel();
}

// å¼€å§‹"æ­£åœ¨è¾“å…¥"æŒ‡ç¤ºå™¨
function startTypingIndicator() {
  appData.isTyping = true;
  renderMessages();
}

// åœæ­¢"æ­£åœ¨è¾“å…¥"æŒ‡ç¤ºå™¨
function stopTypingIndicator() {
  appData.isTyping = false;
  renderMessages();
}

// å¤„ç†è¡¨æƒ…åŒ…ä¸Šä¼ 
function handleStickerUpload(e) {
  const files = e.target.files;
  
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const reader = new FileReader();
    
    reader.onload = function(event) {
      const stickerData = {
        id: Date.now() + i,
        data: event.target.result,
        name: file.name
      };
      
      appData.stickers.push(stickerData);
      renderStickerPreview();
      showNotification(`å·²æ·»åŠ è¡¨æƒ…åŒ…: ${file.name}`);
      
      // ä¿å­˜æ•°æ®
      saveCompleteDataToLocalStorage();
    };
    
    reader.readAsDataURL(file);
  }
  
  // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œä»¥ä¾¿å¯ä»¥å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
  e.target.value = '';
}

// æ¸²æŸ“è¡¨æƒ…åŒ…é¢„è§ˆ
function renderStickerPreview() {
  stickerPreview.innerHTML = '';
  
  // æ·»åŠ å·²æœ‰çš„è¡¨æƒ…åŒ…
  appData.stickers.forEach(sticker => {
    const stickerItem = document.createElement('div');
    stickerItem.className = 'sticker-item';
    stickerItem.innerHTML = `
      <img src="${sticker.data}" alt="è¡¨æƒ…åŒ…">
      <button class="delete-sticker" data-id="${sticker.id}">Ã—</button>
    `;
    
    // ç‚¹å‡»åˆ é™¤è¡¨æƒ…åŒ…
    stickerItem.querySelector('.delete-sticker').addEventListener('click', function(e) {
      e.stopPropagation();
      const id = parseInt(this.getAttribute('data-id'));
      appData.stickers = appData.stickers.filter(s => s.id !== id);
      renderStickerPreview();
      showNotification('è¡¨æƒ…åŒ…å·²åˆ é™¤');
      
      // ä¿å­˜æ•°æ®
      saveCompleteDataToLocalStorage();
    });
    
    stickerPreview.appendChild(stickerItem);
  });
  
  // æ·»åŠ æ·»åŠ æŒ‰é’®
  const addButton = document.createElement('div');
  addButton.className = 'sticker-item';
  addButton.id = 'addStickerPlaceholder';
  addButton.innerHTML = '<div class="sticker-placeholder">+</div>';
  addButton.addEventListener('click', () => stickerUpload.click());
  stickerPreview.appendChild(addButton);
  
  updateStickerCount();
}

// æ›´æ–°è¡¨æƒ…åŒ…è®¡æ•°
function updateStickerCount() {
  stickerCount.textContent = appData.stickers.length;
}

// æ¸²æŸ“è¯æ¡æ–‡æœ¬æ¡†
function renderPhrasesTextarea() {
  phrasesTextarea.value = appData.responsePhrases.join('\n');
  updatePhraseCount();
}

// ä¿å­˜è¯æ¡
function savePhrases() {
  const text = phrasesTextarea.value.trim();
  if (!text) {
    showNotification('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªè¯æ¡');
    return;
  }
  
  // æŒ‰è¡Œåˆ†å‰²ï¼Œè¿‡æ»¤ç©ºè¡Œ
  const phrases = text.split('\n')
    .map(phrase => phrase.trim())
    .filter(phrase => phrase.length > 0);
  
  if (phrases.length === 0) {
    showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„è¯æ¡');
    return;
  }
  
  appData.responsePhrases = phrases;
  updatePhraseCount();
  showNotification(`å·²ä¿å­˜ ${phrases.length} ä¸ªè¯æ¡`);
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
  
  // åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
  closeSettingsPanel();
}

// æ›´æ–°è¯æ¡è®¡æ•°
function updatePhraseCount() {
  const text = phrasesTextarea.value.trim();
  if (!text) {
    phraseCount.textContent = '0';
    return;
  }
  
  const phrases = text.split('\n')
    .map(phrase => phrase.trim())
    .filter(phrase => phrase.length > 0);
  
  phraseCount.textContent = phrases.length;
}

// æ‰“å¼€ç”¨æˆ·ç¼–è¾‘æ¨¡æ€æ¡†
function openUserEditModal(userType) {
  appData.editingUserType = userType;
  const userInfo = userType === 'self' ? appData.selfInfo : appData.otherInfo;
  
  // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜
  modalTitle.textContent = userType === 'self' ? 'ç¼–è¾‘æˆ‘çš„ä¿¡æ¯' : 'ç¼–è¾‘å¯¹æ–¹ä¿¡æ¯';
  
  // è®¾ç½®æ˜µç§°è¾“å…¥æ¡†
  modalNicknameInput.value = userInfo.nickname;
  
  // è®¾ç½®å¤´åƒé¢„è§ˆ
  avatarPreview.innerHTML = '';
  if (userInfo.avatar) {
    avatarPreview.innerHTML = `<img src="${userInfo.avatar}" alt="${userInfo.nickname}">`;
  } else {
    avatarPreview.innerHTML = `<span></span>`; // ç©ºspan
  }
  
  // æ˜¾ç¤ºæ¨¡æ€æ¡†
  userModal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// å…³é—­ç”¨æˆ·ç¼–è¾‘æ¨¡æ€æ¡†
function closeUserEditModal() {
  userModal.classList.remove('active');
  document.body.style.overflow = '';
  appData.editingUserType = null;
}

// ä¿å­˜ç”¨æˆ·ä¿¡æ¯
function saveUserInfo() {
  const userType = appData.editingUserType;
  if (!userType) return;
  
  const userInfo = userType === 'self' ? appData.selfInfo : appData.otherInfo;
  
  // ä¿å­˜æ˜µç§°
  const newNickname = modalNicknameInput.value.trim();
  if (newNickname) {
    userInfo.nickname = newNickname;
  }
  
  // æ¸²æŸ“æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯
  renderUserInfo();
  
  // é‡æ–°æ¸²æŸ“æ¶ˆæ¯ä»¥æ›´æ–°å¤´åƒ
  renderMessages();
  
  showNotification(`${userType === 'self' ? 'æˆ‘çš„' : 'å¯¹æ–¹'}ä¿¡æ¯å·²æ›´æ–°`);
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
  
  closeUserEditModal();
}

// å¤„ç†å¤´åƒä¸Šä¼ 
function handleAvatarUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  
  reader.onload = function(event) {
    const userType = appData.editingUserType;
    if (!userType) return;
    
    const userInfo = userType === 'self' ? appData.selfInfo : appData.otherInfo;
    userInfo.avatar = event.target.result;
    userInfo.avatarText = ''; // ä¸Šä¼ å¤´åƒåæ¸…ç©ºæ–‡å­—
    
    // æ›´æ–°é¢„è§ˆ
    avatarPreview.innerHTML = `<img src="${userInfo.avatar}" alt="${userInfo.nickname}">`;
    
    showNotification('å¤´åƒå·²æ›´æ–°');
    
    // ä¿å­˜æ•°æ®
    saveCompleteDataToLocalStorage();
  };
  
  reader.readAsDataURL(file);
  
  // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
  e.target.value = '';
}

// æ‰“å¼€è®¾ç½®é¢æ¿
function openSettings() {
  settingsPanel.classList.add('active');
  settingsOverlay.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// å…³é—­è®¾ç½®é¢æ¿
function closeSettingsPanel() {
  settingsPanel.classList.remove('active');
  settingsOverlay.classList.remove('active');
  document.body.style.overflow = '';
}

// åˆ‡æ¢æ ‡ç­¾é¡µ
function switchTab(tabId) {
  // æ‰“å¼€è®¾ç½®é¢æ¿å¦‚æœè¿˜æ²¡æ‰“å¼€
  if (!settingsPanel.classList.contains('active')) {
    openSettings();
  }
  
  // æ›´æ–°æŒ‰é’®çŠ¶æ€
  tabButtons.forEach(button => {
    if (button.getAttribute('data-tab') === tabId) {
      button.classList.add('active');
    } else {
      button.classList.remove('active');
    }
  });
  
  // æ›´æ–°å†…å®¹æ˜¾ç¤º
  tabContents.forEach(content => {
    if (content.id === `${tabId}Tab`) {
      content.classList.add('active');
    } else {
      content.classList.remove('active');
    }
  });
}

// è·å–å½“å‰æ—¶é—´ï¼ˆåŒ…å«ç§’ï¼‰
function getCurrentTimeWithSeconds() {
  const now = new Date();
  return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
}

// è·å–æ ¼å¼åŒ–æ—¶é—´
function getFormattedTime(timestamp) {
  const date = new Date(timestamp);
  return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
}

// å¼€å§‹é€šè¯
function startCall() {
  if (appData.activeCall) {
    showNotification('å½“å‰å·²æœ‰é€šè¯è¿›è¡Œä¸­');
    return;
  }
  
  // åˆ›å»ºé€šè¯çª—å£
  createCallWindow('outgoing');
  
  // æ›´æ–°ç»Ÿè®¡
  appData.communicationSettings.todayCalls++;
  renderCommunicationStats();
  
  // æ¨¡æ‹Ÿå¯¹æ–¹å“åº”ï¼ˆ5-10ç§’åï¼‰
  setTimeout(() => {
    if (appData.activeCall) {
      // å¯¹æ–¹æ¥å¬
      answerCall();
    }
  }, 5000 + Math.random() * 5000);
}

// å¼€å§‹è§†é¢‘
function startVideo() {
  if (appData.activeVideo) {
    showNotification('å½“å‰å·²æœ‰è§†é¢‘é€šè¯è¿›è¡Œä¸­');
    return;
  }
  
  // åˆ›å»ºè§†é¢‘çª—å£
  createVideoWindow('outgoing');
  
  // æ›´æ–°ç»Ÿè®¡
  appData.communicationSettings.todayVideos++;
  renderCommunicationStats();
  
  // æ¨¡æ‹Ÿå¯¹æ–¹å“åº”ï¼ˆ5-10ç§’åï¼‰
  setTimeout(() => {
    if (appData.activeVideo) {
      // å¯¹æ–¹æ¥å¬
      answerVideo();
    }
  }, 5000 + Math.random() * 5000);
}

// åˆ›å»ºé€šè¯çª—å£ï¼ˆæ”¯æŒç§»åŠ¨ç«¯æ‹–åŠ¨ï¼‰
function createCallWindow(type) {
  // ç§»é™¤ç°æœ‰çš„é€šè¯çª—å£
  const existingWindow = document.querySelector('.call-window');
  if (existingWindow) {
    existingWindow.remove();
  }
  
  // åˆ›å»ºæ–°çª—å£
  const callWindow = document.createElement('div');
  callWindow.className = 'call-window';
  callWindow.style.left = '50px';
  callWindow.style.top = '50px';
  
  const avatarContent = appData.otherInfo.avatar ? 
    `<img src="${appData.otherInfo.avatar}" alt="${appData.otherInfo.nickname}">` : 
    `<span></span>`;
  
  callWindow.innerHTML = `
    <div class="window-header">
      <div class="window-title">
        <i class="material-icons">call</i>
        <span>è¯­éŸ³é€šè¯</span>
      </div>
      <div class="window-controls">
        <button class="window-btn" id="minimizeCall">âˆ’</button>
        <button class="window-btn" id="closeCall">Ã—</button>
      </div>
    </div>
    <div class="window-content">
      <div class="call-avatar">
        ${avatarContent}
      </div>
      <div class="calling-text">${type === 'outgoing' ? 'ç­‰å¾…å¯¹æ–¹æ¥å¬...' : 'å¯¹æ–¹æ¥ç”µ...'}</div>
      ${type === 'incoming' ? `
        <div class="call-buttons">
          <button class="accept-btn" id="acceptCall">
            <i class="material-icons">call</i>
            æ¥å¬
          </button>
          <button class="reject-btn" id="rejectCall">
            <i class="material-icons">call_end</i>
            æ‹’ç»
          </button>
        </div>
      ` : ''}
    </div>
  `;
  
  document.body.appendChild(callWindow);
  appData.activeCall = callWindow;
  
  // è®¾ç½®çª—å£å¯æ‹–åŠ¨ï¼ˆæ”¯æŒç§»åŠ¨ç«¯ï¼‰
  makeWindowDraggable(callWindow);
  
  // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
  if (type === 'incoming') {
    callWindow.querySelector('#acceptCall').addEventListener('click', answerCall);
    callWindow.querySelector('#rejectCall').addEventListener('click', rejectCall);
  }
  
  callWindow.querySelector('#closeCall').addEventListener('click', endCall);
  callWindow.querySelector('#minimizeCall').addEventListener('click', () => {
    callWindow.style.display = callWindow.style.display === 'none' ? 'flex' : 'none';
  });
  
  // å¦‚æœè®¾ç½®ä¸ºè‡ªåŠ¨æ¥å¬ï¼Œè‡ªåŠ¨æ¥å¬
  if (type === 'incoming' && appData.communicationSettings.autoAcceptCalls) {
    setTimeout(() => {
      if (appData.activeCall === callWindow) {
        answerCall();
      }
    }, 2000);
  }
}

// åˆ›å»ºè§†é¢‘çª—å£ï¼ˆæ”¯æŒç§»åŠ¨ç«¯æ‹–åŠ¨ï¼‰
function createVideoWindow(type) {
  // ç§»é™¤ç°æœ‰çš„è§†é¢‘çª—å£
  const existingWindow = document.querySelector('.video-window');
  if (existingWindow) {
    existingWindow.remove();
  }
  
  // åˆ›å»ºæ–°çª—å£
  const videoWindow = document.createElement('div');
  videoWindow.className = 'video-window';
  videoWindow.style.left = '100px';
  videoWindow.style.top = '100px';
  
  const avatarContent = appData.otherInfo.avatar ? 
    `<img src="${appData.otherInfo.avatar}" alt="${appData.otherInfo.nickname}">` : 
    `<span></span>`;
  
  videoWindow.innerHTML = `
    <div class="window-header">
      <div class="window-title">
        <i class="material-icons">videocam</i>
        <span>è§†é¢‘é€šè¯</span>
      </div>
      <div class="window-controls">
        <button class="window-btn" id="minimizeVideo">âˆ’</button>
        <button class="window-btn" id="closeVideo">Ã—</button>
      </div>
    </div>
    <div class="window-content">
      <div class="video-avatar">
        ${avatarContent}
      </div>
      <div class="calling-text">${type === 'outgoing' ? 'ç­‰å¾…å¯¹æ–¹æ¥å¬...' : 'å¯¹æ–¹è§†é¢‘é‚€è¯·...'}</div>
      ${type === 'incoming' ? `
        <div class="call-buttons">
          <button class="accept-btn" id="acceptVideo">
            <i class="material-icons">videocam</i>
            æ¥å¬
          </button>
          <button class="reject-btn" id="rejectVideo">
            <i class="material-icons">call_end</i>
            æ‹’ç»
          </button>
        </div>
      ` : ''}
    </div>
  `;
  
  document.body.appendChild(videoWindow);
  appData.activeVideo = videoWindow;
  
  // è®¾ç½®çª—å£å¯æ‹–åŠ¨ï¼ˆæ”¯æŒç§»åŠ¨ç«¯ï¼‰
  makeWindowDraggable(videoWindow);
  
  // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
  if (type === 'incoming') {
    videoWindow.querySelector('#acceptVideo').addEventListener('click', answerVideo);
    videoWindow.querySelector('#rejectVideo').addEventListener('click', rejectVideo);
  }
  
  videoWindow.querySelector('#closeVideo').addEventListener('click', endVideo);
  videoWindow.querySelector('#minimizeVideo').addEventListener('click', () => {
    videoWindow.style.display = videoWindow.style.display === 'none' ? 'flex' : 'none';
  });
  
  // å¦‚æœè®¾ç½®ä¸ºè‡ªåŠ¨æ¥å¬ï¼Œè‡ªåŠ¨æ¥å¬
  if (type === 'incoming' && appData.communicationSettings.autoAcceptVideos) {
    setTimeout(() => {
      if (appData.activeVideo === videoWindow) {
        answerVideo();
      }
    }, 2000);
  }
}

// ä½¿çª—å£å¯æ‹–åŠ¨ï¼ˆæ”¯æŒç§»åŠ¨ç«¯ï¼‰
function makeWindowDraggable(windowElement) {
  let isDragging = false;
  let offsetX, offsetY;
  
  const header = windowElement.querySelector('.window-header');
  
  // é¼ æ ‡äº‹ä»¶
  header.addEventListener('mousedown', startDrag);
  document.addEventListener('mousemove', drag);
  document.addEventListener('mouseup', stopDrag);
  
  // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
  header.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    startDrag({ clientX: touch.clientX, clientY: touch.clientY });
  }, { passive: false });
  
  document.addEventListener('touchmove', (e) => {
    if (!isDragging) return;
    e.preventDefault();
    const touch = e.touches[0];
    drag({ clientX: touch.clientX, clientY: touch.clientY });
  }, { passive: false });
  
  document.addEventListener('touchend', stopDrag);
  document.addEventListener('touchcancel', stopDrag);
  
  function startDrag(e) {
    isDragging = true;
    const rect = windowElement.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    windowElement.classList.add('active');
    windowElement.style.transition = 'none'; // æ‹–åŠ¨æ—¶ç¦ç”¨è¿‡æ¸¡æ•ˆæœ
  }
  
  function drag(e) {
    if (!isDragging) return;
    
    // é™åˆ¶çª—å£åœ¨è§†å£å†…
    const maxX = window.innerWidth - windowElement.offsetWidth;
    const maxY = window.innerHeight - windowElement.offsetHeight;
    
    let x = e.clientX - offsetX;
    let y = e.clientY - offsetY;
    
    x = Math.max(0, Math.min(x, maxX));
    y = Math.max(0, Math.min(y, maxY));
    
    windowElement.style.left = `${x}px`;
    windowElement.style.top = `${y}px`;
  }
  
  function stopDrag() {
    isDragging = false;
    windowElement.classList.remove('active');
    windowElement.style.transition = ''; // æ¢å¤è¿‡æ¸¡æ•ˆæœ
  }
}

// æ¥å¬ç”µè¯
function answerCall() {
  if (!appData.activeCall) return;
  
  const content = appData.activeCall.querySelector('.window-content');
  content.innerHTML = `
    <div class="call-avatar">
      ${appData.otherInfo.avatar ? 
        `<img src="${appData.otherInfo.avatar}" alt="${appData.otherInfo.nickname}">` : 
        `<span></span>`}
    </div>
    <div class="in-call-text">æ­£åœ¨é€šè¯ä¸­...</div>
    <div class="call-timer" id="callTimer">00:00</div>
    <div class="call-buttons">
      <button class="end-btn" id="endCall">
        <i class="material-icons">call_end</i>
        æŒ‚æ–­
      </button>
    </div>
  `;
  
  content.querySelector('#endCall').addEventListener('click', endCall);
  
  // å¼€å§‹è®¡æ—¶
  appData.callStartTime = new Date();
  startCallTimer();
  
  // æ›´æ–°ç»Ÿè®¡
  appData.communicationSettings.outgoingCallStats.succeededToday++;
}

// æ¥å¬è§†é¢‘
function answerVideo() {
  if (!appData.activeVideo) return;
  
  const content = appData.activeVideo.querySelector('.window-content');
  content.innerHTML = `
    <div class="video-avatar">
      ${appData.otherInfo.avatar ? 
        `<img src="${appData.otherInfo.avatar}" alt="${appData.otherInfo.nickname}">` : 
        `<span></span>`}
    </div>
    <div class="in-call-text">æ­£åœ¨è§†é¢‘é€šè¯ä¸­...</div>
    <div class="call-timer" id="videoTimer">00:00</div>
    <div class="call-buttons">
      <button class="end-btn" id="endVideo">
        <i class="material-icons">call_end</i>
        æŒ‚æ–­
      </button>
    </div>
  `;
  
  content.querySelector('#endVideo').addEventListener('click', endVideo);
  
  // å¼€å§‹è®¡æ—¶
  appData.callStartTime = new Date();
  startCallTimer();
  
  // æ›´æ–°ç»Ÿè®¡
  appData.communicationSettings.outgoingCallStats.succeededToday++;
}

// æ‹’ç»ç”µè¯
function rejectCall() {
  if (!appData.activeCall) return;
  
  // æ·»åŠ é€šè¯è®°å½•æ¶ˆæ¯
  const callMessage = {
    id: Date.now(),
    type: 'call',
    title: 'å·²æ‹’ç»è¯­éŸ³é€šè¯',
    sender: 'other',
    time: getCurrentTimeWithSeconds(),
    read: true
  };
  
  appData.messages.push(callMessage);
  renderMessages();
  
  appData.activeCall.remove();
  appData.activeCall = null;
  showNotification('å·²æ‹’ç»é€šè¯');
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// æ‹’ç»è§†é¢‘
function rejectVideo() {
  if (!appData.activeVideo) return;
  
  // æ·»åŠ é€šè¯è®°å½•æ¶ˆæ¯
  const videoMessage = {
    id: Date.now(),
    type: 'video',
    title: 'å·²æ‹’ç»è§†é¢‘é€šè¯',
    sender: 'other',
    time: getCurrentTimeWithSeconds(),
    read: true
  };
  
  appData.messages.push(videoMessage);
  renderMessages();
  
  appData.activeVideo.remove();
  appData.activeVideo = null;
  showNotification('å·²æ‹’ç»è§†é¢‘é€šè¯');
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// ç»“æŸç”µè¯
function endCall() {
  if (!appData.activeCall) return;
  
  // è®¡ç®—é€šè¯æ—¶é•¿
  const endTime = new Date();
  const durationMs = endTime - appData.callStartTime;
  const durationSec = Math.floor(durationMs / 1000);
  const minutes = Math.floor(durationSec / 60);
  const seconds = durationSec % 60;
  const durationText = `${minutes}åˆ†${seconds}ç§’`;
  
  // æ›´æ–°æ€»é€šè¯æ—¶é—´
  appData.communicationSettings.totalCallTime += minutes;
  
  // æ·»åŠ é€šè¯è®°å½•æ¶ˆæ¯
  const callMessage = {
    id: Date.now(),
    type: 'call',
    title: 'è¯­éŸ³é€šè¯',
    duration: durationText,
    sender: 'self',
    time: getCurrentTimeWithSeconds(),
    read: true
  };
  
  appData.messages.push(callMessage);
  renderMessages();
  
  appData.activeCall.remove();
  appData.activeCall = null;
  
  // åœæ­¢è®¡æ—¶å™¨
  clearInterval(appData.callTimer);
  
  showNotification(`é€šè¯ç»“æŸï¼Œæ—¶é•¿: ${durationText}`);
  
  // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
  renderCommunicationStats();
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// ç»“æŸè§†é¢‘
function endVideo() {
  if (!appData.activeVideo) return;
  
  // è®¡ç®—é€šè¯æ—¶é•¿
  const endTime = new Date();
  const durationMs = endTime - appData.callStartTime;
  const durationSec = Math.floor(durationMs / 1000);
  const minutes = Math.floor(durationSec / 60);
  const seconds = durationSec % 60;
  const durationText = `${minutes}åˆ†${seconds}ç§’`;
  
  // æ›´æ–°æ€»è§†é¢‘æ—¶é—´
  appData.communicationSettings.totalVideoTime += minutes;
  
  // æ·»åŠ é€šè¯è®°å½•æ¶ˆæ¯
  const videoMessage = {
    id: Date.now(),
    type: 'video',
    title: 'è§†é¢‘é€šè¯',
    duration: durationText,
    sender: 'self',
    time: getCurrentTimeWithSeconds(),
    read: true
  };
  
  appData.messages.push(videoMessage);
  renderMessages();
  
  appData.activeVideo.remove();
  appData.activeVideo = null;
  
  // åœæ­¢è®¡æ—¶å™¨
  clearInterval(appData.callTimer);
  
  showNotification(`è§†é¢‘é€šè¯ç»“æŸï¼Œæ—¶é•¿: ${durationText}`);
  
  // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
  renderCommunicationStats();
  
  // ä¿å­˜æ•°æ®
  saveCompleteDataToLocalStorage();
}

// å¼€å§‹é€šè¯è®¡æ—¶å™¨
function startCallTimer() {
  clearInterval(appData.callTimer);
  
  let seconds = 0;
  appData.callTimer = setInterval(() => {
    seconds++;
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    const timerText = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    
    // æ›´æ–°ä¸¤ä¸ªçª—å£çš„è®¡æ—¶å™¨
    const callTimer = document.getElementById('callTimer');
    const videoTimer = document.getElementById('videoTimer');
    
    if (callTimer) callTimer.textContent = timerText;
    if (videoTimer) videoTimer.textContent = timerText;
  }, 1000);
}

// å¯¼å…¥äº‘æ•°æ®
function importCloudData() {
  const jsonText = cloudImportTextarea.value.trim();
  if (!jsonText) {
    showNotification('è¯·è¾“å…¥è¦å¯¼å…¥çš„JSONæ•°æ®');
    return;
  }
  
  try {
    const importedData = JSON.parse(jsonText);
    
    // éªŒè¯æ•°æ®æ ¼å¼
    if (!importedData.messages || !Array.isArray(importedData.messages)) {
      showNotification('æ•°æ®æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘æ¶ˆæ¯æ•°æ®');
      return;
    }
    
    // ç¡®è®¤å¯¼å…¥
    if (confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰èŠå¤©è®°å½•å’Œè®¾ç½®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
      // æ¢å¤æ•°æ®
      if (importedData.selfInfo) appData.selfInfo = importedData.selfInfo;
      if (importedData.otherInfo) appData.otherInfo = importedData.otherInfo;
      if (importedData.sendSettings) appData.sendSettings = importedData.sendSettings;
      if (importedData.appearanceSettings) appData.appearanceSettings = importedData.appearanceSettings;
      if (importedData.backgroundSettings) appData.backgroundSettings = importedData.backgroundSettings;
      if (importedData.tarotSettings) appData.tarotSettings = importedData.tarotSettings;
      if (importedData.communicationSettings) appData.communicationSettings = importedData.communicationSettings;
      if (importedData.responsePhrases) appData.responsePhrases = importedData.responsePhrases;
      if (importedData.messages) appData.messages = importedData.messages;
      if (importedData.stickers) appData.stickers = importedData.stickers;
      if (importedData.loveDays) appData.loveDays = importedData.loveDays;
      if (importedData.readNoReplyMessageIds) appData.readNoReplyMessageIds = importedData.readNoReplyMessageIds;
      
      // æ¢å¤æ—¥æœŸå¯¹è±¡
      if (importedData.appearanceSettings && importedData.appearanceSettings.loveStartDate) {
        appData.appearanceSettings.loveStartDate = new Date(importedData.appearanceSettings.loveStartDate);
      }
      
      // æ¢å¤Setå¯¹è±¡
      if (importedData.tarotSettings && importedData.tarotSettings.drawnCards && Array.isArray(importedData.tarotSettings.drawnCards)) {
        appData.tarotSettings.drawnCards = new Set(importedData.tarotSettings.drawnCards);
      } else {
        appData.tarotSettings.drawnCards = new Set();
      }
      
      // ç¡®ä¿å¤´åƒæ–‡æœ¬ä¸ºç©ºå­—ç¬¦ä¸²
      if (!appData.selfInfo.avatarText) {
        appData.selfInfo.avatarText = '';
      }
      if (!appData.otherInfo.avatarText) {
        appData.otherInfo.avatarText = '';
      }
      
      // ç¡®ä¿å¡”ç½—ç‰Œè®¾ç½®å®Œæ•´
      if (!appData.tarotSettings.defaultPhrases) {
        appData.tarotSettings.defaultPhrases = [];
      }
      if (!appData.tarotSettings.customPhrases) {
        appData.tarotSettings.customPhrases = [];
      }
      
      // åˆå¹¶å¡”ç½—ç‰Œå­—å¡
      mergeTarotPhrases();
      
      // ç¡®ä¿ä¸»åŠ¨å‘¼å«è®¾ç½®å­˜åœ¨ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
      if (!appData.communicationSettings.activeCallSettings) {
        appData.communicationSettings.activeCallSettings = {
          enabled: true,
          overallFrequency: 30,
          callPreference: 50,
          presetMode: 'custom',
          minInterval: 15,
          maxInterval: 45,
          respectBusyStatus: true,
          timeSensitivity: true,
          adaptToActivity: true
        };
      }
      
      // é‡æ–°æ¸²æŸ“æ‰€æœ‰UI
      renderAllUI();
      
      // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      saveCompleteDataToLocalStorage();
      
      showNotification('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
      cloudImportTextarea.value = '';
      
      // å…³é—­è®¾ç½®é¢æ¿
      closeSettingsPanel();
    }
    
  } catch (error) {
    console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
    showNotification('å¯¼å…¥å¤±è´¥ï¼šJSONæ ¼å¼é”™è¯¯');
  }
}

// æ¸…ç©ºäº‘å¯¼å…¥æ–‡æœ¬æ¡†
function clearCloudTextarea() {
  cloudImportTextarea.value = '';
  showNotification('å·²æ¸…ç©ºè¾“å…¥æ¡†');
}

// å¤„ç†äº‘æ–‡ä»¶ä¸Šä¼ 
function handleCloudFileUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  
  reader.onload = function(event) {
    cloudImportTextarea.value = event.target.result;
    showNotification('æ–‡ä»¶å·²åŠ è½½åˆ°è¾“å…¥æ¡†ï¼Œç‚¹å‡»å¯¼å…¥æŒ‰é’®å®Œæˆå¯¼å…¥');
  };
  
  reader.onerror = function() {
    showNotification('è¯»å–æ–‡ä»¶å¤±è´¥');
  };
  
  reader.readAsText(file);
  
  // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
  e.target.value = '';
}

// å¯¼å‡ºèŠå¤©è®°å½•
function exportChatHistory(format) {
  const includeMessages = exportMessages.checked;
  const includeSettings = exportSettings.checked;
  const includeStickers = exportStickers.checked;
  const includePhrases = exportPhrases.checked;
  const includeTarot = exportTarot.checked;
  const includeBackground = exportBackground.checked;
  const includeCommunication = exportCommunication.checked;
  
  let exportData = {};
  
  if (includeMessages) {
    exportData.messages = appData.messages;
  }
  
  if (includeSettings) {
    exportData.settings = {
      sendSettings: appData.sendSettings,
      appearanceSettings: appData.appearanceSettings,
      backgroundSettings: appData.backgroundSettings,
      tarotSettings: {
        enabled: appData.tarotSettings.enabled,
        drawCount: appData.tarotSettings.drawCount,
        defaultPhrases: appData.tarotSettings.defaultPhrases,
        customPhrases: appData.tarotSettings.customPhrases,
        phrases: appData.tarotSettings.phrases,
        drawnCards: Array.from(appData.tarotSettings.drawnCards)
      },
      communicationSettings: appData.communicationSettings
    };
  }
  
  if (includeStickers) {
    exportData.stickers = appData.stickers;
  }
  
  if (includePhrases) {
    exportData.phrases = appData.responsePhrases;
  }
  
  if (includeTarot) {
    exportData.tarotPhrases = appData.tarotSettings.phrases;
    exportData.tarotSettings = {
      enabled: appData.tarotSettings.enabled,
      drawCount: appData.tarotSettings.drawCount,
      defaultCount: appData.tarotSettings.defaultPhrases.length,
      customCount: appData.tarotSettings.customPhrases.length
    };
  }
  
  if (includeBackground) {
    exportData.background = {
      backgroundImage: appData.backgroundSettings.backgroundImage,
      backgroundType: appData.backgroundSettings.backgroundType,
      opacity: appData.backgroundSettings.opacity
    };
  }
  
  if (includeCommunication) {
    exportData.communicationStats = {
      todayCalls: appData.communicationSettings.todayCalls,
      todayVideos: appData.communicationSettings.todayVideos,
      totalCallTime: appData.communicationSettings.totalCallTime,
      totalVideoTime: appData.communicationSettings.totalVideoTime,
      todayIncomingCalls: appData.communicationSettings.todayIncomingCalls,
      activeCallSettings: appData.communicationSettings.activeCallSettings
    };
  }
  
  exportData.exportTime = new Date().toISOString();
  exportData.appName = appData.appearanceSettings.appTitle;
  exportData.userInfo = {
    self: appData.selfInfo.nickname,
    other: appData.otherInfo.nickname
  };
  
  let content = '';
  let filename = '';
  let mimeType = '';
  
  switch (format) {
    case 'txt':
      content = formatAsTxt(exportData);
      filename = `ä¸ƒAndæ„¿èŠå¤©è®°å½•_${getFormattedDate()}.txt`;
      mimeType = 'text/plain';
      break;
      
    case 'json':
      content = JSON.stringify(exportData, null, 2);
      filename = `ä¸ƒAndæ„¿èŠå¤©è®°å½•_${getFormattedDate()}.json`;
      mimeType = 'application/json';
      break;
      
    case 'html':
      content = formatAsHtml(exportData);
      filename = `ä¸ƒAndæ„¿èŠå¤©è®°å½•_${getFormattedDate()}.html`;
      mimeType = 'text/html';
      break;
  }
  
  downloadFile(content, filename, mimeType);
  showNotification(`èŠå¤©è®°å½•å·²å¯¼å‡ºä¸º${format.toUpperCase()}æ ¼å¼`);
}

// å¯¼å‡ºå…¨éƒ¨æ•°æ®
function exportAllData() {
  const exportData = {
    appData: {
      selfInfo: appData.selfInfo,
      otherInfo: appData.otherInfo,
      sendSettings: appData.sendSettings,
      appearanceSettings: appData.appearanceSettings,
      backgroundSettings: appData.backgroundSettings,
      tarotSettings: {
        enabled: appData.tarotSettings.enabled,
        drawCount: appData.tarotSettings.drawCount,
        defaultPhrases: appData.tarotSettings.defaultPhrases,
        customPhrases: appData.tarotSettings.customPhrases,
        phrases: appData.tarotSettings.phrases,
        drawnCards: Array.from(appData.tarotSettings.drawnCards)
      },
      communicationSettings: appData.communicationSettings,
      responsePhrases: appData.responsePhrases,
      messages: appData.messages,
      stickers: appData.stickers,
      loveDays: appData.loveDays,
      readNoReplyMessageIds: appData.readNoReplyMessageIds,
      todayDate: appData.todayDate
    },
    exportTime: new Date().toISOString(),
    exportVersion: '7.0'
  };
  
  const content = JSON.stringify(exportData, null, 2);
  const filename = `ä¸ƒAndæ„¿å®Œæ•´æ•°æ®å¤‡ä»½_${getFormattedDate()}.json`;
  
  downloadFile(content, filename, 'application/json');
  showNotification('å®Œæ•´æ•°æ®å¤‡ä»½å·²å¯¼å‡º');
}

// æ ¼å¼åŒ–ä¸ºTXT
function formatAsTxt(data) {
  let txt = `ä¸ƒAndæ„¿èŠå¤©è®°å½•å¯¼å‡º\n`;
  txt += `å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n`;
  txt += `ç”¨æˆ·: ${data.userInfo.self} ä¸ ${data.userInfo.other}\n`;
  txt += `========================================\n\n`;
  
  if (data.messages) {
    txt += `èŠå¤©è®°å½• (å…±${data.messages.length}æ¡):\n`;
    txt += `----------------------------------------\n`;
    
    data.messages.forEach((msg, index) => {
      const sender = msg.sender === 'self' ? data.userInfo.self : data.userInfo.other;
      const status = msg.read ? 'å·²è¯»' : 'æœªè¯»';
      const isReadNoReply = appData.readNoReplyMessageIds.includes(msg.id);
      const readNoReplyTag = isReadNoReply ? ' [å·²è¯»ä¸å›]' : '';
      const callTag = msg.type === 'call' ? ' [è¯­éŸ³é€šè¯]' : msg.type === 'video' ? ' [è§†é¢‘é€šè¯]' : '';
      const tarotTag = msg.isTarot ? ' [å¡”ç½—ç‰Œ]' : '';
      
      let content = msg.text || '[è¡¨æƒ…åŒ…]';
      if (msg.type === 'call' || msg.type === 'video') {
        content = `${msg.title || ''} ${msg.duration || ''}`;
      }
      
      txt += `${index + 1}. [${msg.time}] ${sender}: ${content} (${status}${readNoReplyTag}${callTag}${tarotTag})\n`;
    });
    
    txt += `\n`;
  }
  
  if (data.phrases) {
    txt += `å›å¤è¯æ¡ (å…±${data.phrases.length}æ¡):\n`;
    txt += `----------------------------------------\n`;
    data.phrases.forEach((phrase, index) => {
      txt += `${index + 1}. ${phrase}\n`;
    });
    txt += `\n`;
  }
  
  if (data.tarotPhrases) {
    txt += `å¡”ç½—ç‰Œå­—å¡ (å…±${data.tarotPhrases.length}å¼ ):\n`;
    txt += `----------------------------------------\n`;
    data.tarotPhrases.forEach((phrase, index) => {
      txt += `${index + 1}. ${phrase}\n`;
    });
    txt += `\n`;
  }
  
  if (data.settings && data.settings.tarotSettings) {
    const ts = data.settings.tarotSettings;
    txt += `å¡”ç½—ç‰Œè®¾ç½®:\n`;
    txt += `----------------------------------------\n`;
    txt += `å¡”ç½—ç‰Œæ¨¡å¼: ${ts.enabled ? 'å¼€å¯' : 'å…³é—­'}\n`;
    txt += `æ¯æ¬¡æŠ½å–æ•°é‡: ${ts.drawCount}å¼ \n`;
    txt += `é»˜è®¤å¡”ç½—ç‰Œ: ${ts.defaultPhrases ? ts.defaultPhrases.length : 0}å¼ \n`;
    txt += `è‡ªå®šä¹‰å¡”ç½—ç‰Œ: ${ts.customPhrases ? ts.customPhrases.length : 0}å¼ \n`;
    txt += `æ™ºèƒ½è§„åˆ™: åŒç‰Œæ­£é€†ä½ä¸é‡å¤æŠ½å–\n`;
    txt += `\n`;
  }
  
  if (data.settings) {
    txt += `å‘é€è®¾ç½®:\n`;
    txt += `----------------------------------------\n`;
    txt += `è¡¨æƒ…åŒ…æ¯”ä¾‹: ${data.settings.sendSettings.stickerRatio}%\n`;
    txt += `å­—å¡æ¯”ä¾‹: ${data.settings.sendSettings.phraseRatio}%\n`;
    txt += `æœ€å¤§å‘é€æ•°é‡: ${data.settings.sendSettings.maxMessageCount}æ¡\n`;
    txt += `ä¸»åŠ¨å‘é€é¢‘ç‡: ${formatAutoSendFrequency(data.settings.sendSettings.autoSendFrequency)}\n`;
    txt += `\n`;
  }
  
  if (data.communicationStats) {
    txt += `é€šè¯ç»Ÿè®¡:\n`;
    txt += `----------------------------------------\n`;
    txt += `ä»Šæ—¥é€šè¯: ${data.communicationStats.todayCalls} æ¬¡\n`;
    txt += `ä»Šæ—¥è§†é¢‘: ${data.communicationStats.todayVideos} æ¬¡\n`;
    txt += `æ€»é€šè¯æ—¶é•¿: ${data.communicationStats.totalCallTime} åˆ†é’Ÿ\n`;
    txt += `æ€»è§†é¢‘æ—¶é•¿: ${data.communicationStats.totalVideoTime} åˆ†é’Ÿ\n`;
    if (data.communicationStats.todayIncomingCalls !== undefined) {
      txt += `å¯¹æ–¹ä»Šæ—¥ä¸»åŠ¨å‘¼å«: ${data.communicationStats.todayIncomingCalls} æ¬¡\n`;
    }
    if (data.communicationStats.activeCallSettings) {
      txt += `ä¸»åŠ¨å‘¼å«è®¾ç½®: é¢‘ç‡${data.communicationStats.activeCallSettings.overallFrequency}%, ç”µè¯åå¥½${data.communicationStats.activeCallSettings.callPreference}%\n`;
    }
    txt += `\n`;
  }
  
  if (data.background) {
    txt += `èƒŒæ™¯è®¾ç½®:\n`;
    txt += `----------------------------------------\n`;
    txt += `èƒŒæ™¯ç±»å‹: ${data.background.backgroundType}\n`;
    txt += `èƒŒæ™¯é€æ˜åº¦: ${data.background.opacity}%\n`;
    txt += `\n`;
  }
  
  return txt;
}

// æ ¼å¼åŒ–ä¸ºHTML
function formatAsHtml(data) {
  let html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ä¸ƒAndæ„¿èŠå¤©è®°å½•</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
.header { background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
.messages { margin-bottom: 30px; }
.message { margin-bottom: 10px; padding: 10px; border-radius: 8px; }
.self { background: #e3f2fd; }
.other { background: #f5f5f5; }
.time { font-size: 0.8em; color: #666; }
.sender { font-weight: bold; }
.stats { background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
.call-message { background: rgba(0,0,0,0.1); border-left: 3px solid #000000; color: #000000; }
.video-message { background: rgba(0,0,0,0.1); border-left: 3px solid #000000; color: #000000; }
.tarot-message { background: #f3e5f5; border-left: 3px solid #7b1fa2; color: #7b1fa2; }
</style>
</head>
<body>
<div class="header">
<h1>ä¸ƒAndæ„¿èŠå¤©è®°å½•</h1>
<p>å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}</p>
<p>ç”¨æˆ·: ${data.userInfo.self} ä¸ ${data.userInfo.other}</p>
</div>`;
  
  if (data.messages) {
    html += `<div class="stats">å…± ${data.messages.length} æ¡æ¶ˆæ¯</div>
<div class="messages">`;
    
    data.messages.forEach(msg => {
      const sender = msg.sender === 'self' ? data.userInfo.self : data.userInfo.other;
      const status = msg.read ? 'å·²è¯»' : 'æœªè¯»';
      const isReadNoReply = appData.readNoReplyMessageIds.includes(msg.id);
      const readNoReplyTag = isReadNoReply ? ' <span style="color:#f44336;">[å·²è¯»ä¸å›]</span>' : '';
      const messageClass = msg.type === 'call' ? 'call-message' : msg.type === 'video' ? 'video-message' : msg.isTarot ? 'tarot-message' : msg.sender;
      
      let content = msg.text || '[è¡¨æƒ…åŒ…]';
      if (msg.type === 'call' || msg.type === 'video') {
        content = `<strong>${msg.title || ''}</strong> ${msg.duration || ''}`;
      }
      
      // æ·»åŠ å¡”ç½—ç‰Œå›¾æ ‡
      if (msg.isTarot) {
        content = `ğŸ”® ${content}`;
      }
      
      html += `<div class="message ${messageClass}">
<div class="sender">${sender} <span class="time">${msg.time} (${status}${readNoReplyTag})</span></div>
<div>${content}</div>
</div>`;
    });
    
    html += `</div>`;
  }
  
  if (data.phrases) {
    html += `<h2>å›å¤è¯æ¡ (${data.phrases.length}æ¡)</h2>
<ul>`;
    
    data.phrases.forEach(phrase => {
      html += `<li>${phrase}</li>`;
    });
    
    html += `</ul>`;
  }
  
  if (data.tarotPhrases) {
    html += `<h2>å¡”ç½—ç‰Œå­—å¡ (${data.tarotPhrases.length}å¼ ) ğŸ”®</h2>
<ul>`;
    
    data.tarotPhrases.forEach(phrase => {
      html += `<li>${phrase}</li>`;
    });
    
    html += `</ul>`;
  }
  
  if (data.settings && data.settings.tarotSettings) {
    const ts = data.settings.tarotSettings;
    html += `<h2>å¡”ç½—ç‰Œè®¾ç½®</h2>
<ul>
<li>å¡”ç½—ç‰Œæ¨¡å¼: ${ts.enabled ? 'å¼€å¯' : 'å…³é—­'}</li>
<li>æ¯æ¬¡æŠ½å–æ•°é‡: ${ts.drawCount}å¼ </li>
<li>é»˜è®¤å¡”ç½—ç‰Œ: ${ts.defaultPhrases ? ts.defaultPhrases.length : 0}å¼ </li>
<li>è‡ªå®šä¹‰å¡”ç½—ç‰Œ: ${ts.customPhrases ? ts.customPhrases.length : 0}å¼ </li>
<li>æ™ºèƒ½è§„åˆ™: åŒç‰Œæ­£é€†ä½ä¸é‡å¤æŠ½å–</li>
</ul>`;
  }
  
  if (data.settings) {
    html += `<h2>å‘é€è®¾ç½®</h2>
<ul>
<li>è¡¨æƒ…åŒ…æ¯”ä¾‹: ${data.settings.sendSettings.stickerRatio}%</li>
<li>å­—å¡æ¯”ä¾‹: ${data.settings.sendSettings.phraseRatio}%</li>
<li>æœ€å¤§å‘é€æ•°é‡: ${data.settings.sendSettings.maxMessageCount}æ¡</li>
<li>ä¸»åŠ¨å‘é€é¢‘ç‡: ${formatAutoSendFrequency(data.settings.sendSettings.autoSendFrequency)}</li>
</ul>`;
  }
  
  if (data.communicationStats) {
    html += `<h2>é€šè¯ç»Ÿè®¡</h2>
<ul>
<li>ä»Šæ—¥é€šè¯: ${data.communicationStats.todayCalls} æ¬¡</li>
<li>ä»Šæ—¥è§†é¢‘: ${data.communicationStats.todayVideos} æ¬¡</li>
<li>æ€»é€šè¯æ—¶é•¿: ${data.communicationStats.totalCallTime} åˆ†é’Ÿ</li>
<li>æ€»è§†é¢‘æ—¶é•¿: ${data.communicationStats.totalVideoTime} åˆ†é’Ÿ</li>`;
    
    if (data.communicationStats.todayIncomingCalls !== undefined) {
      html += `<li>å¯¹æ–¹ä»Šæ—¥ä¸»åŠ¨å‘¼å«: ${data.communicationStats.todayIncomingCalls} æ¬¡</li>`;
    }
    
    if (data.communicationStats.activeCallSettings) {
      html += `<li>ä¸»åŠ¨å‘¼å«è®¾ç½®: é¢‘ç‡${data.communicationStats.activeCallSettings.overallFrequency}%, ç”µè¯åå¥½${data.communicationStats.activeCallSettings.callPreference}%</li>`;
    }
    
    html += `</ul>`;
  }
  
  if (data.background) {
    html += `<h2>èƒŒæ™¯è®¾ç½®</h2>
<ul>
<li>èƒŒæ™¯ç±»å‹: ${data.background.backgroundType}</li>
<li>èƒŒæ™¯é€æ˜åº¦: ${data.background.opacity}%</li>
</ul>`;
  }
  
  html += `</body></html>`;
  return html;
}

// æ ¼å¼åŒ–ä¸»åŠ¨å‘é€é¢‘ç‡
function formatAutoSendFrequency(frequency) {
  if (frequency === 0) return 'ä¸ä¸»åŠ¨å‘é€';
  if (frequency < 60000) return `${Math.round(frequency/1000)}ç§’`;
  if (frequency < 3600000) return `${Math.round(frequency/60000)}åˆ†é’Ÿ`;
  return `${Math.round(frequency/3600000)}å°æ—¶`;
}

// è·å–æ ¼å¼åŒ–æ—¥æœŸ
function getFormattedDate() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  return `${year}${month}${day}_${hours}${minutes}`;
}

// ä¸‹è½½æ–‡ä»¶
function downloadFile(content, filename, mimeType) {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotification(message) {
  // ç§»é™¤ç°æœ‰é€šçŸ¥
  const existingNotification = document.querySelector('.notification');
  if (existingNotification) {
    existingNotification.remove();
  }
  
  // åˆ›å»ºæ–°é€šçŸ¥
  const notification = document.createElement('div');
  notification.className = 'notification';
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  // 3ç§’åè‡ªåŠ¨ç§»é™¤
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 3000);
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–åº”ç”¨
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>